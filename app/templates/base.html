<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{% block title %}PentaVision{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />
  </head>
  <body>
    <a href="#pv-main-content" class="pv-skip-link">Skip to main content</a>
    <div id="pv-splash" class="pv-splash-overlay">
      <div class="pv-splash-inner">
        <img
          src="{{ url_for('static', filename='img/pentavision.png') }}"
          alt="PentaVision"
          class="pv-splash-logo"
        />
        {% block splash_extra %}{% endblock %}
      </div>
    </div>

    <header class="pv-header" role="banner">
      <div class="pv-header-inner">
        <div class="pv-brand">PentaVision</div>
        <nav class="pv-nav" role="navigation" aria-label="Main navigation">
          <a href="{{ url_for('main.index') }}">Dashboard</a>

          {% if current_user %}
            {# Core features available to any signed-in user #}
            <a href="{{ url_for('main.recordings') }}">Recordings</a>
            <a href="{{ url_for('main.faces_demo') }}">Faces</a>

            {# Camera administration is allowed for System Administrators and Technicians #}
            {% if is_system_admin or is_technician %}
              <a href="{{ url_for('camera_admin.list_devices') }}">Cameras</a>
              <a href="{{ url_for('camera_admin.list_patterns') }}">Camera URLs</a>
            {% endif %}

            {# Admin and advanced configuration links for System Administrators only #}
            {% if is_system_admin %}
              <a href="{{ url_for('admin.index') }}">Admin</a>
              <a href="{{ url_for('main.storage_settings') }}">Storage</a>
              <a href="{{ url_for('main.audit_events') }}">Audit</a>
              <a href="{{ url_for('installer.install') }}">Installer</a>
            {% endif %}
          {% endif %}
        </nav>
        <div class="pv-user-menu">
          {% if current_user %}
            <span class="pv-user-label">{{ current_user.email }}</span>
            <a
              href="{{ url_for('main.profile') }}"
              class="pv-link-muted"
              style="margin-left: 0.5rem;"
            >
              Profile
            </a>
            <form
              method="post"
              action="{{ url_for('main.logout') }}"
              style="display: inline; margin-left: 0.5rem;"
            >
              <input
                type="hidden"
                name="csrf_token"
                value="{{ global_csrf_token }}"
              />
              <button type="submit" class="pv-button pv-button-small">
                Sign out
              </button>
            </form>
          {% else %}
            <a href="{{ url_for('main.login') }}">Sign in</a>
          {% endif %}
        </div>
      </div>
    </header>

    <main class="pv-main" id="pv-main-content" role="main">
      {% block content %}{% endblock %}
    </main>

    <div
      id="pv-floating-datetime"
      role="status"
      aria-live="polite"
      style="position: fixed; left: 16px; bottom: 16px; z-index: 9998; padding: 0.6rem 0.85rem; border-radius: 10px; font-weight: 700; box-shadow: 0 10px 30px rgba(0,0,0,0.35); background: #86efac; color: #111827; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"
    ></div>

    <div
      id="pv-global-toast"
      role="status"
      aria-live="polite"
      style="position: fixed; right: 16px; bottom: 16px; z-index: 9999; display: none; max-width: 520px; padding: 0.75rem 1rem; border-radius: 10px; font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.35); background: #86efac; color: #111827;"
    ></div>

    <script>
      (function () {
        var splash = document.getElementById('pv-splash');
        if (!splash) {
          return;
        }

        var hasSessionStorage = false;
        try {
          hasSessionStorage = typeof window.sessionStorage !== 'undefined';
        } catch (e) {
          hasSessionStorage = false;
        }

        var loginBox = document.getElementById('pv-login-box');
        var isLoginPage = !!loginBox;
        if (isLoginPage) {
          if (hasSessionStorage) {
            try {
              window.sessionStorage.setItem('pvSplashSeen', '1');
            } catch (e) {}
          }

          var stage = loginBox.getAttribute('data-stage') || 'primary';
          var showDelay = stage === 'totp' ? 400 : 5000;

          setTimeout(function () {
            if (loginBox) {
              loginBox.classList.remove('pv-login-box-hidden');
            }
          }, showDelay);

          function attachFadeOnSubmit(formId) {
            var form = document.getElementById(formId);
            if (!form || !loginBox) return;
            form.addEventListener('submit', function (ev) {
              if (loginBox.classList.contains('pv-login-box-submitting')) {
                return;
              }
              loginBox.classList.add('pv-login-box-submitting');
              loginBox.classList.add('pv-login-box-hidden');
              ev.preventDefault();
              setTimeout(function () {
                form.submit();
              }, 350);
            });
          }

          attachFadeOnSubmit('pv-login-form-primary');
          attachFadeOnSubmit('pv-login-form-totp');

          return;
        }

        function hideSoon() {
          setTimeout(function () {
            splash.classList.add('pv-splash-hide');
          }, 5000);
        }

        // If PerformanceNavigationTiming is available, detect reload vs navigate.
        var navType = 'navigate';
        try {
          if (window.performance && performance.getEntriesByType) {
            var entries = performance.getEntriesByType('navigation');
            if (entries && entries.length > 0 && entries[0].type) {
              navType = entries[0].type;
            }
          }
        } catch (e) {
          navType = 'navigate';
        }

        // Always show splash on explicit reloads.
        if (navType === 'reload') {
          hideSoon();
          return;
        }

        if (!hasSessionStorage) {
          // Fallback: show on every navigation if we cannot track state.
          hideSoon();
          return;
        }

        var seen = window.sessionStorage.getItem('pvSplashSeen') === '1';
        if (seen) {
          // Already shown once in this tab: hide immediately for internal navigations.
          splash.classList.add('pv-splash-hide');
          return;
        }

        // First visit in this tab: record and show splash once.
        window.sessionStorage.setItem('pvSplashSeen', '1');
        hideSoon();
      })();
    </script>

    <script>
      (function () {
        var toastEl = document.getElementById('pv-global-toast');
        if (!toastEl) return;

        function showToast(message) {
          toastEl.textContent = String(message || '');
          toastEl.style.display = 'block';
          window.clearTimeout(showToast._t);
          showToast._t = window.setTimeout(function () {
            toastEl.style.display = 'none';
          }, 10000);
        }

        var queue = [];
        try {
          {% set _pv_flash = get_flashed_messages(with_categories=true) %}
          {% set _pv_errors = (errors if errors is defined else []) %}
          queue = (
            {{ _pv_flash|tojson }}
              .map(function (pair) {
                try {
                  return String((pair && pair.length > 1 ? pair[1] : pair) || '');
                } catch (e) {
                  return '';
                }
              })
              .filter(function (m) { return !!m; })
          ).concat(
            {{ _pv_errors|tojson }}
              .map(function (m) { return String(m || ''); })
              .filter(function (m) { return !!m; })
          );
        } catch (e) {
          queue = [];
        }

        if (!queue || !queue.length) return;

        function drain(i) {
          if (!queue || i >= queue.length) return;
          showToast(queue[i]);
          window.setTimeout(function () {
            drain(i + 1);
          }, 10500);
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', function () {
            drain(0);
          });
        } else {
          drain(0);
        }
      })();
    </script>

    <script>
      (function () {
        var el = document.getElementById('pv-floating-datetime');
        if (!el) return;

        function pad(n) {
          return String(n).padStart(2, '0');
        }

        function tick() {
          var d = new Date();
          var yyyy = d.getFullYear();
          var mm = pad(d.getMonth() + 1);
          var dd = pad(d.getDate());
          var hh = pad(d.getHours());
          var mi = pad(d.getMinutes());
          var ss = pad(d.getSeconds());
          el.textContent = yyyy + '-' + mm + '-' + dd + ' ' + hh + ':' + mi + ':' + ss;
        }

        tick();
        window.setInterval(tick, 1000);
      })();
    </script>
  </body>
</html>
