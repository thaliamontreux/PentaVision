<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{% block title %}PentaVision{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    {% set _pv_path = request.path if request else '' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />
    {% if active_main_theme and active_main_theme != 'default' %}
      <link rel="stylesheet" href="{{ url_for('main.theme_css', scope='main', slug=active_main_theme) }}" />
    {% endif %}
    {% if _pv_path.startswith('/admin') and active_admin_theme and active_admin_theme != 'default' %}
      <link rel="stylesheet" href="{{ url_for('main.theme_css', scope='admin', slug=active_admin_theme) }}" />
    {% endif %}
    <style>
      .pv-toast {
        position: fixed;
        right: 16px;
        bottom: 16px;
        z-index: 9999;
        display: none;
        max-width: min(520px, calc(100vw - 32px));
        padding: 0.85rem 1rem;
        border-radius: 16px;
        font-weight: 800;
        box-shadow:
          0 24px 55px rgba(0,0,0,0.48),
          0 10px 18px rgba(0,0,0,0.30),
          inset 0 1px 0 rgba(255,255,255,0.75),
          inset 0 -1px 0 rgba(0,0,0,0.10);
        background: linear-gradient(180deg, rgba(59,130,246,0.98), rgba(37,99,235,0.94));
        color: rgba(255,255,255,0.96);
        border: 1px solid rgba(17,24,39,0.18);
        backdrop-filter: blur(10px);
        transform: translateY(14px) scale(0.985);
        opacity: 0;
        transition: opacity 180ms ease, transform 220ms cubic-bezier(0.16, 1, 0.3, 1);
      }
      .pv-toast.is-error {
        background: linear-gradient(180deg, rgba(248,113,113,0.98), rgba(239,68,68,0.94));
        color: rgba(17,24,39,0.98);
      }
      .pv-toast.is-success {
        background: linear-gradient(180deg, rgba(134,239,172,0.98), rgba(74,222,128,0.94));
        color: rgba(17,24,39,0.98);
      }
      .pv-toast.is-showing {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
      .pv-toast .pv-toast-title {
        font-size: 0.9rem;
        letter-spacing: 0.3px;
      }
      .pv-toast .pv-toast-msg {
        font-size: 0.92rem;
        font-weight: 700;
        margin-top: 0.35rem;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body class="{% if _pv_path.startswith('/admin') %}pv-is-admin{% endif %}" {% block body_attrs %}{% endblock %}>
    <a href="#pv-main-content" class="pv-skip-link">Skip to main content</a>
    <div id="pv-splash" class="pv-splash-overlay">
      <div class="pv-splash-inner">
        <img
          src="{{ url_for('static', filename='img/pentavision.png') }}"
          alt="PentaVision"
          class="pv-splash-logo"
        />
        {% block splash_extra %}{% endblock %}
      </div>
    </div>

    <header class="pv-header" role="banner">
      <div class="pv-header-inner">
        <div class="pv-brand">PentaVision</div>
        <nav class="pv-nav" role="navigation" aria-label="Main navigation">
          {% if current_user %}
            {% set is_admin_area = request.path.startswith('/admin') %}
            {% if is_admin_area %}
              {% set nav_overview = has_permission('Nav.Overview.View') %}
              {% set nav_users = has_permission('Nav.IAM.Users.View') %}
              {% set nav_properties = has_permission('Nav.Cust.Properties.View') %}
              {% set nav_feeds_cameras = has_permission('Nav.Feeds.Cameras.View') %}
              {% set nav_feeds_templates = has_permission('Nav.Feeds.CameraUrlTemplates.View') %}
              {% set nav_feeds_rtmp = has_permission('Nav.Feeds.RtmpOutputs.View') %}
              {% set nav_recordings = has_permission('Nav.Recording.Recordings.View') %}
              {% set nav_recording_schedule = has_permission('Nav.Recording.Schedule.View') %}
              {% set nav_storage_providers = has_permission('Nav.Storage.Providers.View') %}
              {% set nav_themes = has_permission('Nav.Themes.View') %}
              {% set nav_netsec_block_allow = has_permission('Nav.NetSec.BlockAllow.View') %}
              {% set nav_netsec_dist = has_permission('Nav.NetSec.BlocklistDistribution.View') %}
              {% set nav_netsec_integ = has_permission('Nav.NetSec.BlocklistIntegration.View') %}
              {% set nav_audit_log = has_permission('Nav.Audit.AuditLog.View') %}
              {% set nav_audit_blocklist = has_permission('Nav.Audit.BlocklistAudit.View') %}
              {% set nav_audit_login_failures = has_permission('Nav.Audit.LoginFailures.View') %}
              {% set nav_services = has_permission('Nav.Services.View') %}
              {% set nav_installer = has_permission('Nav.Installer.Databases.View') %}

              {% set show_feeds = nav_feeds_cameras or nav_feeds_templates or nav_feeds_rtmp %}
              {% set show_recording_storage = nav_recordings or nav_recording_schedule or nav_storage_providers %}
              {% set show_netsec = nav_netsec_block_allow or nav_netsec_dist or nav_netsec_integ %}
              {% set show_audit = nav_audit_log or nav_audit_blocklist or nav_audit_login_failures %}

              {% if nav_overview %}
                <div class="pv-nav-dropdown" data-pv-dropdown>
                  <button class="pv-nav-trigger" type="button" aria-haspopup="true" aria-expanded="false">Overview</button>
                  <div class="pv-nav-panel" role="menu">
                    <div class="pv-nav-section">
                      <a href="{{ url_for('main.index') }}" role="menuitem">Dashboard</a>
                      {% if has_permission('Video.Live.View') or has_permission('Video.*') %}
                        <a href="{{ url_for('main.live_feeds') }}" role="menuitem">Live Feeds</a>
                      {% endif %}
                      <a href="{{ url_for('admin.index') }}" role="menuitem">Admin Overview</a>
                    </div>
                  </div>
                </div>
              {% endif %}

              {% if nav_users %}
                <div class="pv-nav-dropdown" data-pv-dropdown>
                  <button class="pv-nav-trigger" type="button" aria-haspopup="true" aria-expanded="false">Users</button>
                  <div class="pv-nav-panel" role="menu">
                    <div class="pv-nav-section">
                      <a href="{{ url_for('admin.users_list') }}" role="menuitem">Users</a>
                    </div>
                  </div>
                </div>
              {% endif %}

              {% if nav_properties %}
                <div class="pv-nav-dropdown" data-pv-dropdown>
                  <button class="pv-nav-trigger" type="button" aria-haspopup="true" aria-expanded="false">Properties</button>
                  <div class="pv-nav-panel" role="menu">
                    <div class="pv-nav-section">
                      <a href="{{ url_for('admin.properties_list') }}" role="menuitem">Properties</a>
                    </div>
                  </div>
                </div>
              {% endif %}

              {% if show_feeds %}
                <div class="pv-nav-dropdown" data-pv-dropdown>
                  <button class="pv-nav-trigger" type="button" aria-haspopup="true" aria-expanded="false">Video Streaming</button>
                  <div class="pv-nav-panel" role="menu">
                    <div class="pv-nav-section">
                      {% if nav_feeds_cameras %}
                        <a href="{{ url_for('camera_admin.list_devices') }}" role="menuitem">Cameras</a>
                      {% endif %}
                      {% if nav_feeds_templates %}
                        <a href="{{ url_for('camera_admin.list_patterns') }}" role="menuitem">Camera URL Templates</a>
                      {% endif %}
                      {% if nav_feeds_rtmp %}
                        <a href="{{ url_for('camera_admin.rtmp_list') }}" role="menuitem">RTMP Outputs</a>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endif %}

              {% if show_recording_storage %}
                <div class="pv-nav-dropdown" data-pv-dropdown>
                  <button class="pv-nav-trigger" type="button" aria-haspopup="true" aria-expanded="false">Recording &amp; Storage</button>
                  <div class="pv-nav-panel" role="menu">
                    <div class="pv-nav-section">
                      {% if nav_recordings %}
                        <a href="{{ url_for('main.recordings') }}" role="menuitem">Recordings</a>
                      {% endif %}
                      {% if nav_recording_schedule %}
                        <a href="{{ url_for('main.recording_settings') }}" role="menuitem">Recording Schedule</a>
                      {% endif %}
                      {% if nav_storage_providers %}
                        <a href="{{ url_for('admin.storage_settings') }}" role="menuitem">Storage Providers</a>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endif %}

              {% if nav_themes %}
                <div class="pv-nav-dropdown" data-pv-dropdown>
                  <button class="pv-nav-trigger" type="button" aria-haspopup="true" aria-expanded="false">Themes</button>
                  <div class="pv-nav-panel" role="menu">
                    <div class="pv-nav-section">
                      <a href="{{ url_for('admin.themes') }}" role="menuitem">Themes</a>
                    </div>
                  </div>
                </div>
              {% endif %}

              {% if show_netsec %}
                <div class="pv-nav-dropdown" data-pv-dropdown>
                  <button class="pv-nav-trigger" type="button" aria-haspopup="true" aria-expanded="false">Network Security</button>
                  <div class="pv-nav-panel" role="menu">
                    <div class="pv-nav-section">
                      {% if nav_netsec_block_allow %}
                        <a href="{{ url_for('admin.access_control') }}" role="menuitem">Block / Allow</a>
                      {% endif %}
                      {% if nav_netsec_dist %}
                        <a href="{{ url_for('admin.blocklist_distribution') }}" role="menuitem">Blocklist Distribution</a>
                      {% endif %}
                      {% if nav_netsec_integ %}
                        <a href="{{ url_for('admin.blocklist_integration') }}" role="menuitem">Blocklist Integration</a>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endif %}

              {% if show_audit %}
                <div class="pv-nav-dropdown" data-pv-dropdown>
                  <button class="pv-nav-trigger" type="button" aria-haspopup="true" aria-expanded="false">Audit &amp; Security Events</button>
                  <div class="pv-nav-panel" role="menu">
                    <div class="pv-nav-section">
                      {% if nav_audit_log %}
                        <a href="{{ url_for('main.audit_events') }}" role="menuitem">Audit Log</a>
                      {% endif %}
                      {% if nav_audit_blocklist %}
                        <a href="{{ url_for('admin.blocklist_audit') }}" role="menuitem">Blocklist Audit</a>
                      {% endif %}
                      {% if nav_audit_login_failures %}
                        <a href="{{ url_for('admin.login_failures_list') }}" role="menuitem">Login Failures</a>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endif %}

              {% if nav_services %}
                <div class="pv-nav-dropdown" data-pv-dropdown>
                  <button class="pv-nav-trigger" type="button" aria-haspopup="true" aria-expanded="false">Services</button>
                  <div class="pv-nav-panel" role="menu">
                    <div class="pv-nav-section">
                      <a href="{{ url_for('admin.services') }}" role="menuitem">Services</a>
                    </div>
                  </div>
                </div>
              {% endif %}

              {% if nav_installer %}
                <div class="pv-nav-dropdown" data-pv-dropdown>
                  <button class="pv-nav-trigger" type="button" aria-haspopup="true" aria-expanded="false">Installer &amp; Databases</button>
                  <div class="pv-nav-panel" role="menu">
                    <div class="pv-nav-section">
                      <a href="{{ url_for('installer.install') }}" role="menuitem">Installer &amp; Databases</a>
                    </div>
                  </div>
                </div>
              {% endif %}
            {% else %}
              {% if has_permission('Nav.Overview.View') %}
                <a href="{{ url_for('main.index') }}" class="pv-nav-trigger">Overview</a>
              {% endif %}
              {% if has_permission('Video.Live.View') or has_permission('Video.*') %}
                <a href="{{ url_for('main.live_feeds') }}" class="pv-nav-trigger">Live Feeds</a>
              {% endif %}
              {% if has_permission('Nav.Overview.View') %}
                <a href="{{ url_for('admin.index') }}" class="pv-nav-trigger">Admin</a>
              {% endif %}
            {% endif %}
          {% else %}
            <a href="{{ url_for('main.index') }}">Overview</a>
          {% endif %}
        </nav>
        <div class="pv-user-menu">
          {% if current_user %}
            <span class="pv-user-label">{{ current_user.email }}</span>
            <a
              href="{{ url_for('main.profile') }}"
              class="pv-link-muted"
              style="margin-left: 0.5rem;"
            >
              Profile
            </a>
            <form
              method="post"
              action="{{ url_for('main.logout') }}"
              style="display: inline; margin-left: 0.5rem;"
            >
              <input
                type="hidden"
                name="csrf_token"
                value="{{ global_csrf_token }}"
              />
              <button type="submit" class="pv-button pv-button-small">
                Sign out
              </button>
            </form>
          {% else %}
            <a href="{{ url_for('main.login') }}">Sign in</a>
          {% endif %}
        </div>
      </div>

      {% if active_admin_property and has_permission('Nav.Cust.Properties.View') %}
        <div class="pv-active-property-bar">
          <div class="pv-active-property-left">
            <span class="pv-active-property-label">Active property:</span>
            <span class="pv-active-property-label">{{ active_admin_property.name }}</span>
            <span class="pv-active-property-meta">(ID {{ active_admin_property.id }})</span>
            <span class="pv-active-property-sep">|</span>
            {% if is_system_admin %}
              <a href="{{ url_for('admin.property_workspace', property_id=active_admin_property.id) }}" class="pv-link-muted">
                Workspace
              </a>
            {% endif %}
            <a href="{{ url_for('pm.property_users', property_id=active_admin_property.id) }}" class="pv-link-muted">
              Property users
            </a>
            {% if is_system_admin %}
              <a href="{{ url_for('admin.properties_list') }}" class="pv-link-muted">
                Switch
              </a>
            {% else %}
              <a href="{{ url_for('pm.index') }}" class="pv-link-muted">
                Switch
              </a>
            {% endif %}
          </div>
          {% if is_system_admin %}
            <form method="post" action="{{ url_for('admin.property_context_clear') }}" style="margin: 0;">
              <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />
              <button type="submit" class="pv-button pv-button-small">
                Exit
              </button>
            </form>
          {% else %}
            <form method="post" action="{{ url_for('pm.pm_property_context_clear') }}" style="margin: 0;">
              <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />
              <button type="submit" class="pv-button pv-button-small">
                Exit
              </button>
            </form>
          {% endif %}
        </div>
      {% endif %}
    </header>

    <main class="pv-main" id="pv-main-content" role="main">
      {% block content %}{% endblock %}
    </main>

    <div
      id="pv-status-bar"
      role="status"
      aria-live="polite"
      style="position: fixed; left: 0; right: 0; bottom: 0; z-index: 9998; display: flex; gap: 0.75rem; align-items: center; padding: 0.55rem 0.9rem; box-shadow: 0 -10px 30px rgba(0,0,0,0.55); background: linear-gradient(90deg, rgba(15,23,42,0.98), rgba(2,6,23,0.96)); color: #e5e7eb; font-weight: 700; font-size: 0.92rem; border-top: 1px solid rgba(56,189,248,0.22); backdrop-filter: blur(10px);"
    >
      <span id="pv-status-datetime" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"></span>
      <span style="opacity: 0.55;">|</span>
      <span style="white-space: nowrap; color: rgba(229,231,235,0.78);">System:</span>
      <span id="pv-status-system" style="white-space: nowrap;"></span>
      <span style="opacity: 0.55;">|</span>
      <span style="white-space: nowrap; color: rgba(229,231,235,0.78);">Last error:</span>
      <span id="pv-status-last-error" style="font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></span>
    </div>

    <div
      id="pv-global-toast"
      role="status"
      aria-live="polite"
      class="pv-toast"
    ></div>

    <script>
      (function () {
        var splash = document.getElementById('pv-splash');
        if (!splash) {
          return;
        }

        var hasSessionStorage = false;
        try {
          hasSessionStorage = typeof window.sessionStorage !== 'undefined';
        } catch (e) {
          hasSessionStorage = false;
        }

        var loginBox = document.getElementById('pv-login-box');
        var isLoginPage = !!loginBox;
        if (isLoginPage) {
          if (hasSessionStorage) {
            try {
              window.sessionStorage.setItem('pvSplashSeen', '1');
            } catch (e) {}
          }

          var stage = loginBox.getAttribute('data-stage') || 'primary';
          var showDelay = stage === 'totp' ? 400 : 5000;

          setTimeout(function () {
            if (loginBox) {
              loginBox.classList.remove('pv-login-box-hidden');
            }
          }, showDelay);

          function attachFadeOnSubmit(formId) {
            var form = document.getElementById(formId);
            if (!form || !loginBox) return;
            form.addEventListener('submit', function (ev) {
              if (loginBox.classList.contains('pv-login-box-submitting')) {
                return;
              }
              loginBox.classList.add('pv-login-box-submitting');
              loginBox.classList.add('pv-login-box-hidden');
              ev.preventDefault();
              setTimeout(function () {
                form.submit();
              }, 350);
            });
          }

          attachFadeOnSubmit('pv-login-form-primary');
          attachFadeOnSubmit('pv-login-form-totp');

          return;
        }

        function hideSoon() {
          setTimeout(function () {
            splash.classList.add('pv-splash-hide');
          }, 5000);
        }

        // If PerformanceNavigationTiming is available, detect reload vs navigate.
        var navType = 'navigate';
        try {
          if (window.performance && performance.getEntriesByType) {
            var entries = performance.getEntriesByType('navigation');
            if (entries && entries.length > 0 && entries[0].type) {
              navType = entries[0].type;
            }
          }
        } catch (e) {
          navType = 'navigate';
        }

        // Skip splash on pages that opt out (e.g., admin plugin management)
        if (document.body.hasAttribute('data-skip-splash')) {
          splash.classList.add('pv-splash-hide');
          return;
        }

        // Always show splash on explicit reloads (unless opted out).
        if (navType === 'reload') {
          hideSoon();
          return;
        }

        if (!hasSessionStorage) {
          // Fallback: show on every navigation if we cannot track state.
          hideSoon();
          return;
        }

        var seen = window.sessionStorage.getItem('pvSplashSeen') === '1';
        if (seen) {
          // Already shown once in this tab: hide immediately for internal navigations.
          splash.classList.add('pv-splash-hide');
          return;
        }

        // First visit in this tab: record and show splash once.
        window.sessionStorage.setItem('pvSplashSeen', '1');
        hideSoon();
      })();
    </script>

    <script>
      (function () {
        var toastEl = document.getElementById('pv-global-toast');
        if (!toastEl) return;

        var statusLastErrorEl = document.getElementById('pv-status-last-error');
        function setLastError(message) {
          if (!statusLastErrorEl) return;
          statusLastErrorEl.textContent = String(message || '');
          try {
            window.sessionStorage.setItem('pvLastError', String(message || ''));
          } catch (e) {}
        }

        try {
          var storedLast = window.sessionStorage.getItem('pvLastError') || '';
          if (storedLast && statusLastErrorEl) {
            statusLastErrorEl.textContent = storedLast;
          }
        } catch (e) {}

        function showToast(message, kind) {
          var title = kind === 'success' ? 'SUCCESS' : (kind === 'error' ? 'ERROR' : 'NOTICE');
          var msg = String(message || '');

          toastEl.classList.remove('is-error');
          toastEl.classList.remove('is-success');
          if (kind === 'error') {
            toastEl.classList.add('is-error');
          } else if (kind === 'success') {
            toastEl.classList.add('is-success');
          }

          toastEl.innerHTML = '';
          var titleEl = document.createElement('div');
          titleEl.className = 'pv-toast-title';
          titleEl.textContent = title;
          var msgEl = document.createElement('div');
          msgEl.className = 'pv-toast-msg';
          msgEl.textContent = msg;
          toastEl.appendChild(titleEl);
          toastEl.appendChild(msgEl);

          toastEl.style.display = 'block';
          void toastEl.offsetWidth;
          toastEl.classList.add('is-showing');
          if (kind === 'error') {
            setLastError(msg);
          }

          window.clearTimeout(showToast._t);
          showToast._t = window.setTimeout(function () {
            toastEl.classList.remove('is-showing');
            window.clearTimeout(showToast._h);
            showToast._h = window.setTimeout(function () {
              toastEl.style.display = 'none';
            }, 240);
          }, 10000);
        }

        window.pvToastError = function (message) { showToast(message, 'error'); };
        window.pvToastSuccess = function (message) { showToast(message, 'success'); };
        window.pvToast = function (message) { showToast(message, 'notice'); };

        var queue = [];
        try {
          {% set _pv_flash = get_flashed_messages(with_categories=true) %}
          {% set _pv_errors = (errors if errors is defined else []) %}
          queue = (
            {{ _pv_flash|tojson }}
              .map(function (pair) {
                try {
                  var cat = (pair && pair.length > 1 ? pair[0] : 'notice') || 'notice';
                  var msg = String((pair && pair.length > 1 ? pair[1] : pair) || '');
                  if (!msg) return null;
                  var kind = (cat === 'success' || cat === 'error' || cat === 'notice') ? cat : 'notice';
                  return { kind: kind, msg: msg };
                } catch (e) {
                  return null;
                }
              })
              .filter(function (item) { return !!item; })
          ).concat(
            {{ _pv_errors|tojson }}
              .map(function (m) {
                var msg = String(m || '');
                return msg ? { kind: 'error', msg: msg } : null;
              })
              .filter(function (item) { return !!item; })
          );
        } catch (e) {
          queue = [];
        }

        if (!queue || !queue.length) return;

        function drain(i) {
          if (!queue || i >= queue.length) return;
          showToast(queue[i].msg, queue[i].kind);
          window.setTimeout(function () {
            drain(i + 1);
          }, 10500);
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', function () {
            drain(0);
          });
        } else {
          drain(0);
        }
      })();
    </script>

    <script>
      (function () {
        var el = document.getElementById('pv-status-datetime');
        if (!el) return;

        function pad(n) {
          return String(n).padStart(2, '0');
        }

        function tick() {
          var d = new Date();
          var mm = pad(d.getMonth() + 1);
          var dd = pad(d.getDate());
          var yy = pad(d.getFullYear() % 100);
          var hh = pad(d.getHours());
          var mi = pad(d.getMinutes());
          el.textContent = mm + '/' + dd + '/' + yy + ' ' + hh + ':' + mi;
        }

        tick();
        window.setInterval(tick, 1000);
      })();
    </script>

    <script>
      (function () {
        var statusEl = document.getElementById('pv-status-system');
        if (!statusEl) return;

        function applyStatus(data) {
          var overall = (data && (data.overall_status || data.status)) ? String(data.overall_status || data.status) : 'unknown';
          statusEl.textContent = overall;
        }

        function tick() {
          try {
            fetch('{{ url_for('main.api_status') }}', { credentials: 'same-origin' })
              .then(function (r) {
                if (!r.ok) throw new Error('status ' + r.status);
                return r.json();
              })
              .then(function (data) {
                applyStatus(data);
              })
              .catch(function () {
                statusEl.textContent = 'unknown';
              });
          } catch (e) {
            statusEl.textContent = 'unknown';
          }
        }

        tick();
        window.setInterval(tick, 5000);
      })();
    </script>

    <script>
      (function () {
        var dropdowns = document.querySelectorAll('[data-pv-dropdown]');
        if (!dropdowns || !dropdowns.length) return;

        function setOpen(el, isOpen) {
          if (!el) return;
          if (isOpen) {
            el.classList.add('is-open');
          } else {
            el.classList.remove('is-open');
          }

          var btn = el.querySelector('.pv-nav-trigger');
          if (btn) {
            btn.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
          }
        }

        function initDropdown(el) {
          var t = null;
          function openNow() {
            if (t) {
              window.clearTimeout(t);
              t = null;
            }
            setOpen(el, true);
          }

          function closeSoon() {
            if (t) {
              window.clearTimeout(t);
              t = null;
            }
            t = window.setTimeout(function () {
              setOpen(el, false);
            }, 200);
          }

          el.addEventListener('mouseenter', openNow);
          el.addEventListener('mouseleave', closeSoon);

          el.addEventListener('keydown', function (ev) {
            if (!ev) return;
            if (ev.key === 'Escape') {
              try { ev.preventDefault(); } catch (e) {}
              setOpen(el, false);
            }
          });
        }

        for (var i = 0; i < dropdowns.length; i++) {
          initDropdown(dropdowns[i]);
        }
      })();
    </script>
  </body>
</html>
