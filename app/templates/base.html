<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{% block title %}PentaVision{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    {% set _pv_path = request.path if request else '' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />
    {% if active_main_theme and active_main_theme != 'default' %}
      <link rel="stylesheet" href="{{ url_for('main.theme_css', scope='main', slug=active_main_theme) }}" />
    {% endif %}
    {% if _pv_path.startswith('/admin') and active_admin_theme and active_admin_theme != 'default' %}
      <link rel="stylesheet" href="{{ url_for('main.theme_css', scope='admin', slug=active_admin_theme) }}" />
    {% endif %}
    <style>
      .pv-toast {
        position: fixed;
        right: 16px;
        bottom: 16px;
        z-index: 9999;
        display: none;
        max-width: min(520px, calc(100vw - 32px));
        padding: 0.85rem 1rem;
        border-radius: 16px;
        font-weight: 800;
        box-shadow:
          0 24px 55px rgba(0,0,0,0.48),
          0 10px 18px rgba(0,0,0,0.30),
          inset 0 1px 0 rgba(255,255,255,0.75),
          inset 0 -1px 0 rgba(0,0,0,0.10);
        background: linear-gradient(180deg, rgba(134,239,172,0.98), rgba(74,222,128,0.94));
        color: #111827;
        border: 1px solid rgba(17,24,39,0.18);
        backdrop-filter: blur(10px);
        transform: translateY(14px) scale(0.985);
        opacity: 0;
        transition: opacity 180ms ease, transform 220ms cubic-bezier(0.16, 1, 0.3, 1);
      }
      .pv-toast.is-showing {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
      .pv-toast .pv-toast-title {
        font-size: 0.9rem;
        letter-spacing: 0.3px;
      }
      .pv-toast .pv-toast-msg {
        font-size: 0.92rem;
        font-weight: 700;
        margin-top: 0.35rem;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body class="{% if _pv_path.startswith('/admin') %}pv-is-admin{% endif %}">
    <a href="#pv-main-content" class="pv-skip-link">Skip to main content</a>
    <div id="pv-splash" class="pv-splash-overlay">
      <div class="pv-splash-inner">
        <img
          src="{{ url_for('static', filename='img/pentavision.png') }}"
          alt="PentaVision"
          class="pv-splash-logo"
        />
        {% block splash_extra %}{% endblock %}
      </div>
    </div>

    <header class="pv-header" role="banner">
      <div class="pv-header-inner">
        <div class="pv-brand">PentaVision</div>
        <nav class="pv-nav" role="navigation" aria-label="Main navigation">
          <a href="{{ url_for('main.index') }}">Dashboard</a>

          {% if current_user %}
            {# Core features available to any signed-in user #}
            <a href="{{ url_for('main.recordings') }}">Recordings</a>
            <a href="{{ url_for('main.faces_demo') }}">Faces</a>

            {% if is_property_manager %}
              <a href="{{ url_for('pm.index') }}">Properties</a>
            {% endif %}

            {# Camera administration is allowed for System Administrators and Technicians #}
            {% if is_system_admin or is_technician %}
              <a href="{{ url_for('camera_admin.list_devices') }}">Cameras</a>
            {% endif %}

            {# Admin and advanced configuration links for System Administrators only #}
            {% if is_system_admin %}
              <a href="{{ url_for('admin.index') }}">Admin</a>
              <a href="{{ url_for('installer.install') }}">Installer</a>
            {% endif %}
          {% endif %}
        </nav>
        <div class="pv-user-menu">
          {% if current_user %}
            <span class="pv-user-label">{{ current_user.email }}</span>
            <a
              href="{{ url_for('main.profile') }}"
              class="pv-link-muted"
              style="margin-left: 0.5rem;"
            >
              Profile
            </a>
            <form
              method="post"
              action="{{ url_for('main.logout') }}"
              style="display: inline; margin-left: 0.5rem;"
            >
              <input
                type="hidden"
                name="csrf_token"
                value="{{ global_csrf_token }}"
              />
              <button type="submit" class="pv-button pv-button-small">
                Sign out
              </button>
            </form>
          {% else %}
            <a href="{{ url_for('main.login') }}">Sign in</a>
          {% endif %}
        </div>
      </div>

      {% if is_system_admin and active_admin_property %}
        <div
          style="display: flex; gap: 0.75rem; align-items: center; justify-content: space-between; padding: 0.55rem 1rem; border-top: 1px solid rgba(148,163,184,0.20); background: linear-gradient(90deg, rgba(2,6,23,0.95), rgba(15,23,42,0.95)); color: rgba(226,232,240,0.95);"
        >
          <div style="display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap;">
            <span style="font-weight: 800;">Active property:</span>
            <span style="font-weight: 800;">{{ active_admin_property.name }}</span>
            <span style="opacity: 0.7;">(ID {{ active_admin_property.id }})</span>
            <span style="opacity: 0.7;">|</span>
            <a href="{{ url_for('admin.property_workspace', property_id=active_admin_property.id) }}" class="pv-link-muted" style="color: rgba(226,232,240,0.95);">
              Workspace
            </a>
            <a href="{{ url_for('pm.property_users', property_id=active_admin_property.id) }}" class="pv-link-muted" style="color: rgba(226,232,240,0.95);">
              Property users
            </a>
            <a href="{{ url_for('admin.properties_list') }}" class="pv-link-muted" style="color: rgba(226,232,240,0.95);">
              Switch
            </a>
          </div>
          <form method="post" action="{{ url_for('admin.property_context_clear') }}" style="margin: 0;">
            <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />
            <button type="submit" class="pv-button pv-button-small">
              Exit
            </button>
          </form>
        </div>
      {% endif %}
    </header>

    <main class="pv-main" id="pv-main-content" role="main">
      {% block content %}{% endblock %}
    </main>

    <div
      id="pv-status-bar"
      role="status"
      aria-live="polite"
      style="position: fixed; left: 0; right: 0; bottom: 0; z-index: 9998; display: flex; gap: 0.75rem; align-items: center; padding: 0.55rem 0.9rem; box-shadow: 0 -10px 30px rgba(0,0,0,0.55); background: linear-gradient(90deg, rgba(15,23,42,0.98), rgba(2,6,23,0.96)); color: #e5e7eb; font-weight: 700; font-size: 0.92rem; border-top: 1px solid rgba(56,189,248,0.22); backdrop-filter: blur(10px);"
    >
      <span id="pv-status-datetime" style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"></span>
      <span style="opacity: 0.55;">|</span>
      <span style="white-space: nowrap; color: rgba(229,231,235,0.78);">System:</span>
      <span id="pv-status-system" style="white-space: nowrap;"></span>
      <span style="opacity: 0.55;">|</span>
      <span style="white-space: nowrap; color: rgba(229,231,235,0.78);">Last error:</span>
      <span id="pv-status-last-error" style="font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></span>
    </div>

    <div
      id="pv-global-toast"
      role="status"
      aria-live="polite"
      class="pv-toast"
    ></div>

    <script>
      (function () {
        var splash = document.getElementById('pv-splash');
        if (!splash) {
          return;
        }

        var hasSessionStorage = false;
        try {
          hasSessionStorage = typeof window.sessionStorage !== 'undefined';
        } catch (e) {
          hasSessionStorage = false;
        }

        var loginBox = document.getElementById('pv-login-box');
        var isLoginPage = !!loginBox;
        if (isLoginPage) {
          if (hasSessionStorage) {
            try {
              window.sessionStorage.setItem('pvSplashSeen', '1');
            } catch (e) {}
          }

          var stage = loginBox.getAttribute('data-stage') || 'primary';
          var showDelay = stage === 'totp' ? 400 : 5000;

          setTimeout(function () {
            if (loginBox) {
              loginBox.classList.remove('pv-login-box-hidden');
            }
          }, showDelay);

          function attachFadeOnSubmit(formId) {
            var form = document.getElementById(formId);
            if (!form || !loginBox) return;
            form.addEventListener('submit', function (ev) {
              if (loginBox.classList.contains('pv-login-box-submitting')) {
                return;
              }
              loginBox.classList.add('pv-login-box-submitting');
              loginBox.classList.add('pv-login-box-hidden');
              ev.preventDefault();
              setTimeout(function () {
                form.submit();
              }, 350);
            });
          }

          attachFadeOnSubmit('pv-login-form-primary');
          attachFadeOnSubmit('pv-login-form-totp');

          return;
        }

        function hideSoon() {
          setTimeout(function () {
            splash.classList.add('pv-splash-hide');
          }, 5000);
        }

        // If PerformanceNavigationTiming is available, detect reload vs navigate.
        var navType = 'navigate';
        try {
          if (window.performance && performance.getEntriesByType) {
            var entries = performance.getEntriesByType('navigation');
            if (entries && entries.length > 0 && entries[0].type) {
              navType = entries[0].type;
            }
          }
        } catch (e) {
          navType = 'navigate';
        }

        // Always show splash on explicit reloads.
        if (navType === 'reload') {
          hideSoon();
          return;
        }

        if (!hasSessionStorage) {
          // Fallback: show on every navigation if we cannot track state.
          hideSoon();
          return;
        }

        var seen = window.sessionStorage.getItem('pvSplashSeen') === '1';
        if (seen) {
          // Already shown once in this tab: hide immediately for internal navigations.
          splash.classList.add('pv-splash-hide');
          return;
        }

        // First visit in this tab: record and show splash once.
        window.sessionStorage.setItem('pvSplashSeen', '1');
        hideSoon();
      })();
    </script>

    <script>
      (function () {
        var toastEl = document.getElementById('pv-global-toast');
        if (!toastEl) return;

        var statusLastErrorEl = document.getElementById('pv-status-last-error');
        function setLastError(message) {
          if (!statusLastErrorEl) return;
          statusLastErrorEl.textContent = String(message || '');
          try {
            window.sessionStorage.setItem('pvLastError', String(message || ''));
          } catch (e) {}
        }

        try {
          var storedLast = window.sessionStorage.getItem('pvLastError') || '';
          if (storedLast && statusLastErrorEl) {
            statusLastErrorEl.textContent = storedLast;
          }
        } catch (e) {}

        function showToast(message, kind) {
          var title = kind === 'success' ? 'SUCCESS' : (kind === 'error' ? 'ERROR' : 'NOTICE');
          var msg = String(message || '');

          toastEl.innerHTML = '';
          var titleEl = document.createElement('div');
          titleEl.className = 'pv-toast-title';
          titleEl.textContent = title;
          var msgEl = document.createElement('div');
          msgEl.className = 'pv-toast-msg';
          msgEl.textContent = msg;
          toastEl.appendChild(titleEl);
          toastEl.appendChild(msgEl);

          toastEl.style.display = 'block';
          void toastEl.offsetWidth;
          toastEl.classList.add('is-showing');
          setLastError(msg);

          window.clearTimeout(showToast._t);
          showToast._t = window.setTimeout(function () {
            toastEl.classList.remove('is-showing');
            window.clearTimeout(showToast._h);
            showToast._h = window.setTimeout(function () {
              toastEl.style.display = 'none';
            }, 240);
          }, 15000);
        }

        window.pvToastError = function (message) { showToast(message, 'error'); };
        window.pvToastSuccess = function (message) { showToast(message, 'success'); };
        window.pvToast = function (message) { showToast(message, 'notice'); };

        var queue = [];
        try {
          {% set _pv_flash = get_flashed_messages(with_categories=true) %}
          {% set _pv_errors = (errors if errors is defined else []) %}
          queue = (
            {{ _pv_flash|tojson }}
              .map(function (pair) {
                try {
                  return String((pair && pair.length > 1 ? pair[1] : pair) || '');
                } catch (e) {
                  return '';
                }
              })
              .filter(function (m) { return !!m; })
          ).concat(
            {{ _pv_errors|tojson }}
              .map(function (m) { return String(m || ''); })
              .filter(function (m) { return !!m; })
          );
        } catch (e) {
          queue = [];
        }

        if (!queue || !queue.length) return;

        function drain(i) {
          if (!queue || i >= queue.length) return;
          showToast(queue[i], 'error');
          window.setTimeout(function () {
            drain(i + 1);
          }, 15500);
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', function () {
            drain(0);
          });
        } else {
          drain(0);
        }
      })();
    </script>

    <script>
      (function () {
        var el = document.getElementById('pv-status-datetime');
        if (!el) return;

        function pad(n) {
          return String(n).padStart(2, '0');
        }

        function tick() {
          var d = new Date();
          var mm = pad(d.getMonth() + 1);
          var dd = pad(d.getDate());
          var yy = pad(d.getFullYear() % 100);
          var hh = pad(d.getHours());
          var mi = pad(d.getMinutes());
          el.textContent = mm + '/' + dd + '/' + yy + ' ' + hh + ':' + mi;
        }

        tick();
        window.setInterval(tick, 1000);
      })();
    </script>

    <script>
      (function () {
        var statusEl = document.getElementById('pv-status-system');
        if (!statusEl) return;

        function applyStatus(data) {
          var overall = (data && (data.overall_status || data.status)) ? String(data.overall_status || data.status) : 'unknown';
          statusEl.textContent = overall;
        }

        function tick() {
          try {
            fetch('{{ url_for('main.api_status') }}', { credentials: 'same-origin' })
              .then(function (r) {
                if (!r.ok) throw new Error('status ' + r.status);
                return r.json();
              })
              .then(function (data) {
                applyStatus(data);
              })
              .catch(function () {
                statusEl.textContent = 'unknown';
              });
          } catch (e) {
            statusEl.textContent = 'unknown';
          }
        }

        tick();
        window.setInterval(tick, 5000);
      })();
    </script>
  </body>
</html>
