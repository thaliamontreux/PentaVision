{% extends 'base.html' %}

{% block title %}Themes · Admin · PentaVision{% endblock %}

{% block content %}
  <section class="pv-section">
    <h1>Themes</h1>

    <div class="pv-admin-layout">
      {% include 'admin/_nav.html' %}
      <div class="pv-admin-main">

        {% if errors %}
          <div class="pv-alert pv-alert-error" role="alert">
            <ul>
              {% for error in errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        {% if messages %}
          <div class="pv-alert pv-alert-success" role="status">
            <ul>
              {% for msg in messages %}
                <li>{{ msg }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        <div class="pv-card">
          <h2>Active themes</h2>
          <p class="pv-card-subtitle">Set the theme for the public site and the admin area independently. System themes are read-only; duplicate them to customize.</p>

          <form method="post" class="pv-form" style="max-width: 860px;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />

            <div class="pv-field-group">
              <label for="main_theme">Main site theme</label>
              <select id="main_theme" name="main_theme">
                {% for slug, label, kind in main_theme_options %}
                  <option value="{{ slug }}" {% if slug == selected_main %}selected{% endif %}>{{ label }}{% if kind == 'custom' %} (custom){% else %} (system){% endif %}</option>
                {% endfor %}
              </select>
              <p class="pv-help">Applies to the non-admin site pages.</p>
            </div>

            <div class="pv-field-group">
              <label for="admin_theme">Admin theme</label>
              <select id="admin_theme" name="admin_theme">
                {% for slug, label, kind in admin_theme_options %}
                  <option value="{{ slug }}" {% if slug == selected_admin %}selected{% endif %}>{{ label }}{% if kind == 'custom' %} (custom){% else %} (system){% endif %}</option>
                {% endfor %}
              </select>
              <p class="pv-help">Applies to all <code>/admin</code> pages.</p>
            </div>

            <div class="pv-form-actions">
              <button type="submit" class="pv-button-primary">Save active themes</button>
            </div>
          </form>
        </div>

        <div class="pv-dashboard-grid" style="margin-top: 1.1rem; grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); gap: 1.1rem; align-items: start;">
          <div class="pv-card">
            <div class="pv-card-header">
              <div>
                <h2 style="margin-bottom: 0.25rem;">Custom themes</h2>
                <p class="pv-card-subtitle">Create and edit custom themes for each scope.</p>
              </div>
            </div>

            <div style="display:grid; gap: 0.9rem;">
              <div class="pv-card" style="padding: 0.75rem;">
                <div style="font-weight: 800; margin-bottom: 0.35rem;">Duplicate a system theme</div>
                <form method="post" action="{{ url_for('admin.themes_duplicate') }}" class="pv-form" style="margin-top: 0;">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                  <input type="hidden" name="source_kind" value="system" />

                  <div class="pv-field-group">
                    <label for="pvDupScope">Scope</label>
                    <select id="pvDupScope" name="scope">
                      <option value="main">main</option>
                      <option value="admin">admin</option>
                    </select>
                  </div>

                  <div class="pv-field-group">
                    <label for="pvDupSlug">System theme</label>
                    <select id="pvDupSlug" name="slug">
                      {% for s, label in system_themes.get('main', {}).items() %}
                        <option value="{{ s }}" data-scope="main">main: {{ label }}</option>
                      {% endfor %}
                      {% for s, label in system_themes.get('admin', {}).items() %}
                        <option value="{{ s }}" data-scope="admin">admin: {{ label }}</option>
                      {% endfor %}
                    </select>
                  </div>

                  <div class="pv-field-group">
                    <label for="pvDupName">New name</label>
                    <input id="pvDupName" name="name" value="Copied Theme" />
                  </div>

                  <div class="pv-form-actions">
                    <button class="pv-button-secondary" type="submit">Duplicate</button>
                  </div>
                </form>
              </div>

              <div class="pv-card" style="padding: 0.75rem;">
                <div style="font-weight: 800; margin-bottom: 0.35rem;">Create new</div>
                <form method="post" action="{{ url_for('admin.themes_new') }}" class="pv-form" style="margin-top: 0;">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                  <div class="pv-field-group">
                    <label for="pvNewThemeName">Name</label>
                    <input id="pvNewThemeName" name="name" value="New Theme" />
                  </div>
                  <div class="pv-field-group">
                    <label for="pvNewThemeScope">Scope</label>
                    <select id="pvNewThemeScope" name="scope">
                      <option value="main">main</option>
                      <option value="admin">admin</option>
                    </select>
                  </div>
                  <div class="pv-form-actions">
                    <button class="pv-button-primary" type="submit">Create</button>
                  </div>
                </form>
              </div>

              <div class="pv-card" style="padding: 0.75rem;">
                <div style="font-weight: 800; margin-bottom: 0.35rem;">Import theme (JSON)</div>
                <form method="post" action="{{ url_for('admin.themes_import') }}" enctype="multipart/form-data" class="pv-form" style="margin-top: 0;">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                  <div class="pv-field-group">
                    <label for="pvThemeFile">Theme file</label>
                    <input id="pvThemeFile" type="file" name="theme_file" accept="application/json" />
                  </div>
                  <div class="pv-form-actions">
                    <button class="pv-button-secondary" type="submit">Import</button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div class="pv-card">
            <div class="pv-card-header">
              <div>
                <h2 style="margin-bottom: 0.25rem;">Your themes</h2>
                <p class="pv-card-subtitle">Edit, export, and apply custom themes.</p>
              </div>
            </div>

            <div style="display:grid; gap: 0.85rem;">
              <div>
                <div style="font-weight: 800; margin-bottom: 0.35rem;">Main</div>
                {% if custom_themes and custom_themes.get('main') and custom_themes.get('main')|length %}
                  {% for t in custom_themes.get('main') %}
                    <div style="display:flex; gap: 0.6rem; align-items:center; justify-content:space-between; padding: 0.45rem 0; border-bottom: 1px solid rgba(148, 163, 184, 0.12);">
                      <div>
                        <div style="font-weight: 800;">{{ t.name }}</div>
                        <div style="font-size: 0.85rem; color: #9ca3af;"><code>{{ t.slug }}</code></div>
                      </div>
                      <div style="display:flex; gap: 0.5rem; align-items:center;">
                        <a class="pv-link-muted" href="{{ url_for('admin.theme_edit', scope='main', slug=t.slug) }}">Edit</a>
                        <a class="pv-link-muted" href="{{ url_for('admin.theme_export', scope='main', slug=t.slug) }}">Export</a>
                      </div>
                    </div>
                  {% endfor %}
                {% else %}
                  <div style="color:#9ca3af; font-size: 0.9rem;">No custom main themes yet.</div>
                {% endif %}
              </div>

              <div>
                <div style="font-weight: 800; margin-bottom: 0.35rem;">Admin</div>
                {% if custom_themes and custom_themes.get('admin') and custom_themes.get('admin')|length %}
                  {% for t in custom_themes.get('admin') %}
                    <div style="display:flex; gap: 0.6rem; align-items:center; justify-content:space-between; padding: 0.45rem 0; border-bottom: 1px solid rgba(148, 163, 184, 0.12);">
                      <div>
                        <div style="font-weight: 800;">{{ t.name }}</div>
                        <div style="font-size: 0.85rem; color: #9ca3af;"><code>{{ t.slug }}</code></div>
                      </div>
                      <div style="display:flex; gap: 0.5rem; align-items:center;">
                        <a class="pv-link-muted" href="{{ url_for('admin.theme_edit', scope='admin', slug=t.slug) }}">Edit</a>
                        <a class="pv-link-muted" href="{{ url_for('admin.theme_export', scope='admin', slug=t.slug) }}">Export</a>
                      </div>
                    </div>
                  {% endfor %}
                {% else %}
                  <div style="color:#9ca3af; font-size: 0.9rem;">No custom admin themes yet.</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <script>
          (function () {
            var scopeEl = document.getElementById('pvDupScope');
            var slugEl = document.getElementById('pvDupSlug');
            if (!scopeEl || !slugEl) return;

            function applyScope() {
              var scope = String(scopeEl.value || 'main');
              var opts = slugEl.querySelectorAll('option');
              var firstVisible = null;
              opts.forEach(function (o) {
                var os = o.getAttribute('data-scope') || '';
                var visible = (os === scope);
                o.hidden = !visible;
                if (visible && !firstVisible) firstVisible = o;
              });
              if (firstVisible) slugEl.value = firstVisible.value;
            }

            scopeEl.addEventListener('change', applyScope);
            applyScope();
          })();
        </script>

      </div>
    </div>
  </section>
{% endblock %}
