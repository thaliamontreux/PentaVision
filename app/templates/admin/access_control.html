{% extends 'base.html' %}

{% block title %}Block / Allow Â· PentaVision{% endblock %}

{% block content %}
  <section class="pv-section">
    <h1>Block / Allow</h1>

    <div class="pv-admin-layout">
      {% include 'admin/_nav.html' %}
      <div class="pv-admin-main">

        {% if errors %}
          <div class="pv-alert pv-alert-error" role="alert">
            <ul>
              {% for error in errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        {% if messages %}
          <div class="pv-alert pv-alert-success" role="status">
            <ul>
              {% for msg in messages %}
                <li>{{ msg }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        <div class="pv-dashboard-grid" style="grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.7fr); gap: 1.25rem; align-items: flex-start;">
          <div class="pv-card">
        <h2>Current session IP</h2>
        <p class="pv-card-subtitle">
          This is the IP address seen by the server for your current session.
        </p>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
          <div>
            <div style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size: 0.95rem;">
              {{ current_ip or 'Unknown' }}
            </div>
            <div style="font-size: 0.8rem; color: #6b7280; margin-top: 0.15rem;">
              {% if current_ip_is_allowlisted %}
                This IP is currently <strong>exempted</strong> from lockouts and IP/country blocks.
              {% else %}
                This IP is <strong>not yet exempted</strong>. You can add it below.
              {% endif %}
            </div>
          </div>
          <form method="post" class="pv-inline-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
            <input type="hidden" name="action" value="exempt_ip" />
            <button type="submit" class="pv-button-primary" style="white-space: nowrap;">
              Exempt this IP
            </button>
          </form>
        </div>
        <p class="pv-card-subtitle" style="font-size: 0.75rem; margin-top: 0.75rem;">
          Private LAN ranges such as <code>10.0.0.0/8</code>, <code>172.16.0.0/12</code> and <code>192.168.0.0/16</code> are preloaded into the allowlist on first use.
        </p>
          </div>

          <div class="pv-card">
        <h2>Country access policy</h2>
        <p class="pv-card-subtitle">
          Control which countries may access the system. Allowlist and blocklist
          rules are evaluated after IP exemptions and the IP blocklist.
        </p>
        <form method="post" class="pv-form-grid" style="grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr); gap: 0.75rem; margin-top: 0.75rem;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
          <input type="hidden" name="action" value="update_country" />

          <div>
            <label for="mode">Policy mode</label>
            <select id="mode" name="mode">
              {% set mode = (policy.mode if policy and policy.mode else 'disabled') %}
              <option value="disabled" {% if mode == 'disabled' or not mode %}selected{% endif %}>Disabled</option>
              <option value="allow_list" {% if mode == 'allow_list' %}selected{% endif %}>Allow only listed countries</option>
              <option value="block_list" {% if mode == 'block_list' %}selected{% endif %}>Block listed countries</option>
              <option value="allow_all_except_blocked" {% if mode == 'allow_all_except_blocked' %}selected{% endif %}>Allow all except blocked</option>
            </select>
          </div>

          <div></div>

          <div>
            <label for="allowed_countries">Allowed countries</label>
            <select id="allowed_countries" name="allowed_countries" multiple size="8">
              {% if policy and policy.allowed_countries %}
                {% set allowed = policy.allowed_countries.upper().split(',') %}
              {% else %}
                {% set allowed = [] %}
              {% endif %}
              {% for code, name in country_choices %}
                <option value="{{ code }}" {% if code in allowed %}selected{% endif %}>{{ code }} - {{ name }}</option>
              {% endfor %}
            </select>
            <p class="pv-card-subtitle" style="font-size: 0.75rem; margin-top: 0.25rem;">
              Used when the mode is <em>Allow only listed countries</em>.
            </p>
          </div>

          <div>
            <label for="blocked_countries">Blocked countries</label>
            <select id="blocked_countries" name="blocked_countries" multiple size="8">
              {% if policy and policy.blocked_countries %}
                {% set blocked = policy.blocked_countries.upper().split(',') %}
              {% else %}
                {% set blocked = [] %}
              {% endif %}
              {% for code, name in country_choices %}
                <option value="{{ code }}" {% if code in blocked %}selected{% endif %}>{{ code }} - {{ name }}</option>
              {% endfor %}
            </select>
            <p class="pv-card-subtitle" style="font-size: 0.75rem; margin-top: 0.25rem;">
              Used when the mode is <em>Block listed countries</em> or
              <em>Allow all except blocked</em>.
            </p>
          </div>

          <div style="grid-column: 1 / -1; text-align: right; margin-top: 0.25rem;">
            <button type="submit" class="pv-button-primary">Save country policy</button>
          </div>
        </form>
          </div>
        </div>

        <div class="pv-dashboard-grid" style="grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); gap: 1.25rem; margin-top: 1.25rem; align-items: flex-start;">
          <div class="pv-card">
        <h2>IP allowlist (exemptions)</h2>
        <p class="pv-card-subtitle">
          Requests from these IPs or networks bypass lockout, IP blocklist, and
          country-based restrictions.
        </p>

        <form method="post" class="pv-inline-form" style="margin-top: 0.75rem; gap: 0.5rem; flex-wrap: wrap;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
          <input type="hidden" name="action" value="add_allow" />
          <input type="text" name="cidr" placeholder="IP or CIDR (e.g. 203.0.113.5 or 192.0.2.0/24)" style="flex: 1 1 16rem;" />
          <input type="text" name="description" placeholder="Description (optional)" style="flex: 1 1 10rem;" />
          <button type="submit" class="pv-button-primary">Add exemption</button>
        </form>

        {% if ip_allow %}
          <table class="pv-table" style="margin-top: 0.75rem;">
            <thead>
              <tr>
                <th>CIDR / IP</th>
                <th>Description</th>
                <th style="width: 1%; white-space: nowrap;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in ip_allow %}
                <tr>
                  <td><code>{{ entry.cidr }}</code></td>
                  <td>{{ entry.description or '\u00a0' }}</td>
                  <td>
                    <form method="post" class="pv-inline-form">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                      <input type="hidden" name="action" value="delete_allow" />
                      <input type="hidden" name="id" value="{{ entry.id }}" />
                      <button type="submit" class="pv-button-secondary" style="padding: 0.15rem 0.6rem; font-size: 0.8rem;">
                        Remove
                      </button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="pv-card-subtitle" style="margin-top: 0.75rem;">No exemptions configured.</p>
        {% endif %}
          </div>

          <div class="pv-card">
        <h2>IP / network blocklist</h2>
        <p class="pv-card-subtitle">
          Requests from these IPs or networks are rejected before authentication,
          unless they are explicitly exempted above.
        </p>

        <form method="post" class="pv-inline-form" style="margin-top: 0.75rem; gap: 0.5rem; flex-wrap: wrap;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
          <input type="hidden" name="action" value="add_block" />
          <input type="text" name="cidr" placeholder="IP or CIDR (e.g. 198.51.100.0/24)" style="flex: 1 1 16rem;" />
          <input type="text" name="description" placeholder="Description (optional)" style="flex: 1 1 10rem;" />
          <button type="submit" class="pv-button-primary">Add block</button>
        </form>

        {% if ip_block %}
          <table class="pv-table" style="margin-top: 0.75rem;">
            <thead>
              <tr>
                <th>CIDR / IP</th>
                <th>Description</th>
                <th style="width: 1%; white-space: nowrap;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in ip_block %}
                <tr>
                  <td><code>{{ entry.cidr }}</code></td>
                  <td>{{ entry.description or '\u00a0' }}</td>
                  <td>
                    <form method="post" class="pv-inline-form">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                      <input type="hidden" name="action" value="delete_block" />
                      <input type="hidden" name="id" value="{{ entry.id }}" />
                      <button type="submit" class="pv-button-secondary" style="padding: 0.15rem 0.6rem; font-size: 0.8rem;">
                        Remove
                      </button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="pv-card-subtitle" style="margin-top: 0.75rem;">No IP or network blocks configured.</p>
        {% endif %}
          </div>
        </div>

      </div>
    </div>
  </section>
{% endblock %}
