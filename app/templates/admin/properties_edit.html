{% extends 'base.html' %}

{% block title %}{% if is_edit %}Edit Property{% else %}New Property{% endif %} · Admin · PentaVision{% endblock %}

{% block content %}
  <section class="pv-section">
    <h1>
      {% if is_edit %}
        Edit property
      {% else %}
        New property
      {% endif %}
    </h1>

    {% if errors %}
      <div class="pv-alert pv-alert-error" role="alert">
        <ul>
          {% for error in errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    {% if form is not none %}
      <form method="post" class="pv-form" style="max-width: 480px;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />

        <div class="pv-field-group">
          <label for="name">Name</label>
          <input
            id="name"
            name="name"
            type="text"
            required
            value="{{ form.name }}"
          />
        </div>

        <div class="pv-field-group">
          <label for="address_line1">Address line 1</label>
          <input
            id="address_line1"
            name="address_line1"
            type="text"
            value="{{ form.address_line1 }}"
          />
        </div>

        <div class="pv-field-group">
          <label for="address_line2">Address line 2</label>
          <input
            id="address_line2"
            name="address_line2"
            type="text"
            value="{{ form.address_line2 }}"
          />
        </div>

        <div class="pv-field-group">
          <label for="city">City</label>
          <input
            id="city"
            name="city"
            type="text"
            value="{{ form.city }}"
          />
        </div>

        <div class="pv-field-group">
          <label for="state">State / region</label>
          <input
            id="state"
            name="state"
            type="text"
            value="{{ form.state }}"
          />
        </div>

        <div class="pv-field-group">
          <label for="postal_code">Postal code</label>
          <input
            id="postal_code"
            name="postal_code"
            type="text"
            value="{{ form.postal_code }}"
          />
        </div>

        <div class="pv-field-group">
          <label for="country">Country</label>
          <input
            id="country"
            name="country"
            type="text"
            value="{{ form.country }}"
          />
        </div>

        <div class="pv-field-group">
          <label for="timezone">Time zone</label>
          <input
            id="timezone"
            name="timezone"
            type="text"
            value="{{ form.timezone }}"
          />
          <p class="pv-card-subtitle">
            Optional IANA time zone name (for example, <code>America/Chicago</code>).
          </p>
        </div>

        <button type="submit" class="pv-button pv-button-primary">
          {% if is_edit %}
            Save changes
          {% else %}
            Create property
          {% endif %}
        </button>
        <a href="{{ url_for('admin.properties_list') }}" class="pv-button" style="margin-left: 0.5rem;">
          Cancel
        </a>
      </form>
    {% else %}
      <p>Nothing to edit.</p>
    {% endif %}

    {% if is_edit and users %}
      <hr style="margin: 2rem 0;" />
      <h2>Users at this property</h2>
      <p class="pv-card-subtitle">
        Link users to this property and define residency status, zones, and camera
        scope. These settings will be used by future per-property RBAC checks.
      </p>

      <table class="pv-table">
        <thead>
          <tr>
            <th scope="col">User</th>
            <th scope="col">Residency</th>
            <th scope="col">Authorized zones</th>
            <th scope="col">Camera scope</th>
            <th scope="col">Access windows</th>
            <th scope="col">Role overrides</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
            {% set link = user_links.get(user.id) %}
            <tr>
              <td>{{ user.email }}</td>
              <td>
                <form
                  method="post"
                  action="{{ url_for('admin.property_update_user', property_id=property_id, user_id=user.id) }}"
                >
                  <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                  <input type="hidden" name="action" value="save" />
                  <input
                    name="residency_status"
                    type="text"
                    value="{{ link.residency_status if link else '' }}"
                    style="width: 7rem;"
                  />
              </td>
              <td>
                  <input
                    name="authorized_zones"
                    type="text"
                    value="{{ link.authorized_zones if link else '' }}"
                    style="width: 9rem;"
                  />
              </td>
              <td>
                  <input
                    name="camera_scope"
                    type="text"
                    value="{{ link.camera_scope if link else '' }}"
                    style="width: 9rem;"
                  />
              </td>
              <td>
                  <input
                    name="access_windows"
                    type="text"
                    value="{{ link.access_windows if link else '' }}"
                    style="width: 9rem;"
                  />
              </td>
              <td>
                  <input
                    name="role_overrides"
                    type="text"
                    value="{{ link.role_overrides if link else '' }}"
                    style="width: 9rem;"
                  />
              </td>
              <td>
                  <button type="submit" class="pv-button pv-button-small">
                    Save
                  </button>
                </form>
                {% if link %}
                  <form
                    method="post"
                    action="{{ url_for('admin.property_update_user', property_id=property_id, user_id=user.id) }}"
                    style="display: inline; margin-left: 0.25rem;"
                  >
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                    <input type="hidden" name="action" value="remove" />
                    <button type="submit" class="pv-button pv-button-small">
                      Remove
                    </button>
                  </form>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </section>
{% endblock %}
