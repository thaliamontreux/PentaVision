{% extends 'base.html' %}

{% block title %}{{ role.name }} · RBAC · PentaVision{% endblock %}

{% block content %}
  <section class="pv-admin-layout">
    <div class="pv-admin-sidebar">
      {% include 'admin/_nav.html' %}
    </div>

    <div class="pv-admin-main">
      <div class="pv-page-header">
        <div>
          <a href="{{ url_for('admin.rbac_management') }}" class="pv-back-link">← Back to RBAC</a>
          <h1 class="pv-page-title">{{ role.name }}</h1>
          <p class="pv-page-subtitle">Manage permissions for this role</p>
        </div>
      </div>

      <div class="pv-card">
        <div class="pv-card-header">
          <h2>Role Information</h2>
        </div>
        <div class="pv-card-body">
          <div class="pv-field-group">
            <label>Name</label>
            <input type="text" value="{{ role.name }}" disabled />
          </div>
          {% if role.scope %}
            <div class="pv-field-group">
              <label>Scope</label>
              <input type="text" value="{{ role.scope }}" disabled />
            </div>
          {% endif %}
          {% if role.description %}
            <div class="pv-field-group">
              <label>Description</label>
              <textarea disabled rows="2">{{ role.description }}</textarea>
            </div>
          {% endif %}
        </div>
      </div>

      <div class="pv-card">
        <div class="pv-card-header">
          <h2>Permissions</h2>
          <p class="pv-card-subtitle">Select permissions to assign to this role</p>
        </div>
        <form method="post" action="{{ url_for('admin.rbac_role_permissions_update', role_id=role.id) }}">
          <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />
          
          <div class="pv-card-body">
            {% if all_permissions %}
              <div class="pv-checkbox-group">
                {% for perm in all_permissions %}
                  <label class="pv-checkbox-label">
                    <input 
                      type="checkbox" 
                      name="permission_ids" 
                      value="{{ perm.id }}"
                      {% if perm.id in role_permissions %}checked{% endif %}
                    />
                    <div>
                      <div>
                        <code class="pv-permission-name">{{ perm.name }}</code>
                        {% if perm.risk_level %}
                          <span class="pv-badge pv-badge-{% if perm.risk_level == 'high' %}danger{% elif perm.risk_level == 'medium' %}warning{% else %}muted{% endif %} pv-ml-1">
                            {{ perm.risk_level }}
                          </span>
                        {% endif %}
                      </div>
                      {% if perm.description %}
                        <div class="pv-permission-description">{{ perm.description }}</div>
                      {% endif %}
                      <div class="pv-permission-flags">
                        {% if perm.requires_mfa %}
                          <span class="pv-badge pv-badge-primary">MFA Required</span>
                        {% endif %}
                        {% if perm.requires_approval %}
                          <span class="pv-badge pv-badge-warning">Approval Required</span>
                        {% endif %}
                        {% if perm.break_glass_only %}
                          <span class="pv-badge pv-badge-danger">Break Glass Only</span>
                        {% endif %}
                      </div>
                    </div>
                  </label>
                {% endfor %}
              </div>
            {% else %}
              <div class="pv-empty">
                <p class="pv-empty-title">No permissions available</p>
              </div>
            {% endif %}
          </div>

          {% if all_permissions %}
            <div class="pv-card-footer">
              <button type="submit" class="pv-button pv-button-primary">
                Save Permissions
              </button>
            </div>
          {% endif %}
        </form>
      </div>
    </div>
  </section>
{% endblock %}
