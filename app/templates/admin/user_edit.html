{% extends 'base.html' %}

{% block title %}{% if is_edit %}Edit User{% else %}New User{% endif %} · Admin · PentaVision{% endblock %}

{% block content %}
  <section class="pv-section">
    <h1>
      {% if is_edit %}
        Edit user
      {% else %}
        New user
      {% endif %}
    </h1>

    <div class="pv-admin-layout">
      {% include 'admin/_nav.html' %}
      <div class="pv-admin-main">

        {% if errors %}
          <div class="pv-alert pv-alert-error" role="alert">
            <ul>
              {% for error in errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        {% if form is not none %}
          <form method="post" class="pv-form pv-form-admin-user">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />

        <div class="pv-field-group">
          <label for="email">Email</label>
          <input
            id="email"
            name="email"
            type="email"
            value="{{ form.email }}"
            {% if not is_edit %}required{% else %}readonly{% endif %}
          />
          {% if is_edit %}
            <p class="pv-card-subtitle">Email cannot be changed from this screen.</p>
          {% endif %}
        </div>

        <div class="pv-field-group">
          <label for="full_name">Full name</label>
          <input
            id="full_name"
            name="full_name"
            type="text"
            value="{{ form.full_name }}"
          />
        </div>

        <div class="pv-field-group">
          <label for="preferred_name">Preferred name</label>
          <input
            id="preferred_name"
            name="preferred_name"
            type="text"
            value="{{ form.preferred_name }}"
          />
        </div>

        <div class="pv-field-group">
          <label for="pronouns">Pronouns</label>
          <select id="pronouns" name="pronouns">
            {% for p in pronoun_options %}
              <option value="{{ p }}" {% if form.pronouns == p %}selected{% endif %}>
                {{ p if p else '— Select pronouns —' }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="pv-field-group">
          <label for="timezone">Time zone</label>
          <select id="timezone" name="timezone">
            {% for tz in timezone_options %}
              <option value="{{ tz }}" {% if form.timezone == tz %}selected{% endif %}>
                {{ tz }}
              </option>
            {% endfor %}
          </select>
          <p class="pv-card-subtitle">
            IANA time zone (for example, <code>America/Chicago</code>).
          </p>
        </div>

        {% if is_edit %}
          <div class="pv-field-group">
            <label for="account_status">Account status</label>
            <input
              id="account_status"
              name="account_status"
              type="text"
              value="{{ form.account_status }}"
            />
            <p class="pv-card-subtitle">
              Optional free-form status such as <code>active</code>, <code>suspended</code>, or <code>disabled</code>.
            </p>
          </div>
        {% else %}
          <div class="pv-field-group pv-form-full-row">
            <label for="property_ids">Households this user can view</label>
            <select
              id="property_ids"
              name="property_ids"
              multiple
              size="5"
            >
              {% for prop in properties %}
                <option
                  value="{{ prop.id }}"
                  {% if prop.id in selected_property_ids %}selected{% endif %}
                >
                  {{ prop.name }}{% if prop.city %} – {{ prop.city }}{% if prop.state %}, {{ prop.state }}{% endif %}{% endif %}
                </option>
              {% endfor %}
            </select>
            <p class="pv-card-subtitle">
              Hold Ctrl (Windows) or Cmd (macOS) to select multiple households.
            </p>
          </div>

          <div class="pv-field-group">
            <label for="password">Initial password</label>
            <input
              id="password"
              name="password"
              type="password"
              required
            />
          </div>

          <div class="pv-field-group">
            <label for="password_confirm">Confirm password</label>
            <input
              id="password_confirm"
              name="password_confirm"
              type="password"
              required
            />
          </div>

          <fieldset class="pv-field-group pv-form-full-row">
            <legend>Initial roles</legend>
            <label class="pv-checkbox-label">
              <input
                type="checkbox"
                name="make_viewer"
                value="1"
              />
              <span>Viewer</span>
            </label>
            <label class="pv-checkbox-label">
              <input
                type="checkbox"
                name="make_admin"
                value="1"
              />
              <span>System Administrator</span>
            </label>
            <label class="pv-checkbox-label" style="margin-top: 0.25rem;">
              <input
                type="checkbox"
                name="make_tech"
                value="1"
              />
              <span>Technician</span>
            </label>
          </fieldset>
        {% endif %}

        <div class="pv-form-actions">
          <button type="submit" class="pv-button pv-button-primary">
            {% if is_edit %}
              Save changes
            {% else %}
              Create user
            {% endif %}
          </button>
          <a href="{{ url_for('admin.users_list') }}" class="pv-button">
            Cancel
          </a>
        </div>
          </form>
        {% else %}
          <p>Nothing to edit.</p>
        {% endif %}

      </div>
    </div>
  </section>
  <script>
    (function () {
      // Only apply the auto-preferred-name behavior on the new-user form.
      var isEdit = {{ 'true' if is_edit else 'false' }};
      if (isEdit) return;

      var fullInput = document.getElementById('full_name');
      var preferredInput = document.getElementById('preferred_name');
      if (!fullInput || !preferredInput) return;

      var userTouchedPreferred = false;

      preferredInput.addEventListener('input', function () {
        // Once the admin starts typing in Preferred name, stop auto-syncing.
        if (preferredInput.value.trim() !== '') {
          userTouchedPreferred = true;
        }
      });

      fullInput.addEventListener('input', function () {
        if (userTouchedPreferred) return;
        var full = fullInput.value || '';
        var first = full.split(/\s+/).filter(function (p) { return p.length > 0; })[0] || '';
        preferredInput.value = first;
      });
    })();
  </script>
{% endblock %}
