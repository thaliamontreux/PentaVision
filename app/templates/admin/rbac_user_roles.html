{% extends 'base.html' %}

{% block title %}{{ target_user.username }} Roles · RBAC · PentaVision{% endblock %}

{% block content %}
  <section class="pv-admin-layout">
    <div class="pv-admin-sidebar">
      {% include 'admin/_nav.html' %}
    </div>

    <div class="pv-admin-main">
      <div class="pv-page-header">
        <div>
          <a href="{{ url_for('admin.rbac_management') }}" class="pv-back-link">← Back to RBAC</a>
          <h1 class="pv-page-title">{{ target_user.username }}</h1>
          <p class="pv-page-subtitle">Manage global role assignments</p>
        </div>
      </div>

      <div class="pv-card">
        <div class="pv-card-header">
          <h2>User Information</h2>
        </div>
        <div class="pv-card-body">
          <div class="pv-field-group">
            <label>Username</label>
            <input type="text" value="{{ target_user.username }}" disabled />
          </div>
          {% if target_user.email %}
            <div class="pv-field-group">
              <label>Email</label>
              <input type="text" value="{{ target_user.email }}" disabled />
            </div>
          {% endif %}
        </div>
      </div>

      <div class="pv-card">
        <div class="pv-card-header">
          <h2>Global Role Assignments</h2>
          <p class="pv-card-subtitle">Select roles to assign to this user (property-scoped roles are managed separately)</p>
        </div>
        <form method="post" action="{{ url_for('admin.rbac_user_roles_update', target_user_id=target_user.id) }}">
          <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />
          
          <div class="pv-card-body">
            {% if all_roles %}
              <div class="pv-role-list">
                {% for role in all_roles %}
                  <label class="pv-role-card">
                    <div class="pv-role-card-header">
                      <input 
                        type="checkbox" 
                        name="role_ids" 
                        value="{{ role.id }}"
                        {% if role.id in user_role_ids %}checked{% endif %}
                      />
                      <h3 class="pv-role-card-title">{{ role.name }}</h3>
                      {% if role.scope %}
                        <span class="pv-badge pv-badge-muted">{{ role.scope }}</span>
                      {% endif %}
                    </div>
                    {% if role.description %}
                      <p class="pv-role-card-description">{{ role.description }}</p>
                    {% endif %}
                  </label>
                {% endfor %}
              </div>
            {% else %}
              <div class="pv-empty">
                <p class="pv-empty-title">No roles available</p>
              </div>
            {% endif %}
          </div>

          {% if all_roles %}
            <div class="pv-card-footer">
              <button type="submit" class="pv-button pv-button-primary">
                Save Role Assignments
              </button>
            </div>
          {% endif %}
        </form>
      </div>
    </div>
  </section>
{% endblock %}
