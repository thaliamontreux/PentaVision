{% extends 'base.html' %}

{% block title %}Admin Â· PentaVision{% endblock %}

{% block content %}
  <section class="pv-section pv-admin">
    <h1>Administration</h1>

    <div class="pv-admin-layout">
      {% include 'admin/_nav.html' %}
      <div class="pv-admin-main">
        <div class="pv-grid pv-admin-grid">
          {% if is_system_admin %}
            <a href="{{ url_for('admin.index') }}" class="pv-card">
              <h2 class="pv-card-title">Overview</h2>
              <p class="pv-card-subtitle">Administrative shortcuts for users, cameras, storage, recording policies, and security controls.</p>
            </a>

            <a href="{{ url_for('admin.users_list') }}" class="pv-card">
              <h2 class="pv-card-title">Users</h2>
              <p class="pv-card-subtitle">Create, edit, and deactivate user accounts. Manage global roles such as System Administrator and Technician.</p>
            </a>

            <a href="{{ url_for('admin.properties_list') }}" class="pv-card">
              <h2 class="pv-card-title">Properties</h2>
              <p class="pv-card-subtitle">Manage properties and link users to sites for future per-property access control.</p>
            </a>
          {% endif %}

          {% if is_system_admin or is_property_admin or is_technician %}
            <a href="{{ url_for('camera_admin.list_devices') }}" class="pv-card">
              <h2 class="pv-card-title">Cameras</h2>
              <p class="pv-card-subtitle">Configure cameras, templates, storage policies, and per-property camera assignments.</p>
            </a>

            <a href="{{ url_for('camera_admin.list_patterns') }}" class="pv-card">
              <h2 class="pv-card-title">Camera URL templates</h2>
              <p class="pv-card-subtitle">Maintain URL templates for common camera vendors and models.</p>
            </a>

            <a href="{{ url_for('camera_admin.rtmp_list') }}" class="pv-card">
              <h2 class="pv-card-title">RTMP outputs</h2>
              <p class="pv-card-subtitle">Manage RTMP outputs and control remote RTMP publishing per camera.</p>
            </a>
          {% endif %}

          {% if is_system_admin %}
            <a href="{{ url_for('admin.recordings_alias') }}" class="pv-card">
              <h2 class="pv-card-title">Recordings</h2>
              <p class="pv-card-subtitle">Review recorded footage and verify that retention and storage targets are working as expected.</p>
            </a>

            <a href="{{ url_for('admin.recording_settings_alias') }}" class="pv-card">
              <h2 class="pv-card-title">Recording settings</h2>
              <p class="pv-card-subtitle">Manage recording schedules, per-camera storage targets, and recording policies.</p>
            </a>

            <a href="{{ url_for('admin.storage_settings') }}" class="pv-card">
              <h2 class="pv-card-title">Storage</h2>
              <p class="pv-card-subtitle">Manage storage modules and verify active providers for camera recordings.</p>
            </a>

            <a href="{{ url_for('admin.themes') }}" class="pv-card">
              <h2 class="pv-card-title">Themes</h2>
              <p class="pv-card-subtitle">Select a theme for the main site and a separate theme for the admin area.</p>
            </a>

            <a href="{{ url_for('admin.access_control') }}" class="pv-card">
              <h2 class="pv-card-title">Block / Allow</h2>
              <p class="pv-card-subtitle">Manage IP exemptions, IP blocks, and country access policies.</p>
            </a>

            <a href="{{ url_for('admin.blocklist_distribution') }}" class="pv-card">
              <h2 class="pv-card-title">Blocklist Distribution</h2>
              <p class="pv-card-subtitle">Configure external blocklist publication for pfSense/firewalls and view current distribution health.</p>
            </a>

            <a href="{{ url_for('admin.blocklist_integration') }}" class="pv-card">
              <h2 class="pv-card-title">Blocklist Integration</h2>
              <p class="pv-card-subtitle">Configure how blocklist publication is exposed and secured for external systems.</p>
            </a>

            <a href="{{ url_for('admin.blocklist_audit') }}" class="pv-card">
              <h2 class="pv-card-title">Blocklist Audit</h2>
              <p class="pv-card-subtitle">Review blocklist generation, enforcement actions, and recent audit entries.</p>
            </a>

            <a href="{{ url_for('admin.services') }}" class="pv-card">
              <h2 class="pv-card-title">Services</h2>
              <p class="pv-card-subtitle">Restart allowlisted system services and review basic health states.</p>
            </a>

            <a href="#" class="pv-card" id="pvGitPullBtn" data-csrf="{{ csrf_token|default('') }}" data-start-url="{{ git_pull_start_url|default('') }}" role="button">
              <h2 class="pv-card-title">Pull GitHub Update</h2>
              <p class="pv-card-subtitle">Run scripts/git_pull.sh on the server and watch output live (read-only).</p>
            </a>

            <a href="{{ url_for('admin.audit_alias') }}" class="pv-card">
              <h2 class="pv-card-title">Audit log</h2>
              <p class="pv-card-subtitle">Review recent administrative actions and security-related events.</p>
            </a>

            <a href="{{ url_for('admin.login_failures_list') }}" class="pv-card">
              <h2 class="pv-card-title">Login failures</h2>
              <p class="pv-card-subtitle">Review failed login attempts and decrypt the attempted password (admin-only).</p>
            </a>

            <a href="{{ url_for('installer.install') }}" class="pv-card">
              <h2 class="pv-card-title">Installer & databases</h2>
              <p class="pv-card-subtitle">Review or adjust database configuration via the installer (when unlocked).</p>
            </a>
          {% endif %}
        </div>
      </div>
    </div>
  </section>

  <script>
    (function () {
      const btn = document.getElementById('pvGitPullBtn');
      if (!btn) return;

      async function startRun() {
        const csrf = btn.getAttribute('data-csrf') || '';
        const startUrl = btn.getAttribute('data-start-url') || '';
        if (!startUrl) {
          alert('Git Pull endpoint not available yet. Please restart pentavision-web after pulling updates.');
          return;
        }
        btn.classList.add('is-disabled');
        try {
          const form = new FormData();
          form.append('csrf_token', csrf);
          const r = await fetch(startUrl, {
            method: 'POST',
            body: form,
            cache: 'no-store'
          });
          const data = await r.json();
          if (!data || !data.ok || !data.view_url) {
            btn.classList.remove('is-disabled');
            alert((data && data.error) ? data.error : 'Failed to start git pull');
            return;
          }
          const w = window.open(data.view_url, 'pvGitPull', 'popup=yes,width=980,height=680');
          if (!w) {
            btn.classList.remove('is-disabled');
            alert('Popup blocked. Please allow popups for this site.');
            return;
          }
          const timer = setInterval(() => {
            if (w.closed) {
              clearInterval(timer);
              btn.classList.remove('is-disabled');
            }
          }, 800);
        } catch (e) {
          btn.classList.remove('is-disabled');
          alert('Failed to start git pull');
        }
      }

      btn.addEventListener('click', function (ev) {
        try { ev.preventDefault(); } catch (e) {}
        if (btn.classList.contains('is-disabled')) return;
        startRun();
      });
    })();
  </script>
{% endblock %}
