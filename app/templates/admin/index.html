{% extends 'base.html' %}

{% block title %}Admin Â· PentaVision{% endblock %}

{% block content %}
  <section class="pv-section pv-admin">
    <h1>Administration</h1>

    <div class="pv-admin-layout">
      {% include 'admin/_nav.html' %}
      <div class="pv-admin-main">
        <div class="pv-grid pv-admin-grid">
      <a href="{{ url_for('admin.users_list') }}" class="pv-card">
        <h2 class="pv-card-title">Users</h2>
        <p class="pv-card-subtitle">Create, edit, and deactivate user accounts. Manage global roles such as System Administrator and Technician.</p>
      </a>

      <a href="{{ url_for('admin.properties_list') }}" class="pv-card">
        <h2 class="pv-card-title">Properties</h2>
        <p class="pv-card-subtitle">Manage properties and link users to sites for future per-property access control.</p>
      </a>

      <a href="{{ url_for('camera_admin.list_devices') }}" class="pv-card">
        <h2 class="pv-card-title">Cameras</h2>
        <p class="pv-card-subtitle">Configure cameras, templates, storage policies, and per-property camera assignments.</p>
      </a>

      <a href="{{ url_for('camera_admin.list_patterns') }}" class="pv-card">
        <h2 class="pv-card-title">Camera URL templates</h2>
        <p class="pv-card-subtitle">Maintain URL templates for common camera vendors and models.</p>
      </a>

      <a href="{{ url_for('main.recordings') }}" class="pv-card">
        <h2 class="pv-card-title">Recordings</h2>
        <p class="pv-card-subtitle">Review recorded footage and verify that retention and storage targets are working as expected.</p>
      </a>

      <a href="{{ url_for('main.storage_settings') }}" class="pv-card">
        <h2 class="pv-card-title">Storage</h2>
        <p class="pv-card-subtitle">Inspect configured storage targets (local filesystem, S3, database, and more).</p>
      </a>

      <a href="{{ url_for('admin.access_control') }}" class="pv-card">
        <h2 class="pv-card-title">Block / Allow</h2>
        <p class="pv-card-subtitle">Manage IP exemptions, IP blocks, and country access policies.</p>
      </a>

      <a href="{{ url_for('admin.blocklist_distribution') }}" class="pv-card">
        <h2 class="pv-card-title">Blocklist Distribution</h2>
        <p class="pv-card-subtitle">Configure external blocklist publication for pfSense/firewalls and view current distribution health.</p>
      </a>

      <a href="{{ url_for('admin.services') }}" class="pv-card">
        <h2 class="pv-card-title">Services</h2>
        <p class="pv-card-subtitle">Restart allowlisted system services and review basic health states.</p>
      </a>

      <button type="button" class="pv-card" id="pvGitPullBtn" data-csrf="{{ csrf_token|default('') }}" style="text-align:left;">
        <h2 class="pv-card-title">Pull GitHub Update</h2>
        <p class="pv-card-subtitle">Run <span class="pv-mono">scripts/git_pull.sh</span> on the server and watch output live (read-only).</p>
      </button>

      <a href="{{ url_for('installer.install') }}" class="pv-card">
        <h2 class="pv-card-title">Installer & databases</h2>
        <p class="pv-card-subtitle">Review or adjust database configuration via the installer (when unlocked).</p>
      </a>

      <a href="{{ url_for('main.audit_events') }}" class="pv-card">
        <h2 class="pv-card-title">Audit log</h2>
        <p class="pv-card-subtitle">Review recent administrative actions and security-related events.</p>
      </a>
        </div>
      </div>
    </div>
  </section>

  <script>
    (function () {
      const btn = document.getElementById('pvGitPullBtn');
      if (!btn) return;

      async function startRun() {
        const csrf = btn.getAttribute('data-csrf') || '';
        btn.disabled = true;
        try {
          const form = new FormData();
          form.append('csrf_token', csrf);
          const r = await fetch('{{ url_for("admin.git_pull_start") }}', {
            method: 'POST',
            body: form,
            cache: 'no-store'
          });
          const data = await r.json();
          if (!data || !data.ok || !data.view_url) {
            btn.disabled = false;
            alert((data && data.error) ? data.error : 'Failed to start git pull');
            return;
          }
          const w = window.open(data.view_url, 'pvGitPull', 'popup=yes,width=980,height=680');
          if (!w) {
            btn.disabled = false;
            alert('Popup blocked. Please allow popups for this site.');
            return;
          }
          const timer = setInterval(() => {
            if (w.closed) {
              clearInterval(timer);
              btn.disabled = false;
            }
          }, 800);
        } catch (e) {
          btn.disabled = false;
          alert('Failed to start git pull');
        }
      }

      btn.addEventListener('click', startRun);
    })();
  </script>
{% endblock %}
