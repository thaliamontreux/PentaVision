{% extends 'base.html' %}

{% block title %}Admin Â· PentaVision{% endblock %}

{% block content %}
  <section class="pv-section pv-admin">
    <div class="pv-admin-layout">
      {% include 'admin/_nav.html' %}
      <div class="pv-admin-main">
        <div class="pv-page-header">
          <div>
            <h1 class="pv-page-title">Administration</h1>
            <p class="pv-page-subtitle">Administrative shortcuts for users, properties, feeds, recording, storage, security, and services.</p>
          </div>
        </div>
        <div class="pv-grid pv-admin-grid">
          {% if has_permission('Nav.Overview.View') %}
            <a href="{{ url_for('admin.index') }}" class="pv-card">
              <img class="pv-admin-tile-icon" src="{{ url_for('static', filename='img/admin-icons/overview.png') }}" alt="" loading="lazy" onerror="this.style.display='none'" />
              <div class="pv-admin-tile-head">
                <h2 class="pv-card-title">Overview</h2>
              </div>
              <p class="pv-card-subtitle">Administrative shortcuts for users, properties, feeds, recording, storage, security, and services.</p>
            </a>
          {% endif %}

          {% if has_permission('Nav.IAM.Users.View') %}
            <a href="{{ url_for('admin.users_list') }}" class="pv-card">
              <img class="pv-admin-tile-icon" src="{{ url_for('static', filename='img/admin-icons/users.png') }}" alt="" loading="lazy" onerror="this.style.display='none'" />
              <div class="pv-admin-tile-head">
                <h2 class="pv-card-title">Users</h2>
              </div>
              <p class="pv-card-subtitle">Create, edit, and deactivate user accounts. Manage staff roles and access.</p>
            </a>
          {% endif %}

          {% if has_permission('Nav.Cust.Properties.View') %}
            <a href="{{ url_for('admin.properties_list') }}" class="pv-card">
              <img class="pv-admin-tile-icon" src="{{ url_for('static', filename='img/admin-icons/properties.png') }}" alt="" loading="lazy" onerror="this.style.display='none'" />
              <div class="pv-admin-tile-head">
                <h2 class="pv-card-title">Properties</h2>
              </div>
              <p class="pv-card-subtitle">Manage properties and link staff to sites for property access control.</p>
            </a>
          {% endif %}

          {% if has_permission('Nav.Feeds.Cameras.View') %}
            <a href="{{ url_for('camera_admin.list_devices') }}" class="pv-card">
              <img class="pv-admin-tile-icon" src="{{ url_for('static', filename='img/admin-icons/cameras.png') }}" alt="" loading="lazy" onerror="this.style.display='none'" />
              <div class="pv-admin-tile-head">
                <h2 class="pv-card-title">Cameras</h2>
              </div>
              <p class="pv-card-subtitle">Configure camera devices and property-scoped camera assignments.</p>
            </a>
          {% endif %}

          {% if has_permission('Nav.Feeds.CameraUrlTemplates.View') %}
            <a href="{{ url_for('camera_admin.list_patterns') }}" class="pv-card">
              <img class="pv-admin-tile-icon" src="{{ url_for('static', filename='img/admin-icons/camera-templates.png') }}" alt="" loading="lazy" onerror="this.style.display='none'" />
              <div class="pv-admin-tile-head">
                <h2 class="pv-card-title">Camera URL Templates</h2>
              </div>
              <p class="pv-card-subtitle">Maintain URL templates for common camera vendors and models.</p>
            </a>
          {% endif %}

          {% if has_permission('Nav.Feeds.RtmpOutputs.View') %}
            <a href="{{ url_for('camera_admin.rtmp_list') }}" class="pv-card">
              <img class="pv-admin-tile-icon" src="{{ url_for('static', filename='img/admin-icons/rtmp-outputs.png') }}" alt="" loading="lazy" onerror="this.style.display='none'" />
              <div class="pv-admin-tile-head">
                <h2 class="pv-card-title">RTMP Outputs</h2>
              </div>
              <p class="pv-card-subtitle">Manage RTMP outputs and control remote publishing per camera.</p>
            </a>
          {% endif %}

          {% if has_permission('Nav.Recording.Recordings.View') %}
            <a href="{{ url_for('admin.recordings_alias') }}" class="pv-card">
              <img class="pv-admin-tile-icon" src="{{ url_for('static', filename='img/admin-icons/recordings.png') }}" alt="" loading="lazy" onerror="this.style.display='none'" />
              <div class="pv-admin-tile-head">
                <h2 class="pv-card-title">Recordings</h2>
              </div>
              <p class="pv-card-subtitle">Review recorded footage and verify retention and storage targets.</p>
            </a>
          {% endif %}

          {% if has_permission('Nav.Recording.Schedule.View') %}
            <a href="{{ url_for('admin.recording_settings_alias') }}" class="pv-card">
              <img class="pv-admin-tile-icon" src="{{ url_for('static', filename='img/admin-icons/recording-schedule.png') }}" alt="" loading="lazy" onerror="this.style.display='none'" />
              <div class="pv-admin-tile-head">
                <h2 class="pv-card-title">Recording Schedule</h2>
              </div>
              <p class="pv-card-subtitle">Manage recording schedules, storage targets, and recording policies.</p>
            </a>
          {% endif %}

          {% if has_permission('Nav.Storage.Providers.View') %}
            <a href="{{ url_for('admin.storage_settings') }}" class="pv-card">
              <img class="pv-admin-tile-icon" src="{{ url_for('static', filename='img/admin-icons/storage-providers.png') }}" alt="" loading="lazy" onerror="this.style.display='none'" />
              <div class="pv-admin-tile-head">
                <h2 class="pv-card-title">Storage Providers</h2>
              </div>
              <p class="pv-card-subtitle">Manage storage modules and verify active providers for recordings.</p>
            </a>
          {% endif %}

          {% if has_permission('Nav.Themes.View') %}
            <a href="{{ url_for('admin.themes') }}" class="pv-card">
              <img class="pv-admin-tile-icon" src="{{ url_for('static', filename='img/admin-icons/themes.png') }}" alt="" loading="lazy" onerror="this.style.display='none'" />
              <div class="pv-admin-tile-head">
                <h2 class="pv-card-title">Themes</h2>
              </div>
              <p class="pv-card-subtitle">Select a theme for the main site and a separate theme for the admin area.</p>
            </a>
          {% endif %}

          {% if has_permission('Nav.NetSec.BlockAllow.View') %}
            <a href="{{ url_for('admin.access_control') }}" class="pv-card">
              <img class="pv-admin-tile-icon" src="{{ url_for('static', filename='img/admin-icons/block-allow.png') }}" alt="" loading="lazy" onerror="this.style.display='none'" />
              <div class="pv-admin-tile-head">
                <h2 class="pv-card-title">Block / Allow</h2>
              </div>
              <p class="pv-card-subtitle">Manage IP exemptions, IP blocks, and country access policies.</p>
            </a>
          {% endif %}

          {% if has_permission('Nav.NetSec.BlocklistDistribution.View') %}
            <a href="{{ url_for('admin.blocklist_distribution') }}" class="pv-card">
              <img class="pv-admin-tile-icon" src="{{ url_for('static', filename='img/admin-icons/blocklist-distribution.png') }}" alt="" loading="lazy" onerror="this.style.display='none'" />
              <div class="pv-admin-tile-head">
                <h2 class="pv-card-title">Blocklist Distribution</h2>
              </div>
              <p class="pv-card-subtitle">Configure external blocklist publication and view distribution health.</p>
            </a>
          {% endif %}

          {% if has_permission('Nav.NetSec.BlocklistIntegration.View') %}
            <a href="{{ url_for('admin.blocklist_integration') }}" class="pv-card">
              <img class="pv-admin-tile-icon" src="{{ url_for('static', filename='img/admin-icons/blocklist-integration.png') }}" alt="" loading="lazy" onerror="this.style.display='none'" />
              <div class="pv-admin-tile-head">
                <h2 class="pv-card-title">Blocklist Integration</h2>
              </div>
              <p class="pv-card-subtitle">Configure how blocklist publication is exposed and secured externally.</p>
            </a>
          {% endif %}

          {% if has_permission('Nav.Audit.BlocklistAudit.View') %}
            <a href="{{ url_for('admin.blocklist_audit') }}" class="pv-card">
              <img class="pv-admin-tile-icon" src="{{ url_for('static', filename='img/admin-icons/blocklist-audit.png') }}" alt="" loading="lazy" onerror="this.style.display='none'" />
              <div class="pv-admin-tile-head">
                <h2 class="pv-card-title">Blocklist Audit</h2>
              </div>
              <p class="pv-card-subtitle">Review blocklist generation, enforcement actions, and audit entries.</p>
            </a>
          {% endif %}

          {% if has_permission('Nav.Services.View') %}
            <a href="{{ url_for('admin.services') }}" class="pv-card">
              <img class="pv-admin-tile-icon" src="{{ url_for('static', filename='img/admin-icons/services.png') }}" alt="" loading="lazy" onerror="this.style.display='none'" />
              <div class="pv-admin-tile-head">
                <h2 class="pv-card-title">Services</h2>
              </div>
              <p class="pv-card-subtitle">Restart allowlisted system services and review basic health states.</p>
            </a>
          {% endif %}

          {% if has_permission('Nav.Services.View') and has_permission('Services.Manage') %}
            <a href="#" class="pv-card" id="pvGitPullBtn" data-csrf="{{ csrf_token|default('') }}" data-start-url="{{ git_pull_start_url|default('') }}" role="button">
              <img class="pv-admin-tile-icon" src="{{ url_for('static', filename='img/admin-icons/github-pull.png') }}" alt="" loading="lazy" onerror="this.style.display='none'" />
              <div class="pv-admin-tile-head">
                <h2 class="pv-card-title">Pull GitHub Update</h2>
              </div>
              <p class="pv-card-subtitle">Run scripts/git_pull.sh on the server and watch output live (read-only).</p>
            </a>
          {% endif %}

          {% if has_permission('Nav.Audit.AuditLog.View') %}
            <a href="{{ url_for('admin.audit_alias') }}" class="pv-card">
              <img class="pv-admin-tile-icon" src="{{ url_for('static', filename='img/admin-icons/audit-log.png') }}" alt="" loading="lazy" onerror="this.style.display='none'" />
              <div class="pv-admin-tile-head">
                <h2 class="pv-card-title">Audit Log</h2>
              </div>
              <p class="pv-card-subtitle">Review recent administrative actions and security-related events.</p>
            </a>
          {% endif %}

          {% if has_permission('Nav.Audit.LoginFailures.View') %}
            <a href="{{ url_for('admin.login_failures_list') }}" class="pv-card">
              <img class="pv-admin-tile-icon" src="{{ url_for('static', filename='img/admin-icons/login-failures.png') }}" alt="" loading="lazy" onerror="this.style.display='none'" />
              <div class="pv-admin-tile-head">
                <h2 class="pv-card-title">Login Failures</h2>
              </div>
              <p class="pv-card-subtitle">Review failed login attempts and decrypt attempted passwords (if authorized).</p>
            </a>
          {% endif %}

          {% if has_permission('Nav.Installer.Databases.View') %}
            <a href="{{ url_for('installer.install') }}" class="pv-card">
              <img class="pv-admin-tile-icon" src="{{ url_for('static', filename='img/admin-icons/installer-databases.png') }}" alt="" loading="lazy" onerror="this.style.display='none'" />
              <div class="pv-admin-tile-head">
                <h2 class="pv-card-title">Installer &amp; Databases</h2>
              </div>
              <p class="pv-card-subtitle">Review or adjust database configuration via the installer (when unlocked).</p>
            </a>
          {% endif %}
        </div>
      </div>
    </div>
  </section>

  <script>
    (function () {
      const btn = document.getElementById('pvGitPullBtn');
      if (!btn) return;

      async function startRun() {
        const csrf = btn.getAttribute('data-csrf') || '';
        const startUrl = btn.getAttribute('data-start-url') || '';
        if (!startUrl) {
          alert('Git Pull endpoint not available yet. Please restart pentavision-web after pulling updates.');
          return;
        }
        btn.classList.add('is-disabled');
        try {
          const form = new FormData();
          form.append('csrf_token', csrf);
          const r = await fetch(startUrl, {
            method: 'POST',
            body: form,
            cache: 'no-store'
          });
          const data = await r.json();
          if (!data || !data.ok || !data.view_url) {
            btn.classList.remove('is-disabled');
            alert((data && data.error) ? data.error : 'Failed to start git pull');
            return;
          }
          const w = window.open(data.view_url, 'pvGitPull', 'popup=yes,width=980,height=680');
          if (!w) {
            btn.classList.remove('is-disabled');
            alert('Popup blocked. Please allow popups for this site.');
            return;
          }
          const timer = setInterval(() => {
            if (w.closed) {
              clearInterval(timer);
              btn.classList.remove('is-disabled');
            }
          }, 800);
        } catch (e) {
          btn.classList.remove('is-disabled');
          alert('Failed to start git pull');
        }
      }

      btn.addEventListener('click', function (ev) {
        try { ev.preventDefault(); } catch (e) {}
        if (btn.classList.contains('is-disabled')) return;
        startRun();
      });
    })();
  </script>
{% endblock %}
