{% extends 'base.html' %}

{% block title %}Camera URL Patterns Â· PentaVision{% endblock %}

{% block content %}
  <section class="pv-section">
    <div class="pv-admin-layout">
      {% include 'admin/_nav.html' %}
      <div class="pv-admin-main">
        <div class="pv-page-header">
          <div>
            <h1 class="pv-page-title">Camera URL Patterns</h1>
            <p class="pv-page-subtitle">Manage RTSP URL patterns for different camera manufacturers and models.</p>
          </div>
          <div class="pv-page-actions">
            <a class="pv-button-primary" href="{{ url_for('camera_admin.create_pattern') }}">Add camera pattern</a>
            <form
              method="post"
              action="{{ url_for('camera_admin.import_csv') }}"
              enctype="multipart/form-data"
              class="pv-inline-row"
            >
              <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
              <label class="pv-text-sm">
                Import CSV
                <input type="file" name="file" accept=".csv" required />
              </label>
              <label class="pv-inline-check pv-mr-0">
                <input type="checkbox" name="clear_existing" value="1" />
                <span>Replace existing</span>
              </label>
              <button type="submit" class="pv-button-secondary">Upload</button>
            </form>
          </div>
        </div>

        {% if errors %}
          <div class="pv-alert pv-alert-error">
            <ul>
              {% for error in errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        {% if patterns %}
          <div class="pv-table-wrap">
            <table class="pv-table">
              <thead>
                <tr>
                  <th>Manufacturer</th>
                  <th>Model / Note</th>
                  <th>Device type</th>
                  <th>OUI regex</th>
                  <th>Protocol</th>
                  <th>URL pattern</th>
                  <th>Streams / Channels</th>
                  <th>Defaults</th>
                  <th>Active</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for p in patterns %}
                  <tr>
                    <td>{{ p.manufacturer }}</td>
                    <td>{{ p.model_or_note or '' }}</td>
                    <td>{{ p.device_type or '' }}</td>
                    <td>
                      {% set oui = p.oui_regex or '' %}
                      {% if oui %}
                        <code>{{ oui.replace('|', '<br>')|safe }}</code>
                      {% endif %}
                    </td>
                    <td>{{ p.protocol or 'RTSP' }}</td>
                    <td>
                      <code>{{ p.rtsp_url_pattern }}</code>
                    </td>
                    <td class="pv-minw-14rem">
                      {% if p.streams_raw %}
                        <div><strong>Streams:</strong> {{ p.streams_raw }}</div>
                      {% endif %}
                      {% if p.stream_names_raw %}
                        <div><strong>Names:</strong> {{ p.stream_names_raw }}</div>
                      {% endif %}
                      {% if p.low_res_stream or p.high_res_stream %}
                        <div>
                          <strong>Low/High:</strong>
                          {{ p.low_res_stream or '-' }}/{{ p.high_res_stream or '-' }}
                        </div>
                      {% endif %}
                    </td>
                    <td class="pv-minw-14rem">
                      {% if p.default_port is not none %}
                        <div><strong>Port:</strong> {{ p.default_port }}</div>
                      {% endif %}
                      {% if p.video_encoding %}
                        <div><strong>Codec:</strong> {{ p.video_encoding }}</div>
                      {% endif %}
                      {% if p.default_username or p.default_password %}
                        <div>
                          <strong>Creds:</strong>
                          {{ p.default_username or '' }} / {{ p.default_password or '' }}
                        </div>
                      {% endif %}
                      {% if p.digest_auth_supported %}
                        <div>Digest auth supported</div>
                      {% endif %}
                      {% if p.manual_url %}
                        <div class="pv-ellipsis-cell pv-ellipsis-320">
                          <code>{{ p.manual_url }}</code>
                        </div>
                      {% endif %}
                    </td>
                    <td>{{ 'Yes' if p.is_active else 'No' }}</td>
                    <td class="pv-nowrap">
                      <span class="pv-row-actions">
                        <a href="{{ url_for('camera_admin.edit_pattern', pattern_id=p.id) }}" class="pv-link-muted">Edit</a>
                        <form
                          method="post"
                          action="{{ url_for('camera_admin.delete_pattern', pattern_id=p.id) }}"
                          class="pv-inline-form"
                        >
                          <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                          <button type="submit" class="pv-link-danger">
                            Delete
                          </button>
                        </form>
                      </span>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="pv-empty">
            <img
              class="pv-empty-icon"
              src="{{ url_for('static', filename='img/empty-camera.png') }}"
              alt=""
              loading="lazy"
              onerror="this.style.display='none'"
            />
            <p class="pv-empty-title">No camera URL patterns found</p>
            <p class="pv-empty-subtitle">Add a template to auto-build RTSP URLs for your camera models.</p>
            <div class="pv-empty-actions">
              <a class="pv-button" href="{{ url_for('camera_admin.create_pattern') }}">Add camera pattern</a>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </section>
{% endblock %}
