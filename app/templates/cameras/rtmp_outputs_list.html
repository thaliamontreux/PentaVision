{% extends 'base.html' %}

{% block title %}RTMP Outputs · PentaVision{% endblock %}

{% block content %}
  <section class="pv-section">
    <div class="pv-admin-layout">
      {% include 'admin/_nav.html' %}
      <div class="pv-admin-main">
        <div class="pv-page-header">
          <div>
            <h1 class="pv-page-title">RTMP Outputs</h1>
            <p class="pv-page-subtitle">Manage which cameras are restreamed to RTMP / RTMPS targets.</p>
          </div>
          <div class="pv-page-actions">
            <a class="pv-button-primary" href="{{ url_for('camera_admin.rtmp_create') }}">Add RTMP output</a>
          </div>
        </div>

        {% if errors %}
          <div class="pv-alert pv-alert-error">
            <ul>
              {% for error in errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        {% if outputs %}
          <div class="pv-table-wrap">
            <table class="pv-table">
              <thead>
                <tr>
                  <th>Camera</th>
                  <th>RTMP URL</th>
                  <th>Status</th>
                  <th>Last started</th>
                  <th>Last error</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for row in outputs %}
                  {% set device = devices.get(row.device_id) %}
                  <tr>
                    <td>
                      {% if device %}
                        <a href="{{ url_for('main.camera_detail', device_id=device.id) }}" class="pv-link-muted">
                          {{ device.name }}
                        </a>
                      {% else %}
                        (camera {{ row.device_id }})
                      {% endif %}
                    </td>
                    <td class="pv-ellipsis-cell pv-ellipsis-420">{{ row.target_url }}</td>
                    <td>
                      {% if not row.is_active %}
                        <span class="pv-badge pv-badge-not_configured">Stopped</span>
                      {% elif row.last_error %}
                        <span class="pv-badge pv-badge-error">Error</span>
                      {% elif row.last_started_at %}
                        <span class="pv-badge pv-badge-ok">Running</span>
                      {% else %}
                        <span class="pv-badge pv-badge-not_configured">Pending</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if row.last_started_at %}
                        {{ row.last_started_at }}
                      {% else %}
                        —
                      {% endif %}
                    </td>
                    <td class="pv-ellipsis-cell pv-ellipsis-260">{{ row.last_error or '' }}</td>
                    <td class="pv-nowrap">
                      <span class="pv-row-actions">
                        <a href="{{ url_for('camera_admin.rtmp_edit', output_id=row.id) }}" class="pv-link-muted">Edit</a>

                        {% if row.is_active %}
                          <form
                            method="post"
                            action="{{ url_for('camera_admin.rtmp_stop', output_id=row.id) }}"
                            class="pv-inline-form"
                          >
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                            <button type="submit" class="pv-link-warn">Stop</button>
                          </form>
                          <form
                            method="post"
                            action="{{ url_for('camera_admin.rtmp_restart', output_id=row.id) }}"
                            class="pv-inline-form"
                          >
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                            <button type="submit" class="pv-link-success">Restart</button>
                          </form>
                        {% else %}
                          <form
                            method="post"
                            action="{{ url_for('camera_admin.rtmp_start', output_id=row.id) }}"
                            class="pv-inline-form"
                          >
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                            <button type="submit" class="pv-link-success">Start</button>
                          </form>
                        {% endif %}

                        <form
                          method="post"
                          action="{{ url_for('camera_admin.rtmp_delete', output_id=row.id) }}"
                          class="pv-inline-form"
                        >
                          <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                          <button type="submit" class="pv-link-danger">Delete</button>
                        </form>
                      </span>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="pv-empty">
            <img
              class="pv-empty-icon"
              src="{{ url_for('static', filename='img/empty-live.png') }}"
              alt=""
              loading="lazy"
              onerror="this.style.display='none'"
            />
            <p class="pv-empty-title">No RTMP outputs yet</p>
            <p class="pv-empty-subtitle">Add an RTMP target to restream camera feeds to external platforms.</p>
            <div class="pv-empty-actions">
              <a class="pv-button" href="{{ url_for('camera_admin.rtmp_create') }}">Add RTMP output</a>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </section>
{% endblock %}
