{% extends 'base.html' %}

{% block title %}Session · {{ device.name }} · PentaVision{% endblock %}

{% block content %}
  <section class="pv-section">
    <h1>Session – {{ device.name }}</h1>
    <p class="pv-card-subtitle" style="margin-bottom: 1rem;">
      Live view with quick actions and face recognition overlays.
    </p>

    <div class="pv-dashboard-grid pv-session-grid">
      <div class="pv-card pv-session-left">
        <h2>Live session</h2>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; font-size: 0.85rem;">
          <span style="color: #9ca3af;">Adjust how large the live video appears in your browser.</span>
          <label>
            <span style="margin-right: 0.35rem;">Display size:</span>
            {% set sess_size = session_display_size or '1280x720' %}
            <select id="session-size-select" style="background: rgba(15,23,42,0.9); color: #e5e7eb; border-radius: 999px; border: 1px solid #1f2937; padding: 0.15rem 0.5rem; font-size: 0.8rem;">
              <option value="320x240"{% if sess_size == '320x240' %} selected{% endif %}>320×240</option>
              <option value="720x240"{% if sess_size == '720x240' %} selected{% endif %}>720×240</option>
              <option value="720x480"{% if sess_size == '720x480' %} selected{% endif %}>720×480</option>
              <option value="800x600"{% if sess_size == '800x600' %} selected{% endif %}>800×600</option>
              <option value="1024x768"{% if sess_size == '1024x768' %} selected{% endif %}>1024×768</option>
              <option value="1280x720"{% if sess_size == '1280x720' %} selected{% endif %}>1280×720</option>
              <option value="1920x1080"{% if sess_size == '1920x1080' %} selected{% endif %}>1920×1080</option>
            </select>
          </label>
        </div>
        <div
          class="pv-camera-preview pv-camera-preview-large pv-session-size-{{ sess_size }}"
          data-session-device-id="{{ device.id }}"
          style="position: relative;"
        >
          <img
            src="{{ url_for('main.camera_session_stream', device_id=device.id) }}"
            alt="Live session for {{ device.name }}"
            class="pv-camera-live pv-camera-live-large"
          />
          <canvas
            class="pv-camera-face-overlay"
            id="session-face-overlay"
            style="position: absolute; left: 0; top: 0; width: 100%; height: 100%; pointer-events: none; display: none;"
          ></canvas>
        </div>
        <div class="pv-camera-actions" style="margin-top: 0.75rem;">
          <button
            type="button"
            class="pv-button"
            id="session-face-recognize-btn"
          >
            Recognize faces on current frame
          </button>
          <button
            type="button"
            class="pv-link-muted"
            id="session-fullscreen-btn"
            style="margin-left: 0.75rem;"
          >
            Fullscreen
          </button>
          <a
            href="{{ url_for('main.recordings') }}?device_id={{ device.id }}"
            class="pv-link-muted"
            style="margin-left: 0.75rem;"
          >
            View recordings
          </a>
        </div>
        <p class="pv-card-subtitle" style="margin-top: 0.75rem;">
          Recognition uses the latest cached preview frame for this camera; it does not
          open extra connections to the device.
        </p>
      </div>

      {% if is_system_admin or is_technician %}
        <div class="pv-session-faces-bar">
          <div style="font-size: 0.75rem; font-weight: 500; margin-bottom: 0.25rem;">Faces</div>
          <div id="session-faces-list" class="pv-session-faces-list">
            <p class="pv-card-subtitle" style="font-size: 0.75rem;">
              Run recognition to capture faces that need names.
            </p>
          </div>
          <canvas
            id="session-faces-scratch"
            width="1"
            height="1"
            style="display: none;"
          ></canvas>
          <pre
            id="session-face-output"
            style="display: none;"
            aria-live="polite"
          ></pre>
        </div>
      {% else %}
        <div></div>
      {% endif %}
    </div>

    <div class="pv-status-bar" style="margin-top: 0.9rem;">
      <div class="pv-status-section">
        <span class="pv-status-label">Camera</span>
        <span class="pv-status-kv">
          <span>{{ device.name }}</span>
        </span>
        {% set sess_status = status or 'unknown' %}
        <span class="pv-status-kv">
          <span class="pv-status-chip pv-status-{{ sess_status }}">
            {% if sess_status == 'online' %}
              Online
            {% elif sess_status == 'offline' %}
              Offline
            {% else %}
              Status unknown
            {% endif %}
          </span>
        </span>
      </div>

      <div class="pv-status-section">
        <span class="pv-status-label">Last segment ({{ current_timezone }})</span>
        {% if last_seen %}
          <span class="pv-status-kv">
            <span>{{ last_seen|local_dt }}</span>
          </span>
        {% else %}
          <span class="pv-status-kv">
            <span>Unknown</span>
          </span>
        {% endif %}
        <a
          href="{{ url_for('camera_admin.edit_device', device_id=device.id) }}"
          class="pv-link-muted pv-status-manage-link"
        >
          Configure
        </a>
      </div>
    </div>

    {% if is_system_admin or is_technician %}
      <div id="session-assign-modal" class="pv-modal">
        <div class="pv-modal-dialog">
          <h2 style="margin-top: 0; font-size: 1rem; margin-bottom: 0.5rem;">Assign name to face</h2>
          <img
            id="session-assign-face-img"
            src=""
            alt="Face to assign"
            style="display: block; width: 120px; height: 120px; object-fit: cover; border-radius: 0.75rem; margin: 0.5rem auto 0.75rem;"
          />
          <label style="display: block; font-size: 0.85rem; margin-bottom: 0.35rem;">
            User email
            <input
              id="session-assign-email"
              type="email"
              style="width: 100%; padding: 0.4rem 0.5rem; border-radius: 0.375rem; border: 1px solid #1f2937; background: rgba(15,23,42,0.9); color: #e5e7eb;"
            />
          </label>
          <div style="margin-top: 0.75rem; display: flex; justify-content: flex-end; gap: 0.5rem; font-size: 0.85rem;">
            <button type="button" id="session-assign-cancel" class="pv-link-muted">Cancel</button>
            <button type="button" id="session-assign-save" class="pv-button">Assign</button>
          </div>
        </div>
      </div>
    {% endif %}
  </section>

  <script>
    (function () {
      var deviceId = '{{ device.id }}';
      var recognizeBtn = document.getElementById('session-face-recognize-btn');
      var fullscreenBtn = document.getElementById('session-fullscreen-btn');
      var sizeSelect = document.getElementById('session-size-select');
      var outputEl = document.getElementById('session-face-output');
      var facesListEl = document.getElementById('session-faces-list');
      var scratchCanvas = document.getElementById('session-faces-scratch');
      var assignModal = document.getElementById('session-assign-modal');
      var assignFaceImg = document.getElementById('session-assign-face-img');
      var assignEmailInput = document.getElementById('session-assign-email');
      var assignCancelBtn = document.getElementById('session-assign-cancel');
      var assignSaveBtn = document.getElementById('session-assign-save');
      var pendingFaces = [];
      var currentAssignFaceId = null;

      function setOutput(value) {
        try {
          if (typeof value === 'object') {
            outputEl.textContent = JSON.stringify(value, null, 2);
            return;
          }
        } catch (e) {}
        outputEl.textContent = String(value || '');
      }

      function clearFaceOverlay() {
        var canvas = document.getElementById('session-face-overlay');
        if (!canvas) {
          return;
        }
        var ctx = canvas.getContext('2d');
        if (!ctx) {
          return;
        }
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        canvas.style.display = 'none';
      }

      function drawFaceOverlay(faces, imageWidth, imageHeight) {
        var container = document.querySelector('[data-session-device-id]');
        if (!container) {
          return;
        }
        var img = container.querySelector('.pv-camera-live');
        var canvas = document.getElementById('session-face-overlay');
        if (!img || !canvas) {
          return;
        }

        var w = img.clientWidth || img.naturalWidth || 0;
        var h = img.clientHeight || img.naturalHeight || 0;
        if (!w || !h || !imageWidth || !imageHeight) {
          return;
        }

        canvas.width = w;
        canvas.height = h;
        var ctx = canvas.getContext('2d');
        if (!ctx) {
          return;
        }
        ctx.clearRect(0, 0, w, h);
        ctx.strokeStyle = '#22c55e';
        ctx.lineWidth = 2;
        ctx.font = '11px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
        ctx.fillStyle = 'rgba(34,197,94,0.7)';

        var scaleX = w / imageWidth;
        var scaleY = h / imageHeight;

        faces.forEach(function (face) {
          var top = face.top;
          var right = face.right;
          var bottom = face.bottom;
          var left = face.left;
          var label = face.email || (face.user_id != null ? ('ID ' + face.user_id) : 'Unknown');
          var distance = typeof face.distance === 'number' ? face.distance.toFixed(2) : null;

          var x = left * scaleX;
          var y = top * scaleY;
          var fw = (right - left) * scaleX;
          var fh = (bottom - top) * scaleY;

          ctx.strokeRect(x, y, fw, fh);
          var text = label + (distance ? (' [' + distance + ']') : '');
          var tw = ctx.measureText(text).width + 6;
          var th = 14;
          ctx.fillRect(x, y - th, tw, th);
          ctx.fillStyle = '#0b1120';
          ctx.fillText(text, x + 3, y - 3);
          ctx.fillStyle = 'rgba(34,197,94,0.7)';
        });

        canvas.style.display = 'block';
        window.setTimeout(function () {
          clearFaceOverlay();
        }, 2500);
      }

      function toggleFullscreen() {
        var container = document.querySelector('[data-session-device-id]');
        if (!container) {
          return;
        }
        if (!document.fullscreenElement) {
          if (container.requestFullscreen) {
            container.requestFullscreen();
          }
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          }
        }
      }

      if (fullscreenBtn) {
        fullscreenBtn.addEventListener('click', function () {
          toggleFullscreen();
        });
      }

      function applySessionSize(size) {
        var container = document.querySelector('[data-session-device-id]');
        if (!container) return;
        var allClasses = [
          'pv-session-size-320x240',
          'pv-session-size-720x240',
          'pv-session-size-720x480',
          'pv-session-size-800x600',
          'pv-session-size-1024x768',
          'pv-session-size-1280x720',
          'pv-session-size-1920x1080'
        ];
        allClasses.forEach(function (cls) { container.classList.remove(cls); });
        container.classList.add('pv-session-size-' + size);
      }

      if (sizeSelect) {
        sizeSelect.addEventListener('change', function () {
          var size = String(sizeSelect.value || '').toLowerCase();
          if (!size) return;
          applySessionSize(size);
          try {
            fetch('/api/user/display-size', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'same-origin',
              body: JSON.stringify({ scope: 'session', size: size }),
            }).catch(function () {});
          } catch (e) {}
        });
      }

      function renderFaces() {
        if (!facesListEl) return;
        facesListEl.innerHTML = '';
        if (!pendingFaces.length) {
          var empty = document.createElement('p');
          empty.className = 'pv-card-subtitle';
          empty.style.fontSize = '0.75rem';
          empty.textContent = 'No unnamed faces yet.';
          facesListEl.appendChild(empty);
          return;
        }

        pendingFaces.forEach(function (face) {
          var tile = document.createElement('div');
          tile.className = 'pv-session-face-tile';

          var img = document.createElement('img');
          img.className = 'pv-session-face-img';
          img.src = face.image;
          img.alt = 'Captured face';
          tile.appendChild(img);

          var btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'pv-link-muted pv-session-face-assign';
          btn.textContent = 'Assign';
          btn.addEventListener('click', function () {
            openAssignModal(face.id);
          });
          tile.appendChild(btn);

          facesListEl.appendChild(tile);
        });
      }

      function openAssignModal(faceId) {
        if (!assignModal || !assignFaceImg || !assignEmailInput) return;
        var face = pendingFaces.find(function (f) { return f.id === faceId; });
        if (!face) return;
        currentAssignFaceId = faceId;
        assignFaceImg.src = face.image;
        assignEmailInput.value = '';
        assignModal.classList.add('is-visible');
        assignEmailInput.focus();
      }

      function closeAssignModal() {
        if (!assignModal) return;
        assignModal.classList.remove('is-visible');
        currentAssignFaceId = null;
      }

      function saveAssignedFace() {
        if (!currentAssignFaceId) {
          closeAssignModal();
          return;
        }
        var face = pendingFaces.find(function (f) { return f.id === currentAssignFaceId; });
        if (!face) {
          closeAssignModal();
          return;
        }
        var email = (assignEmailInput && assignEmailInput.value || '').trim().toLowerCase();
        if (!email) {
          return;
        }

        try {
          fetch('/api/face/enroll', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ email: email, image: face.image }),
          })
            .then(function (resp) { return resp.json(); })
            .then(function () {
              pendingFaces = pendingFaces.filter(function (f) { return f.id !== face.id; });
              renderFaces();
              closeAssignModal();
            })
            .catch(function () {
              closeAssignModal();
            });
        } catch (e) {
          closeAssignModal();
        }
      }

      if (assignCancelBtn) {
        assignCancelBtn.addEventListener('click', function () {
          closeAssignModal();
        });
      }

      if (assignSaveBtn) {
        assignSaveBtn.addEventListener('click', function () {
          saveAssignedFace();
        });
      }

      if (assignEmailInput) {
        assignEmailInput.addEventListener('keydown', function (evt) {
          if (evt.key === 'Enter') {
            evt.preventDefault();
            saveAssignedFace();
          }
        });
      }

      function loadPreviewImageForFaces(callback) {
        if (!scratchCanvas || typeof Image === 'undefined') {
          callback(new Error('unavailable'), null);
          return;
        }
        var url = '{{ url_for('main.camera_preview_low_jpeg', device_id=device.id) }}?ts=' + Date.now();
        var img = new Image();
        img.onload = function () { callback(null, img); };
        img.onerror = function () { callback(new Error('failed'), null); };
        img.src = url;
      }

      function addUnknownFacesFromResult(data) {
        if (!facesListEl || !scratchCanvas) return;
        if (!data || !Array.isArray(data.faces) || !data.faces.length) return;

        var faces = data.faces;
        var imageWidth = data.image_width || 0;
        var imageHeight = data.image_height || 0;
        if (!imageWidth || !imageHeight) return;

        loadPreviewImageForFaces(function (err, img) {
          if (err || !img) return;
          var ctx = scratchCanvas.getContext('2d');
          if (!ctx) return;
          scratchCanvas.width = imageWidth;
          scratchCanvas.height = imageHeight;
          ctx.clearRect(0, 0, imageWidth, imageHeight);
          ctx.drawImage(img, 0, 0, imageWidth, imageHeight);

          faces.forEach(function (face) {
            if (face.user_id != null || (face.email && String(face.email).length)) {
              return;
            }
            var left = face.left;
            var top = face.top;
            var right = face.right;
            var bottom = face.bottom;
            var w = right - left;
            var h = bottom - top;
            if (!w || !h || w < 4 || h < 4) {
              return;
            }
            var faceCanvas = document.createElement('canvas');
            faceCanvas.width = w;
            faceCanvas.height = h;
            var fctx = faceCanvas.getContext('2d');
            if (!fctx) {
              return;
            }
            fctx.drawImage(
              scratchCanvas,
              left,
              top,
              w,
              h,
              0,
              0,
              w,
              h
            );
            var dataUrl;
            try {
              dataUrl = faceCanvas.toDataURL('image/jpeg');
            } catch (e) {
              dataUrl = null;
            }
            if (!dataUrl) {
              return;
            }
            var exists = pendingFaces.some(function (f) { return f.image === dataUrl; });
            if (exists) {
              return;
            }
            pendingFaces.push({
              id: 'face-' + Date.now() + '-' + pendingFaces.length,
              image: dataUrl,
            });
          });

          renderFaces();
        });
      }

      if (recognizeBtn) {
        recognizeBtn.addEventListener('click', function () {
          var originalText = recognizeBtn.textContent;
          recognizeBtn.disabled = true;
          recognizeBtn.textContent = 'Recognizing…';
          clearFaceOverlay();

          fetch('/api/cameras/' + deviceId + '/face-recognize', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: '{}',
          })
            .then(function (resp) { return resp.json(); })
            .then(function (data) {
              setOutput(data);
              if (data && Array.isArray(data.faces) && data.faces.length) {
                drawFaceOverlay(
                  data.faces,
                  data.image_width || 0,
                  data.image_height || 0
                );
                addUnknownFacesFromResult(data);
              } else {
                clearFaceOverlay();
              }
              recognizeBtn.disabled = false;
              recognizeBtn.textContent = originalText;
            })
            .catch(function (err) {
              setOutput(String(err));
              clearFaceOverlay();
              recognizeBtn.disabled = false;
              recognizeBtn.textContent = originalText;
            });
        });
      }
    })();
  </script>
{% endblock %}
