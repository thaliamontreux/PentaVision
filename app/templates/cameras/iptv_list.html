{% extends 'base.html' %}

{% block title %}IPTV Channels · PentaVision{% endblock %}

{% block content %}
  <section class="pv-section">
    <div class="pv-admin-layout">
      {% include 'admin/_nav.html' %}
      <div class="pv-admin-main">
        <div class="pv-page-header">
          <div>
            <h1 class="pv-page-title">IPTV Channels</h1>
            <p class="pv-page-subtitle">Broadcast camera feeds as MPEG-TS multicast streams for TVs.</p>
          </div>
          <div class="pv-page-actions">
            <a
              class="pv-button-primary"
              href="{{ url_for('camera_admin.iptv_edit', channel_id=0) }}"
            >
              Add IPTV channel
            </a>
          </div>
        </div>

    {% if errors %}
      <div class="pv-alert pv-alert-error">
        <ul>
          {% for error in errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
        {% if channels %}
          <div class="pv-table-wrap">
            <table class="pv-table">
          <thead>
            <tr>
              <th>Camera</th>
              <th>Channel name</th>
              <th>Multicast address</th>
              <th>Port</th>
              <th>TTL</th>
              <th>Enabled</th>
              <th>Last started</th>
              <th>Last error</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for row in channels %}
              {% set device = devices.get(row.device_id) if devices else None %}
              <tr>
                <td>
                  {% if device %}
                    <a
                      href="{{ url_for('main.camera_detail', device_id=device.id) }}"
                      class="pv-link-muted"
                    >
                      {{ device.name }}
                    </a>
                  {% else %}
                    (camera {{ row.device_id }})
                  {% endif %}
                </td>
                <td>
                  {% if row.channel_name %}
                    {{ row.channel_name }}
                  {% elif device %}
                    {{ device.name }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td>{{ row.multicast_address }}</td>
                <td>{{ row.port }}</td>
                <td>{{ row.ttl or '' }}</td>
                <td>
                  {% if row.is_enabled %}
                    Yes
                  {% else %}
                    No
                  {% endif %}
                </td>
                <td>
                  {% if row.last_started_at %}
                    {{ row.last_started_at }}
                  {% else %}
                    —
                  {% endif %}
                </td>
                <td class="pv-ellipsis-cell pv-ellipsis-260">
                  {{ row.last_error or '' }}
                </td>
                <td class="pv-nowrap">
                  <a href="{{ url_for('camera_admin.iptv_edit', channel_id=row.id) }}" class="pv-link-muted">Edit</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
            </table>
          </div>
        {% else %}
          <div class="pv-empty">
            <img
              class="pv-empty-icon"
              src="{{ url_for('static', filename='img/empty-live.png') }}"
              alt=""
              loading="lazy"
              onerror="this.style.display='none'"
            />
            <p class="pv-empty-title">No IPTV channels yet</p>
            <p class="pv-empty-subtitle">Add a multicast channel to broadcast a camera feed to TVs.</p>
            <div class="pv-empty-actions">
              <a class="pv-button" href="{{ url_for('camera_admin.iptv_edit', channel_id=0) }}">Add IPTV channel</a>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </section>
{% endblock %}
