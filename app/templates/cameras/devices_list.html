{% extends 'base.html' %}

{% block title %}Cameras Â· PentaVision{% endblock %}

{% block content %}
  <section class="pv-section">
    <div class="pv-admin-layout">
      {% include 'admin/_nav.html' %}
      <div class="pv-admin-main">
        <div class="pv-page-header">
          <div>
            <h1 class="pv-page-title">Installed Cameras</h1>
            <p class="pv-page-subtitle">Configure individual cameras using the URL templates defined in the Camera URL Patterns list.</p>
          </div>
          <div class="pv-page-actions">
            <a class="pv-button-primary" href="{{ url_for('camera_admin.create_device') }}">Add camera</a>
            <a
              class="pv-button-secondary"
              href="{{ url_for('camera_admin.scan') }}"
              onclick="window.open(this.href, 'pvScan', 'width=960,height=720,resizable=yes,scrollbars=yes'); return false;"
            >
              Scan network
            </a>
          </div>
        </div>

        {% if errors %}
          <div class="pv-alert pv-alert-error">
            <ul>
              {% for error in errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        {% if devices %}
          <div class="pv-table-wrap">
            <table class="pv-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>IP</th>
                  <th>Port</th>
                  <th>Template</th>
                  <th>Protocol</th>
                  <th>Active</th>
                  <th>RTMP</th>
                  <th>Stream status</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for d in devices %}
                  {% set pat = patterns.get(d.pattern_id) %}
                  <tr>
                    <td>
                      <a href="{{ url_for('main.camera_detail', device_id=d.id) }}" class="pv-link-muted">
                        {{ d.name }}
                      </a>
                    </td>
                    <td>{{ d.ip_address }}</td>
                    <td>{{ d.port or '' }}</td>
                    <td>
                      {% if pat %}
                        {{ pat.manufacturer }} {{ pat.model_or_note or '' }}
                      {% else %}
                        (none)
                      {% endif %}
                    </td>
                    <td>{% if pat %}{{ pat.protocol or 'RTSP' }}{% else %}{% endif %}</td>
                    <td>
                      {% if d.is_active %}
                        <span class="pv-badge pv-badge-ok">Active</span>
                      {% else %}
                        <span class="pv-badge pv-badge-not_configured">Inactive</span>
                      {% endif %}
                    </td>
                    <td>
                      {% set rtmp = rtmp_status.get(d.id) if rtmp_status else None %}
                      {% if rtmp and rtmp.active %}
                        <span class="pv-badge pv-badge-ok">{{ rtmp.active }} / {{ rtmp.total }} active</span>
                      {% elif rtmp %}
                        <span class="pv-badge pv-badge-not_configured">0 / {{ rtmp.total }} active</span>
                      {% else %}
                        <span class="pv-badge pv-badge-not_configured">None</span>
                      {% endif %}
                    </td>
                    <td>
                      {% set info = stream_status.get(d.id) if stream_status else None %}
                      {% if d.is_active and info and info.permanent_failure %}
                        <span class="pv-badge pv-badge-error" title="{{ info.last_error.message if info.last_error else '' }}">Needs attention</span>
                      {% elif d.is_active %}
                        <span class="pv-badge pv-badge-ok">OK</span>
                      {% else %}
                        <span class="pv-badge pv-badge-not_configured">Inactive</span>
                      {% endif %}
                    </td>
                    <td>
                      <span class="pv-row-actions">
                      <a
                        href="{{ url_for('camera_admin.rtmp_create') }}?device_id={{ d.id }}"
                        class="pv-link-muted"
                      >
                        RTMP
                      </a>
                      <a href="{{ url_for('camera_admin.edit_device', device_id=d.id) }}" class="pv-link-muted">Edit</a>
                      <form
                        method="post"
                        action="{{ url_for('camera_admin.delete_device', device_id=d.id) }}"
                        class="pv-inline-form"
                      >
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                        <button type="submit" class="pv-link-danger">
                          Delete
                        </button>
                      </form>
                      </span>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="pv-empty">
            <img
              class="pv-empty-icon"
              src="{{ url_for('static', filename='img/empty-camera.png') }}"
              alt=""
              loading="lazy"
              onerror="this.style.display='none'"
            />
            <p class="pv-empty-title">No cameras configured yet</p>
            <p class="pv-empty-subtitle">Add a camera to enable live viewing and recording.</p>
            <div class="pv-empty-actions">
              <a class="pv-button" href="{{ url_for('camera_admin.create_device') }}">Add camera</a>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </section>
{% endblock %}
