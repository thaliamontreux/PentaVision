{% extends 'base.html' %}

{% block title %}Cameras Â· PentaVision{% endblock %}

{% block content %}
  <section class="pv-section">
    <h1>Installed Cameras</h1>
    <p>Configure individual cameras using the URL templates defined in the Camera URL Patterns list.</p>

    {% if errors %}
      <div class="pv-alert pv-alert-error">
        <ul>
          {% for error in errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <div style="margin-bottom: 1rem;">
      <a class="pv-button-primary" href="{{ url_for('camera_admin.create_device') }}">
        Add camera
      </a>
      <a
        class="pv-button-primary"
        href="{{ url_for('camera_admin.scan') }}"
        style="margin-left: 0.5rem;"
        onclick="window.open(this.href, 'pvScan', 'width=960,height=720,resizable=yes,scrollbars=yes'); return false;"
      >
        Scan network
      </a>
    </div>

    {% if devices %}
      <div style="overflow-x: auto;">
        <table class="pv-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>IP</th>
              <th>Port</th>
              <th>Template</th>
              <th>Protocol</th>
              <th>Active</th>
              <th>Stream status</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for d in devices %}
              {% set pat = patterns.get(d.pattern_id) %}
              <tr>
                <td>
                  <a href="{{ url_for('main.camera_detail', device_id=d.id) }}" class="pv-link-muted">
                    {{ d.name }}
                  </a>
                </td>
                <td>{{ d.ip_address }}</td>
                <td>{{ d.port or '' }}</td>
                <td>
                  {% if pat %}
                    {{ pat.manufacturer }} {{ pat.model_or_note or '' }}
                  {% else %}
                    (none)
                  {% endif %}
                </td>
                <td>{% if pat %}{{ pat.protocol or 'RTSP' }}{% else %}{% endif %}</td>
                <td>{{ 'Yes' if d.is_active else 'No' }}</td>
                <td>
                  {% set info = stream_status.get(d.id) if stream_status else None %}
                  {% if d.is_active and info and info.permanent_failure %}
                    <span
                      style="color: #dc2626; font-weight: 600;"
                      title="{{ info.last_error.message if info.last_error else '' }}"
                    >
                      Needs attention
                    </span>
                  {% elif d.is_active %}
                    <span style="color: #16a34a;">OK</span>
                  {% else %}
                    <span style="color: #6b7280;">Inactive</span>
                  {% endif %}
                </td>
                <td style="white-space: nowrap;">
                  <a href="{{ url_for('camera_admin.edit_device', device_id=d.id) }}">Edit</a>
                  <form
                    method="post"
                    action="{{ url_for('camera_admin.delete_device', device_id=d.id) }}"
                    style="display: inline; margin-left: 0.5rem;"
                  >
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                    <button type="submit" style="background: none; border: none; color: #fca5a5; cursor: pointer;">
                      Delete
                    </button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p>No cameras configured yet.</p>
    {% endif %}
  </section>
{% endblock %}
