{% extends 'base.html' %}

{% block title %}Cameras Â· PentaVision{% endblock %}

{% block content %}
  <section class="pv-section">
    <div class="pv-admin-layout">
      {% include 'admin/_nav.html' %}
      <div class="pv-admin-main">
        <div class="pv-page-header">
          <div>
            <h1 class="pv-page-title">Installed Cameras</h1>
            <p class="pv-page-subtitle">Configure individual cameras using the URL templates defined in the Camera URL Patterns list.</p>
          </div>
          <div class="pv-page-actions">
            <a class="pv-button-primary" href="{{ url_for('camera_admin.create_device') }}">Add camera</a>
            <a
              class="pv-button-secondary"
              href="{{ url_for('camera_admin.scan') }}"
              onclick="window.open(this.href, 'pvScan', 'width=960,height=720,resizable=yes,scrollbars=yes'); return false;"
            >
              Scan network
            </a>
          </div>
        </div>

        {% if all_groups or all_tags %}
          <div class="pv-camera-filters">
            {% if all_groups %}
              <div class="pv-filter-group">
                <label>Filter by Group:</label>
                <select onchange="window.location.href='{{ url_for('camera_admin.list_devices') }}?group=' + this.value + (new URLSearchParams(window.location.search).get('tag') ? '&tag=' + new URLSearchParams(window.location.search).get('tag') : '')">
                  <option value="">All Groups</option>
                  {% for group in all_groups %}
                    <option value="{{ group.id }}" {% if filter_group_id == group.id|string %}selected{% endif %}>{{ group.name }}</option>
                  {% endfor %}
                </select>
              </div>
            {% endif %}
            {% if all_tags %}
              <div class="pv-filter-group">
                <label>Filter by Tag:</label>
                <select onchange="window.location.href='{{ url_for('camera_admin.list_devices') }}?tag=' + this.value + (new URLSearchParams(window.location.search).get('group') ? '&group=' + new URLSearchParams(window.location.search).get('group') : '')">
                  <option value="">All Tags</option>
                  {% for tag in all_tags %}
                    <option value="{{ tag.id }}" {% if filter_tag_id == tag.id|string %}selected{% endif %}>{{ tag.name }}</option>
                  {% endfor %}
                </select>
              </div>
            {% endif %}
            {% if filter_group_id or filter_tag_id %}
              <a href="{{ url_for('camera_admin.list_devices') }}" class="pv-button pv-button-sm pv-button-secondary">Clear Filters</a>
            {% endif %}
          </div>
        {% endif %}

        {% if devices %}
          <div class="pv-bulk-actions" id="bulk-actions" style="display: none;">
            <span class="pv-bulk-actions-label">
              <span id="selected-count">0</span> camera(s) selected
            </span>
            <button type="button" class="pv-button pv-button-sm" onclick="bulkEnable()">Enable Selected</button>
            <button type="button" class="pv-button pv-button-sm" onclick="bulkDisable()">Disable Selected</button>
            {% if all_groups %}
              <button type="button" class="pv-button pv-button-sm" onclick="showBulkGroupModal()">Assign to Group</button>
            {% endif %}
            {% if all_tags %}
              <button type="button" class="pv-button pv-button-sm" onclick="showBulkTagModal()">Assign Tags</button>
            {% endif %}
            <button type="button" class="pv-button pv-button-sm pv-button-secondary" onclick="clearSelection()">Clear Selection</button>
          </div>
        {% endif %}

        {% if errors %}
          <div class="pv-alert pv-alert-error">
            <ul>
              {% for error in errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        {% if devices %}
          <div class="pv-table-wrap">
            <table class="pv-table">
              <thead>
                <tr>
                  <th style="width: 40px;">
                    <input type="checkbox" id="select-all" onchange="toggleSelectAll(this)" />
                  </th>
                  <th>Name</th>
                  <th>IP</th>
                  <th>Port</th>
                  <th>Template</th>
                  <th>Protocol</th>
                  <th>Active</th>
                  <th>RTMP</th>
                  <th>Stream status</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for d in devices %}
                  {% set pat = patterns.get(d.pattern_id) %}
                  <tr>
                    <td>
                      <input type="checkbox" class="camera-checkbox" data-camera-id="{{ d.id }}" onchange="updateBulkActions()" />
                    </td>
                    <td>
                      <a href="{{ url_for('main.camera_detail', device_id=d.id) }}" class="pv-link-muted">
                        {{ d.name }}
                      </a>
                      {% if camera_groups.get(d.id) or camera_tags.get(d.id) %}
                        <div class="pv-camera-badges">
                          {% for group in camera_groups.get(d.id, []) %}
                            <span class="pv-camera-group-badge">
                              <span class="pv-camera-group-indicator" style="background: {{ group.color or '#64748b' }};"></span>
                              {{ group.name }}
                            </span>
                          {% endfor %}
                          {% for tag in camera_tags.get(d.id, []) %}
                            <span class="pv-tag-badge" style="background: {{ tag.color or '#64748b' }}; font-size: 0.75rem; padding: 0.125rem 0.5rem;">{{ tag.name }}</span>
                          {% endfor %}
                        </div>
                      {% endif %}
                    </td>
                    <td>{{ d.ip_address }}</td>
                    <td>{{ d.port or '' }}</td>
                    <td>
                      {% if pat %}
                        {{ pat.manufacturer }} {{ pat.model_or_note or '' }}
                      {% else %}
                        (none)
                      {% endif %}
                    </td>
                    <td>{% if pat %}{{ pat.protocol or 'RTSP' }}{% else %}{% endif %}</td>
                    <td>
                      {% if d.is_active %}
                        <span class="pv-badge pv-badge-ok">Active</span>
                      {% else %}
                        <span class="pv-badge pv-badge-not_configured">Inactive</span>
                      {% endif %}
                    </td>
                    <td>
                      {% set rtmp = rtmp_status.get(d.id) if rtmp_status else None %}
                      {% if rtmp and rtmp.active %}
                        <span class="pv-badge pv-badge-ok">{{ rtmp.active }} / {{ rtmp.total }} active</span>
                      {% elif rtmp %}
                        <span class="pv-badge pv-badge-not_configured">0 / {{ rtmp.total }} active</span>
                      {% else %}
                        <span class="pv-badge pv-badge-not_configured">None</span>
                      {% endif %}
                    </td>
                    <td>
                      {% set info = stream_status.get(d.id) if stream_status else None %}
                      {% if d.is_active and info and info.permanent_failure %}
                        <span class="pv-badge pv-badge-error" title="{{ info.last_error.message if info.last_error else '' }}">Needs attention</span>
                      {% elif d.is_active %}
                        <span class="pv-badge pv-badge-ok">OK</span>
                      {% else %}
                        <span class="pv-badge pv-badge-not_configured">Inactive</span>
                      {% endif %}
                    </td>
                    <td>
                      <span class="pv-row-actions">
                      <a
                        href="{{ url_for('camera_admin.rtmp_create') }}?device_id={{ d.id }}"
                        class="pv-link-muted"
                      >
                        RTMP
                      </a>
                      <a href="{{ url_for('camera_admin.edit_device', device_id=d.id) }}" class="pv-link-muted">Edit</a>
                      <form
                        method="post"
                        action="{{ url_for('camera_admin.delete_device', device_id=d.id) }}"
                        class="pv-inline-form"
                      >
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />
                        <button type="submit" class="pv-link-danger">
                          Delete
                        </button>
                      </form>
                      </span>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="pv-empty">
            <img
              class="pv-empty-icon"
              src="{{ url_for('static', filename='img/empty-camera.png') }}"
              alt=""
              loading="lazy"
              onerror="this.style.display='none'"
            />
            <p class="pv-empty-title">No cameras configured yet</p>
            <p class="pv-empty-subtitle">Add a camera to enable live viewing and recording.</p>
            <div class="pv-empty-actions">
              <a class="pv-button" href="{{ url_for('camera_admin.create_device') }}">Add camera</a>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </section>

  <script>
    function toggleSelectAll(checkbox) {
      const checkboxes = document.querySelectorAll('.camera-checkbox');
      checkboxes.forEach(cb => cb.checked = checkbox.checked);
      updateBulkActions();
    }

    function updateBulkActions() {
      const checkboxes = document.querySelectorAll('.camera-checkbox:checked');
      const count = checkboxes.length;
      const bulkActions = document.getElementById('bulk-actions');
      const countSpan = document.getElementById('selected-count');
      
      if (count > 0) {
        bulkActions.style.display = 'flex';
        countSpan.textContent = count;
      } else {
        bulkActions.style.display = 'none';
        document.getElementById('select-all').checked = false;
      }
    }

    function clearSelection() {
      document.querySelectorAll('.camera-checkbox').forEach(cb => cb.checked = false);
      document.getElementById('select-all').checked = false;
      updateBulkActions();
    }

    function getSelectedCameraIds() {
      const checkboxes = document.querySelectorAll('.camera-checkbox:checked');
      return Array.from(checkboxes).map(cb => cb.dataset.cameraId);
    }

    function bulkEnable() {
      const cameraIds = getSelectedCameraIds();
      if (cameraIds.length === 0) return;
      
      if (!confirm(`Enable ${cameraIds.length} camera(s)?`)) return;
      
      fetch('{{ url_for("camera_admin.bulk_update") }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
          camera_ids: cameraIds,
          action: 'enable'
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast(`Successfully enabled ${data.updated} camera(s)`);
          setTimeout(() => location.reload(), 1000);
        } else {
          showToast(data.error || 'Failed to enable cameras');
        }
      })
      .catch(error => {
        showToast('Error: ' + error.message);
      });
    }

    function bulkDisable() {
      const cameraIds = getSelectedCameraIds();
      if (cameraIds.length === 0) return;
      
      if (!confirm(`Disable ${cameraIds.length} camera(s)?`)) return;
      
      fetch('{{ url_for("camera_admin.bulk_update") }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
          camera_ids: cameraIds,
          action: 'disable'
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast(`Successfully disabled ${data.updated} camera(s)`);
          setTimeout(() => location.reload(), 1000);
        } else {
          showToast(data.error || 'Failed to disable cameras');
        }
      })
      .catch(error => {
        showToast('Error: ' + error.message);
      });
    }

    function showToast(message) {
      const toast = document.getElementById('pv-global-toast');
      if (toast) {
        toast.textContent = message;
        toast.style.display = 'block';
        setTimeout(() => {
          toast.style.display = 'none';
        }, 10000);
      }
    }

    function showBulkGroupModal() {
      const modal = document.getElementById('bulk-group-modal');
      if (modal) modal.classList.add('is-visible');
    }

    function showBulkTagModal() {
      const modal = document.getElementById('bulk-tag-modal');
      if (modal) modal.classList.add('is-visible');
    }

    function closeBulkGroupModal() {
      const modal = document.getElementById('bulk-group-modal');
      if (modal) modal.classList.remove('is-visible');
    }

    function closeBulkTagModal() {
      const modal = document.getElementById('bulk-tag-modal');
      if (modal) modal.classList.remove('is-visible');
    }

    function bulkAssignGroup() {
      const cameraIds = getSelectedCameraIds();
      const groupId = document.getElementById('bulk-group-select').value;
      
      if (cameraIds.length === 0 || !groupId) return;
      
      fetch('{{ url_for("camera_admin.bulk_assign_group") }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
          camera_ids: cameraIds,
          group_id: parseInt(groupId)
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast(`Successfully assigned ${data.updated} camera(s) to group`);
          closeBulkGroupModal();
          setTimeout(() => location.reload(), 1000);
        } else {
          showToast(data.error || 'Failed to assign cameras to group');
        }
      })
      .catch(error => {
        showToast('Error: ' + error.message);
      });
    }

    function bulkAssignTags() {
      const cameraIds = getSelectedCameraIds();
      const checkboxes = document.querySelectorAll('#bulk-tag-form input[type="checkbox"]:checked');
      const tagIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
      
      if (cameraIds.length === 0 || tagIds.length === 0) {
        showToast('Please select at least one tag');
        return;
      }
      
      fetch('{{ url_for("camera_admin.bulk_assign_tags") }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
          camera_ids: cameraIds,
          tag_ids: tagIds
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast(`Successfully assigned tags to ${data.updated} camera(s)`);
          closeBulkTagModal();
          setTimeout(() => location.reload(), 1000);
        } else {
          showToast(data.error || 'Failed to assign tags to cameras');
        }
      })
      .catch(error => {
        showToast('Error: ' + error.message);
      });
    }
  </script>

  <!-- Bulk Group Assignment Modal -->
  {% if all_groups %}
  <div class="pv-modal" id="bulk-group-modal">
    <div class="pv-modal-dialog">
      <div class="pv-modal-header">
        <div>
          <div class="pv-card-title">Assign to Group</div>
          <div class="pv-card-subtitle">Select a group to assign the selected cameras to.</div>
        </div>
        <button type="button" class="pv-button pv-button-small" onclick="closeBulkGroupModal()">Close</button>
      </div>
      <div class="pv-modal-body">
        <div class="pv-field-group">
          <label for="bulk-group-select">Group</label>
          <select id="bulk-group-select" class="pv-input">
            <option value="">Select a group...</option>
            {% for group in all_groups %}
              <option value="{{ group.id }}">{{ group.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="pv-mt-2">
          <button type="button" class="pv-button" onclick="bulkAssignGroup()">Assign to Group</button>
          <button type="button" class="pv-button pv-button-secondary" onclick="closeBulkGroupModal()">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Bulk Tag Assignment Modal -->
  {% if all_tags %}
  <div class="pv-modal" id="bulk-tag-modal">
    <div class="pv-modal-dialog">
      <div class="pv-modal-header">
        <div>
          <div class="pv-card-title">Assign Tags</div>
          <div class="pv-card-subtitle">Select tags to assign to the selected cameras.</div>
        </div>
        <button type="button" class="pv-button pv-button-small" onclick="closeBulkTagModal()">Close</button>
      </div>
      <div class="pv-modal-body">
        <form id="bulk-tag-form">
          <div class="pv-checkbox-group">
            {% for tag in all_tags %}
              <label class="pv-checkbox-label">
                <input type="checkbox" value="{{ tag.id }}" />
                <span class="pv-tag-badge" style="background: {{ tag.color or '#64748b' }};">{{ tag.name }}</span>
              </label>
            {% endfor %}
          </div>
        </form>
        <div class="pv-mt-2">
          <button type="button" class="pv-button" onclick="bulkAssignTags()">Assign Tags</button>
          <button type="button" class="pv-button pv-button-secondary" onclick="closeBulkTagModal()">Cancel</button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
{% endblock %}
