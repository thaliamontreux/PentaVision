{% extends 'base.html' %}

{% block title %}Scan Network · Cameras · PentaVision{% endblock %}

{% block content %}
  <section class="pv-section">
    <div class="pv-admin-layout">
      {% include 'admin/_nav.html' %}
      <div class="pv-admin-main">
        <div class="pv-page-header">
          <div>
            <h1 class="pv-page-title">Scan for Network Cameras</h1>
            <p class="pv-page-subtitle">
              Enter a network to scan for RTSP-compatible cameras. Discovered cameras will be
              added automatically with generic names (CAM1, CAM2, ...).
            </p>
          </div>
        </div>

        {% if errors %}
          <div class="pv-alert pv-alert-error">
            <ul>
              {% for error in errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        {% if messages %}
          <div class="pv-alert pv-alert-success">
            <ul>
              {% for msg in messages %}
                <li>{{ msg }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        <form id="scan-form" method="post" class="pv-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />

      <div class="pv-field-group">
        <label for="base_ip">Base IP address</label>
        <input
          id="base_ip"
          name="base_ip"
          type="text"
          value="{{ form.base_ip }}"
          placeholder="192.168.1.0"
        />
      </div>

      <div class="pv-field-group">
        <label for="prefix">Subnet mask (CIDR prefix)</label>
        <select id="prefix" name="prefix">
          {% for n in range(16, 33) %}
            <option value="{{ n }}" {% if form.prefix|int == n %}selected{% endif %}>/{{ n }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="pv-field-group">
        <label for="extra_ports">Additional ports (comma-separated)</label>
        <input
          id="extra_ports"
          name="extra_ports"
          type="text"
          value="{{ form.extra_ports }}"
          placeholder="8554, 8555"
        />
        <p class="pv-text-xs pv-text-muted pv-mt-1">
          Default RTSP ports 554 and 8554 are always scanned.
        </p>
      </div>

      <button type="submit" class="pv-button-primary">Start scan</button>
      <button
        type="button"
        id="cancel-scan-btn"
        class="pv-button-secondary pv-ml-2 pv-hidden"
      >
        Cancel scan
      </button>
        </form>

        <div class="pv-mt-3">
          <h2>Scan progress</h2>
          <div class="pv-table-wrap pv-table-wrap-spaced">
            <table class="pv-table">
              <thead>
                <tr>
                  <th>Host</th>
                  <th>Port</th>
                  <th>Current action</th>
                  <th>Result</th>
                </tr>
              </thead>
              <tbody id="scan-progress-body"></tbody>
            </table>
          </div>
          <div
            id="scan-summary"
            class="pv-alert pv-alert-success pv-hidden pv-mt-3"
          ></div>
        </div>

        <div id="scan-results" class="pv-mt-3"></div>

        <script>
    (function () {
      var form = document.getElementById('scan-form');
      if (!form) {
        return;
      }

      var progressBody = document.getElementById('scan-progress-body');
      var summaryEl = document.getElementById('scan-summary');
      var pollTimer = null;
      var currentJobId = null;
      var cancelButton = document.getElementById('cancel-scan-btn');
      var startButton = form.querySelector('button[type="submit"]');

      function statusUrl(jobId) {
        var base = '{{ url_for("camera_admin.scan_status", job_id="__JOB__") }}';
        return base.replace('__JOB__', jobId);
      }

      function cancelUrl(jobId) {
        var base = '{{ url_for("camera_admin.scan_cancel", job_id="__JOB__") }}';
        return base.replace('__JOB__', jobId);
      }

      function renderJob(job) {
        if (!job || !Array.isArray(job.events)) {
          return;
        }
        var latestByKey = {};
        for (var i = 0; i < job.events.length; i++) {
          var ev = job.events[i];
          var key = ev.ip + ':' + (ev.port || 0);
          latestByKey[key] = ev;
        }
        var keys = Object.keys(latestByKey).sort();
        progressBody.innerHTML = '';
        for (var j = 0; j < keys.length; j++) {
          var ev2 = latestByKey[keys[j]];
          var tr = document.createElement('tr');

          var hostTd = document.createElement('td');
          hostTd.textContent = ev2.ip;
          tr.appendChild(hostTd);

          var portTd = document.createElement('td');
          portTd.textContent = ev2.port || '';
          tr.appendChild(portTd);

          var actionTd = document.createElement('td');
          var label = '';
          if (ev2.phase === 'port_open') {
            label = 'Port open, probing camera';
          } else if (ev2.phase === 'trying_pattern') {
            label = 'Trying ' + (ev2.pattern_label || 'template');
          } else if (ev2.phase === 'pattern_success') {
            label = 'Found working pattern ' + (ev2.pattern_label || '');
          } else if (ev2.phase === 'no_working_port') {
            label = 'No working configuration found';
          } else {
            label = ev2.phase || '';
          }
          actionTd.textContent = label;
          tr.appendChild(actionTd);

          var resultTd = document.createElement('td');
          var status = ev2.status || 'running';
          if (status === 'success') {
            resultTd.textContent = '\u2713';
            resultTd.className = 'pv-text-success';
          } else if (status === 'failed') {
            resultTd.textContent = '\u2717';
            resultTd.className = 'pv-text-danger';
          } else {
            resultTd.textContent = '...';
          }
          tr.appendChild(resultTd);

          progressBody.appendChild(tr);
        }

        if (job.status === 'completed' || job.status === 'error' || job.status === 'cancelled') {
          if (pollTimer !== null) {
            clearInterval(pollTimer);
            pollTimer = null;
          }
          summaryEl.classList.remove('pv-hidden');
          var parts = [];
          if (job.status === 'completed') {
            if (job.results && job.results.length) {
              parts.push('<p>Scan completed. Added ' + job.results.length + ' camera(s).</p>');
            } else {
              parts.push('<p>Scan completed. No new cameras discovered.</p>');
            }
            if (job.messages && job.messages.length) {
              var items = '';
              for (var m = 0; m < job.messages.length; m++) {
                items += '<li>' + job.messages[m] + '</li>';
              }
              parts.push('<ul>' + items + '</ul>');
            }
          } else if (job.status === 'cancelled') {
            parts.push('<p>Scan cancelled by user.</p>');
            if (job.messages && job.messages.length) {
              var citems = '';
              for (var cm = 0; cm < job.messages.length; cm++) {
                citems += '<li>' + job.messages[cm] + '</li>';
              }
              parts.push('<ul>' + citems + '</ul>');
            }
          } else {
            var errText = 'Scan failed: ' + (job.error || 'unknown error');
            parts.push('<p>' + errText + '</p>');
            if (job.messages && job.messages.length) {
              var errItems = '';
              for (var n = 0; n < job.messages.length; n++) {
                errItems += '<li>' + job.messages[n] + '</li>';
              }
              parts.push('<ul>' + errItems + '</ul>');
            }
          }
          summaryEl.innerHTML = parts.join('');
          if (startButton) {
            startButton.disabled = false;
          }
          if (cancelButton) {
            cancelButton.disabled = true;
            cancelButton.classList.add('pv-hidden');
          }
          currentJobId = null;
        } else if (job.status === 'cancelling') {
          summaryEl.classList.remove('pv-hidden');
          if (!summaryEl.innerHTML && !summaryEl.textContent) {
            summaryEl.textContent = 'Cancelling scan...';
          }
          if (cancelButton) {
            cancelButton.disabled = true;
          }
        }
      }

      function pollStatus() {
        if (!currentJobId) {
          return;
        }
        fetch(statusUrl(currentJobId), { cache: 'no-store' })
          .then(function (resp) {
            if (!resp.ok) {
              throw new Error('status ' + resp.status);
            }
            return resp.json();
          })
          .then(function (data) {
            renderJob(data);
          })
          .catch(function () {
            // Ignore transient errors while polling.
          });
      }

      form.addEventListener('submit', function (ev) {
        ev.preventDefault();
        summaryEl.classList.add('pv-hidden');
        summaryEl.textContent = '';
        summaryEl.innerHTML = '';
        progressBody.innerHTML = '';

        if (pollTimer !== null) {
          clearInterval(pollTimer);
          pollTimer = null;
        }

        if (startButton) {
          startButton.disabled = true;
        }
        if (cancelButton) {
          cancelButton.classList.remove('pv-hidden');
          cancelButton.disabled = false;
        }

        var baseIp = form.base_ip.value || '';
        var prefix = form.prefix.value || '24';
        var extraPorts = form.extra_ports.value || '';
        var csrf = form.csrf_token.value || '';

        var payload = new URLSearchParams();
        payload.append('base_ip', baseIp);
        payload.append('prefix', prefix);
        payload.append('extra_ports', extraPorts);
        payload.append('csrf_token', csrf);

        fetch('{{ url_for("camera_admin.scan_start") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: payload.toString(),
        })
          .then(function (resp) {
            if (!resp.ok) {
              return resp.json().then(function (data) {
                throw new Error(data.error || 'Scan start failed');
              });
            }
            return resp.json();
          })
          .then(function (data) {
            currentJobId = data.job_id;
            pollStatus();
            pollTimer = setInterval(pollStatus, 1000);
          })
          .catch(function (err) {
            summaryEl.classList.remove('pv-hidden');
            summaryEl.textContent = err.message || 'Unable to start scan.';
          });
      });

      if (cancelButton) {
        cancelButton.addEventListener('click', function (ev) {
          ev.preventDefault();
          if (!currentJobId) {
            return;
          }
          cancelButton.disabled = true;

          var csrf = form.csrf_token.value || '';
          var payload = new URLSearchParams();
          payload.append('csrf_token', csrf);

          fetch(cancelUrl(currentJobId), {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: payload.toString(),
          })
            .then(function (resp) {
              if (!resp.ok) {
                return resp.json().then(function (data) {
                  throw new Error(data.error || 'Cancel failed');
                });
              }
              return resp.json();
            })
            .then(function () {
              summaryEl.classList.remove('pv-hidden');
              if (!summaryEl.innerHTML && !summaryEl.textContent) {
                summaryEl.textContent = 'Cancelling scan...';
              }
            })
            .catch(function () {
              // If cancel fails, allow retry.
              cancelButton.disabled = false;
            });
        });
      }
    })();
        </script>
      </div>
    </div>
  </section>
{% endblock %}
