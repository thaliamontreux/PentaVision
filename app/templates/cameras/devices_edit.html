{% extends 'base.html' %}

{% block title %}{% if is_edit %}Edit Camera{% else %}New Camera{% endif %} Â· PentaVision{% endblock %}

{% block content %}
  <section class="pv-section">
    <div class="pv-admin-layout">
      {% include 'admin/_nav.html' %}
      <div class="pv-admin-main">
        <div class="pv-page-header">
          <div>
            <h1 class="pv-page-title">
              {% if is_edit %}
                Edit Camera
              {% else %}
                New Camera
              {% endif %}
            </h1>
          </div>
          <div class="pv-page-actions">
            <a href="{{ url_for('camera_admin.list_devices') }}" class="pv-button-secondary">Back to cameras</a>
          </div>
        </div>

        {% if errors %}
          <div class="pv-alert pv-alert-error">
            <ul>
              {% for error in errors %}
                <li>{{ error }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        <div
          id="camera-client-errors"
          class="pv-alert pv-alert-error pv-hidden"
          aria-live="polite"
        >
          <ul id="camera-client-errors-list"></ul>
        </div>

        {% if form is not none %}
          <form method="post" class="pv-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}" />

        <div class="pv-field-group">
          <label for="name">Name</label>
          <input
            id="name"
            name="name"
            type="text"
            required
            value="{{ form.name }}"
          />
        </div>

        <div class="pv-field-group">
          <label for="pattern_id">URL template</label>
          <select id="pattern_id" name="pattern_id">
            <option value="">(none)</option>
            {% for p in patterns %}
              <option
                value="{{ p.id }}"
                data-pattern="{{ p.rtsp_url_pattern|e }}"
                data-streams="{{ p.streams_raw or '' }}"
                data-stream-names="{{ p.stream_names_raw or '' }}"
                data-channels="{{ p.channels_raw or '' }}"
                data-channel-names="{{ p.channel_names_raw or '' }}"
                data-low-res-stream="{{ p.low_res_stream or '' }}"
                data-high-res-stream="{{ p.high_res_stream or '' }}"
                {% if form.pattern_id == p.id|string %}selected{% endif %}
              >
                {{ p.manufacturer }} {{ p.model_or_note or '' }} ({{ p.protocol or 'RTSP' }})
              </option>
            {% endfor %}
          </select>
        </div>

        <div
          class="pv-field-group pv-hidden"
          id="pattern-params-group"
        >
          <label>Template parameters</label>
          <div id="pattern-params-fields"></div>
        </div>

        <div
          class="pv-field-group pv-hidden"
          id="stream-select-group"
        >
          <label for="stream-select">Stream</label>
          <select id="stream-select"></select>
        </div>

        <div
          class="pv-field-group pv-hidden"
          id="channel-select-group"
        >
          <label for="channel-select">Channel</label>
          <select id="channel-select"></select>
        </div>

        {% if is_admin %}
          <div
            class="pv-field-group pv-hidden"
            id="stream-quality-group"
          >
            <label>Stream quality</label>
            <div>
              <label id="stream-quality-low-label" class="pv-mr-4">
                <input
                  type="radio"
                  id="stream-quality-low"
                  name="stream_quality"
                  value="low"
                />
                Low resolution
              </label>
              <label id="stream-quality-high-label">
                <input
                  type="radio"
                  id="stream-quality-high"
                  name="stream_quality"
                  value="high"
                />
                High resolution
              </label>
            </div>
          </div>
        {% endif %}

        <input
          type="hidden"
          id="pattern-param-stream-hidden"
          name="pattern_param_stream"
          value=""
        />

        <input
          type="hidden"
          id="pattern-param-channel-hidden"
          name="pattern_param_channel"
          value=""
        />

        <div class="pv-field-group">
          <label for="property_id">Property</label>
          <select id="property_id" name="property_id">
            <option value="">(none)</option>
            {% for p in properties %}
              <option
                value="{{ p.id }}"
                {% if form.property_id == p.id|string %}selected{% endif %}
              >
                {{ p.name }}
              </option>
            {% endfor %}
          </select>
          <p class="pv-card-subtitle">
            Assign this camera to a property to enforce per-property access control.
          </p>
        </div>

        <div class="pv-field-group">
          <label for="placement">Placement</label>
          <select id="placement" name="placement">
            {% for value, label in placement_options %}
              <option
                value="{{ value }}"
                {% if form.placement == value %}selected{% endif %}
              >
                {{ label }}
              </option>
            {% endfor %}
          </select>
          <p class="pv-card-subtitle">
            Whether this camera is installed inside or outside the building.
          </p>
        </div>

        <div class="pv-field-group">
          <label for="location">Location</label>
          <select id="location" name="location">
            {% for value, label in location_options %}
              <option
                value="{{ value }}"
                {% if form.location == value %}selected{% endif %}
              >
                {{ label }}
              </option>
            {% endfor %}
          </select>
          <p class="pv-card-subtitle">
            Common room or area where this camera is installed, such as Kitchen or
            Living Room.
          </p>
        </div>

        <div class="pv-field-group">
          <label for="facing_direction">Facing direction</label>
          <select id="facing_direction" name="facing_direction">
            {% for value, label in direction_options %}
              <option
                value="{{ value }}"
                {% if form.facing_direction == value %}selected{% endif %}
              >
                {{ label }}
              </option>
            {% endfor %}
          </select>
          <p class="pv-card-subtitle">
            Cardinal direction the camera faces (for example, NE toward the
            driveway).
          </p>
        </div>

        <div class="pv-field-group">
          <label for="ip_address">IP address</label>
          <input
            id="ip_address"
            name="ip_address"
            type="text"
            required
            value="{{ form.ip_address }}"
          />
        </div>

        <div class="pv-field-group">
          <label for="mac_address">MAC address (optional)</label>
          <input
            id="mac_address"
            name="mac_address"
            type="text"
            value="{{ form.mac_address }}"
          />
          <p class="pv-card-subtitle">
            Used to auto-suggest a URL template based on the camera's OUI prefix.
          </p>
        </div>

        <div class="pv-field-group">
          <label for="port">Port</label>
          <input
            id="port"
            name="port"
            type="text"
            value="{{ form.port }}"
          />
        </div>

        <div class="pv-field-group">
          <label for="username">Username</label>
          <input
            id="username"
            name="username"
            type="text"
            value="{{ form.username }}"
          />
        </div>

        <div class="pv-field-group">
          <label for="password">Password</label>
          <input
            id="password"
            name="password"
            type="password"
            value="{{ form.password }}"
          />
        </div>

        <div class="pv-field-group">
          <label>
            <input
              type="checkbox"
              id="use_auth"
              name="use_auth"
              value="1"
              {% if form.use_auth %}checked{% endif %}
            />
            Use authentication (include username and password in URL)
          </label>
          <p class="pv-card-subtitle">
            When disabled, the connection URL will not include username or
            password, even if values are entered.
          </p>
        </div>

        <div class="pv-field-group">
          <label for="notes">Notes</label>
          <textarea
            id="notes"
            name="notes"
            rows="2"
          >{{ form.notes }}</textarea>
        </div>

        <div class="pv-field-group">
          <label for="storage_targets">Storage providers (optional)</label>
          <input
            id="storage_targets"
            name="storage_targets"
            type="text"
            value="{{ form.storage_targets }}"
          />
          <p class="pv-card-subtitle">
            Comma-separated provider names (for example:
            {{ storage_targets_default or "local_fs" }}). Leave blank to use
            the global default for this camera.
          </p>
        </div>

        <div class="pv-field-group">
          <label for="retention_days">Retention (days, optional)</label>
          <input
            id="retention_days"
            name="retention_days"
            type="text"
            value="{{ form.retention_days }}"
          />
          <p class="pv-card-subtitle">
            If set, recordings for this camera older than this many days will
            be automatically removed from storage.
          </p>
        </div>

        {% if is_admin %}
          <div class="pv-field-group">
            <label>
              <input
                type="checkbox"
                name="admin_lock"
                value="1"
                {% if form.admin_lock %}checked{% endif %}
              />
              Lock configuration (administrators only)
            </label>
            <p class="pv-card-subtitle">
              When enabled, technicians can view this camera but cannot modify or
              delete it.
            </p>
          </div>
        {% elif form.admin_lock %}
          <p class="pv-card-subtitle">
            This camera is locked by an administrator. You can view its settings
            but cannot change them with your current role.
          </p>
        {% endif %}

        <div class="pv-field-group">
          <label>
            <input
              type="checkbox"
              name="is_active"
              value="1"
              {% if form.is_active %}checked{% endif %}
            />
            Active camera
          </label>
        </div>

        <button type="submit" class="pv-button-primary">
          {% if is_edit %}
            Save changes
          {% else %}
            Create camera
          {% endif %}
        </button>
        <button
          type="button"
          id="test-connection-btn"
          class="pv-button-secondary pv-ml-2"
        >
          Test connection
        </button>
        <span
          id="test-connection-status"
          class="pv-card-subtitle pv-ml-3 pv-text-sm"
        ></span>
      </form>
    {% else %}
      <p>Nothing to edit.</p>
    {% endif %}

        <script>
          (function () {
      var form = document.querySelector('form');
      if (!form) {
        return;
      }
      var clientBox = document.getElementById('camera-client-errors');
      var clientList = document.getElementById('camera-client-errors-list');
      var requiredParamNames = [];

      function showClientErrors(errors) {
        if (!clientBox || !clientList) {
          return;
        }
        clientList.innerHTML = '';
        errors.forEach(function (msg) {
          var li = document.createElement('li');
          li.textContent = msg;
          clientList.appendChild(li);
        });
        clientBox.classList.toggle('pv-hidden', !errors.length);
      }

      form.addEventListener('submit', function (ev) {
        var errors = [];
        var name = (form.name && form.name.value ? form.name.value.trim() : '');
        var ip = (form.ip_address && form.ip_address.value ? form.ip_address.value.trim() : '');
        var port = (form.port && form.port.value ? form.port.value.trim() : '');
        var retention = (form.retention_days && form.retention_days.value ? form.retention_days.value.trim() : '');

        if (!name) {
          errors.push('Enter a camera name.');
        }
        if (!ip) {
          errors.push('Enter an IP address or hostname.');
        }
        if (port && !/^[0-9]+$/.test(port)) {
          errors.push('Port must be a numeric value.');
        }
        if (retention && !/^[0-9]+$/.test(retention)) {
          errors.push('Retention days must be a numeric value.');
        }

        if (errors.length) {
          ev.preventDefault();
          showClientErrors(errors);
        } else {
          showClientErrors([]);
        }
      });

      var btn = document.getElementById('test-connection-btn');
      var statusEl = document.getElementById('test-connection-status');
      var useAuth = document.getElementById('use_auth');
      var usernameInput = form.username;
      var passwordInput = form.password;
      var patternSelect = form.pattern_id;
      var patternParamsGroup = document.getElementById('pattern-params-group');
      var patternParamsFields = document.getElementById('pattern-params-fields');
      var streamSelectGroup = document.getElementById('stream-select-group');
      var streamSelect = document.getElementById('stream-select');
      var channelSelectGroup = document.getElementById('channel-select-group');
      var channelSelect = document.getElementById('channel-select');
      var streamQualityGroup = document.getElementById('stream-quality-group');
      var streamLow = document.getElementById('stream-quality-low');
      var streamHigh = document.getElementById('stream-quality-high');
      var streamLowLabel = document.getElementById('stream-quality-low-label');
      var streamHighLabel = document.getElementById('stream-quality-high-label');
      var streamHidden = document.getElementById('pattern-param-stream-hidden');
      var channelHidden = document.getElementById('pattern-param-channel-hidden');
      var macInput = document.getElementById('mac_address');

      var rawPatternParams = {{ pattern_params_json|default('')|tojson|safe }};
      var initialPatternParams = {};
      try {
        if (rawPatternParams) {
          if (typeof rawPatternParams === 'string') {
            if (rawPatternParams.trim()) {
              initialPatternParams = JSON.parse(rawPatternParams);
            }
          } else if (typeof rawPatternParams === 'object') {
            initialPatternParams = rawPatternParams || {};
          }
        }
      } catch (e) {
        initialPatternParams = {};
      }

      function parseList(raw) {
        if (!raw) {
          return [];
        }
        return raw
          .split(';')
          .map(function (item) {
            return item.trim();
          })
          .filter(function (item) {
            return !!item;
          });
      }

      function detectTemplateParams(patternText) {
        var names = [];
        if (!patternText) {
          return names;
        }
        var seen = {};
        var skipBuiltins = { IP: true, PORT: true, USERNAME: true, PASSWORD: true };
        var skipNames = { stream: true, channel: true };

        var reAngle = /<([^<>]+)>/g;
        var match;
        while ((match = reAngle.exec(patternText)) !== null) {
          var raw = match[1];
          if (!raw) {
            continue;
          }
          var name = String(raw);
          var upper = name.toUpperCase();
          if (skipBuiltins[upper] || skipNames[name]) {
            continue;
          }
          if (seen[name]) {
            continue;
          }
          seen[name] = true;
          names.push(name);
        }

        var reMustache = /\{\{\s*([^{}]+?)\s*\}\}/g;
        while ((match = reMustache.exec(patternText)) !== null) {
          var raw2 = match[1];
          if (!raw2) {
            continue;
          }
          var name2 = String(raw2).trim();
          var upper2 = name2.toUpperCase();
          if (skipBuiltins[upper2] || skipNames[name2]) {
            continue;
          }
          if (seen[name2]) {
            continue;
          }
          seen[name2] = true;
          names.push(name2);
        }
        return names;
      }

      function renderPatternParams() {
        if (!patternSelect || !patternParamsGroup || !patternParamsFields) {
          return;
        }
        var selected = patternSelect.options[patternSelect.selectedIndex];
        if (!selected) {
          patternParamsFields.innerHTML = '';
          patternParamsGroup.classList.add('pv-hidden');
          return;
        }
        var patternText = selected.getAttribute('data-pattern') || '';
        var names = detectTemplateParams(patternText);
        requiredParamNames = names.slice();
        patternParamsFields.innerHTML = '';
        if (!names.length) {
          patternParamsGroup.classList.add('pv-hidden');
          return;
        }
        patternParamsGroup.classList.remove('pv-hidden');
        names.forEach(function (name) {
          var fieldId = 'pattern-param-' + name;
          var wrapper = document.createElement('div');
          wrapper.className = 'pv-field-group';
          var label = document.createElement('label');
          label.setAttribute('for', fieldId);
          label.textContent = name + ' value';
          var input = document.createElement('input');
          input.type = 'text';
          input.id = fieldId;
          input.name = 'pattern_param_' + name;
          input.required = true;
          var existing =
            initialPatternParams &&
            Object.prototype.hasOwnProperty.call(initialPatternParams, name)
              ? initialPatternParams[name]
              : '';
          if (existing !== undefined && existing !== null) {
            input.value = String(existing);
          }
          wrapper.appendChild(label);
          wrapper.appendChild(input);
          patternParamsFields.appendChild(wrapper);
        });
      }

      function configureStreamControlsForPattern() {
        if (!patternSelect) {
          return;
        }
        var selected = patternSelect.options[patternSelect.selectedIndex];
        var lowVal = '';
        var highVal = '';
        if (selected) {
          lowVal = selected.getAttribute('data-low-res-stream') || '';
          highVal = selected.getAttribute('data-high-res-stream') || '';
        }
        var hasLow = !!lowVal;
        var hasHigh = !!highVal;

        var currentStream = '';
        if (streamHidden && streamHidden.value) {
          currentStream = streamHidden.value;
        } else if (
          initialPatternParams &&
          Object.prototype.hasOwnProperty.call(initialPatternParams, 'stream')
        ) {
          currentStream = String(initialPatternParams.stream);
        }

        var chosen = currentStream || '';
        if (!chosen) {
          if (hasHigh) {
            chosen = highVal;
          } else if (hasLow) {
            chosen = lowVal;
          }
        }

        if (streamHidden) {
          streamHidden.value = chosen || '';
        }

        if (!streamQualityGroup || (!hasLow && !hasHigh)) {
          if (streamQualityGroup) {
            streamQualityGroup.classList.add('pv-hidden');
          }
          return;
        }

        streamQualityGroup.classList.remove('pv-hidden');

        function setRadioState(radio, label, hasVal, val, isSelected) {
          if (!radio || !label) {
            return;
          }
          radio.disabled = !hasVal;
          radio.checked = false;
          radio.setAttribute('data-stream-value', hasVal ? val : '');
          label.classList.toggle('pv-label-disabled', !hasVal);
          if (hasVal && isSelected) {
            radio.checked = true;
          }
        }

        setRadioState(streamLow, streamLowLabel, hasLow, lowVal, chosen === lowVal);
        setRadioState(streamHigh, streamHighLabel, hasHigh, highVal, chosen === highVal);
      }

      function configureStreamAndChannelForPattern() {
        if (!patternSelect) {
          return;
        }
        var selected = patternSelect.options[patternSelect.selectedIndex];
        if (!selected) {
          if (streamSelectGroup) {
            streamSelectGroup.classList.add('pv-hidden');
          }
          if (channelSelectGroup) {
            channelSelectGroup.classList.add('pv-hidden');
          }
          if (streamHidden) {
            streamHidden.value = '';
          }
          if (channelHidden) {
            channelHidden.value = '';
          }
          configureStreamControlsForPattern();
          return;
        }

        var streamsRaw = selected.getAttribute('data-streams') || '';
        var streamNamesRaw = selected.getAttribute('data-stream-names') || '';
        var channelsRaw = selected.getAttribute('data-channels') || '';
        var channelNamesRaw = selected.getAttribute('data-channel-names') || '';
        var lowVal = selected.getAttribute('data-low-res-stream') || '';
        var highVal = selected.getAttribute('data-high-res-stream') || '';

        var streamValues = parseList(streamsRaw);
        var streamLabels = parseList(streamNamesRaw);
        var channelValues = parseList(channelsRaw);
        var channelLabels = parseList(channelNamesRaw);

        var chosenStream = '';
        if (
          initialPatternParams &&
          Object.prototype.hasOwnProperty.call(initialPatternParams, 'stream') &&
          initialPatternParams.stream
        ) {
          chosenStream = String(initialPatternParams.stream);
        } else if (streamHidden && streamHidden.value) {
          chosenStream = streamHidden.value;
        }
        if (!chosenStream) {
          if (highVal) {
            chosenStream = highVal;
          } else if (lowVal) {
            chosenStream = lowVal;
          } else if (streamValues.length) {
            chosenStream = streamValues[0];
          }
        }

        var chosenChannel = '';
        if (
          initialPatternParams &&
          Object.prototype.hasOwnProperty.call(initialPatternParams, 'channel') &&
          initialPatternParams.channel
        ) {
          chosenChannel = String(initialPatternParams.channel);
        } else if (channelHidden && channelHidden.value) {
          chosenChannel = channelHidden.value;
        } else if (channelValues.length) {
          chosenChannel = channelValues[0];
        }

        if (streamSelect) {
          streamSelect.innerHTML = '';
        }
        if (streamValues.length && streamSelect && streamSelectGroup) {
          var foundStream = false;
          streamValues.forEach(function (val, idx) {
            var opt = document.createElement('option');
            opt.value = val;
            var label = streamLabels[idx] || val;
            opt.textContent = label;
            if (val === chosenStream) {
              opt.selected = true;
              foundStream = true;
            }
            streamSelect.appendChild(opt);
          });
          if (!foundStream && streamValues.length) {
            chosenStream = streamValues[0];
            streamSelect.value = chosenStream;
          }
          streamSelectGroup.classList.remove('pv-hidden');
        } else if (streamSelectGroup) {
          streamSelectGroup.classList.add('pv-hidden');
        }

        if (channelSelect) {
          channelSelect.innerHTML = '';
        }
        if (channelValues.length && channelSelect && channelSelectGroup) {
          var foundChannel = false;
          channelValues.forEach(function (val, idx) {
            var optC = document.createElement('option');
            optC.value = val;
            var labelC = channelLabels[idx] || val;
            optC.textContent = labelC;
            if (val === chosenChannel) {
              optC.selected = true;
              foundChannel = true;
            }
            channelSelect.appendChild(optC);
          });
          if (!foundChannel && channelValues.length) {
            chosenChannel = channelValues[0];
            channelSelect.value = chosenChannel;
          }
          channelSelectGroup.classList.remove('pv-hidden');
        } else if (channelSelectGroup) {
          channelSelectGroup.classList.add('pv-hidden');
        }

        if (streamHidden) {
          streamHidden.value = chosenStream || '';
        }
        if (channelHidden) {
          channelHidden.value = chosenChannel || '';
        }

        configureStreamControlsForPattern();
      }

      function syncAuthState() {
        if (!useAuth) {
          return;
        }
        var enabled = useAuth.checked;
        if (usernameInput) {
          usernameInput.disabled = !enabled;
        }
        if (passwordInput) {
          passwordInput.disabled = !enabled;
        }
      }

      if (useAuth) {
        useAuth.addEventListener('change', syncAuthState);
        syncAuthState();
      }
      if (patternSelect) {
        patternSelect.addEventListener('change', function () {
          initialPatternParams = {};
          renderPatternParams();
          configureStreamAndChannelForPattern();
        });
        renderPatternParams();
        configureStreamAndChannelForPattern();
      }

      if (streamLow) {
        streamLow.addEventListener('change', function () {
          if (!streamLow.checked) {
            return;
          }
          var v = streamLow.getAttribute('data-stream-value') || '';
          if (streamHidden) {
            streamHidden.value = v;
          }
          configureStreamControlsForPattern();
        });
      }
      if (streamHigh) {
        streamHigh.addEventListener('change', function () {
          if (!streamHigh.checked) {
            return;
          }
          var v = streamHigh.getAttribute('data-stream-value') || '';
          if (streamHidden) {
            streamHidden.value = v;
          }
          configureStreamControlsForPattern();
        });
      }

      if (streamSelect) {
        streamSelect.addEventListener('change', function () {
          var v = streamSelect.value || '';
          if (streamHidden) {
            streamHidden.value = v;
          }
          configureStreamControlsForPattern();
        });
      }

      if (channelSelect) {
        channelSelect.addEventListener('change', function () {
          var v = channelSelect.value || '';
          if (channelHidden) {
            channelHidden.value = v;
          }
        });
      }

      function suggestPatternFromMac() {
        if (!macInput || !patternSelect) {
          return;
        }
        var mac = macInput.value ? macInput.value.trim() : '';
        if (!mac) {
          return;
        }
        if (patternSelect.value) {
          return;
        }
        var payload = new URLSearchParams();
        payload.append('csrf_token', (form.csrf_token && form.csrf_token.value) || '');
        payload.append('mac_address', mac);
        fetch('{{ url_for("camera_admin.suggest_pattern_for_mac") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: payload.toString(),
        })
          .then(function (resp) {
            return resp.json();
          })
          .then(function (data) {
            if (!data || !data.ok || !data.pattern_id) {
              return;
            }
            patternSelect.value = String(data.pattern_id);
            initialPatternParams = {};
            renderPatternParams();
            configureStreamAndChannelForPattern();
          })
          .catch(function () {
            /* ignore suggestion errors */
          });
      }

      if (macInput) {
        macInput.addEventListener('blur', suggestPatternFromMac);
      }

      function detectMacFromIp() {
        if (!ipInput || !macInput) {
          return;
        }
        var ip = ipInput.value ? ipInput.value.trim() : '';
        if (!ip) {
          return;
        }
        if ((macInput.value || '').trim()) {
          return;
        }
        var payload = new URLSearchParams();
        payload.append('csrf_token', (form.csrf_token && form.csrf_token.value) || '');
        payload.append('ip_address', ip);
        fetch('{{ url_for("camera_admin.detect_mac_for_device_ip") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: payload.toString(),
        })
          .then(function (resp) {
            return resp.json();
          })
          .then(function (data) {
            if (!data || !data.ok) {
              return;
            }
            var mac = (data.mac_address || '').trim();
            if (!mac) {
              return;
            }
            if ((macInput.value || '').trim()) {
              return;
            }
            macInput.value = mac;
            suggestPatternFromMac();
          })
          .catch(function () {
            /* ignore detect errors */
          });
      }

      if (ipInput) {
        ipInput.addEventListener('blur', detectMacFromIp);
      }
      if (!btn || !statusEl) {
        return;
      }

      function setStatus(text, tone) {
        statusEl.textContent = text || '';
        var color = '#6b7280';
        if (tone === 'ok') {
          color = '#16a34a';
        } else if (tone === 'error') {
          color = '#dc2626';
        }
        statusEl.style.color = color;
      }

      btn.addEventListener('click', function (ev) {
        ev.preventDefault();
        btn.disabled = true;
        setStatus('Testing connection...', 'pending');

        var payload = new URLSearchParams();
        payload.append('csrf_token', (form.csrf_token && form.csrf_token.value) || '');
        payload.append('pattern_id', (form.pattern_id && form.pattern_id.value) || '');
        payload.append('ip_address', (form.ip_address && form.ip_address.value) || '');
        payload.append('port', (form.port && form.port.value) || '');
        payload.append('username', (form.username && form.username.value) || '');
        payload.append('password', (form.password && form.password.value) || '');
        var paramInputs = form.querySelectorAll('[name^="pattern_param_"]');
        paramInputs.forEach(function (input) {
          if (!input.name) {
            return;
          }
          payload.append(input.name, input.value || '');
        });

        fetch('{{ url_for("camera_admin.test_device_connection") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: payload.toString(),
        })
          .then(function (resp) {
            return resp.json();
          })
          .then(function (data) {
            if (data && data.ok) {
              var msg = 'Connection successful.';
              if (data.url) {
                msg += ' URL: ' + data.url;
              }
              setStatus(msg, 'ok');
            } else {
              var err = (data && data.error) || 'Connection failed.';
              if (data && data.url) {
                err += ' URL: ' + data.url;
              }
              setStatus(err, 'error');
            }
          })
          .catch(function () {
            setStatus('Connection test failed (network error).', 'error');
          })
          .finally(function () {
            btn.disabled = false;
          });
      });
          })();
        </script>
      </div>
    </div>
  </section>
{% endblock %}
