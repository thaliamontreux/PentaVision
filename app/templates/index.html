{% extends 'base.html' %}

{% block title %}Dashboard · PentaVision{% endblock %}

{% block content %}
  <section class="pv-section pv-dashboard">
    <div class="pv-dashboard-header">
      <div>
        <h1>Dashboard</h1>
        <p class="pv-card-subtitle">
          Overall status:
          {% if overall_status == 'ok' %}
            <span class="pv-chip pv-chip-ok">All systems nominal</span>
          {% else %}
            <span class="pv-chip pv-chip-warn">Degraded &mdash; check database connectivity</span>
          {% endif %}
        </p>
      </div>
      <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 0.25rem;">
        <div class="pv-layout-switcher">
          <span>Layout:</span>
          <button type="button" class="pv-layout-button is-active" data-layout="4">4 × 4</button>
          <button type="button" class="pv-layout-button" data-layout="8">8 × 8</button>
          <button type="button" class="pv-layout-button" data-layout="16">16 × 16</button>
        </div>
        <div class="pv-layout-switcher">
          <span>Preview size:</span>
          {% set dash_size = dashboard_display_size or '320x240' %}
          <button
            type="button"
            class="pv-layout-button pv-dashboard-size-button{% if dash_size == '320x240' %} is-active{% endif %}"
            data-size="320x240"
          >
            320×240
          </button>
          <button
            type="button"
            class="pv-layout-button pv-dashboard-size-button{% if dash_size == '720x480' %} is-active{% endif %}"
            data-size="720x480"
          >
            720×480
          </button>
        </div>
      </div>
    </div>

    <div class="pv-dashboard-shell">
      <div class="pv-camera-wall">
        {% if devices %}
          <div class="pv-camera-grid pv-layout-4" id="pv-camera-grid">
            {% for d in devices %}
              {% set pat = patterns.get(d.pattern_id) if patterns else None %}
              <div class="pv-camera-tile" role="group" aria-label="Camera {{ d.name }}">
                <div class="pv-camera-header">
                  <div class="pv-camera-title">{{ d.name }}</div>
                </div>
                <div
                  class="pv-camera-preview pv-dashboard-size-{{ dash_size }}"
                  data-device-id="{{ d.id }}"
                  style="position: relative;"
                >
                  <img
                    src="{{ url_for('main.camera_preview_low_jpeg', device_id=d.id) }}"
                    data-preview-url="{{ url_for('main.camera_preview_low_jpeg', device_id=d.id) }}"
                    alt="Live preview for {{ d.name }}"
                    class="pv-camera-live"
                  />
                  <canvas
                    class="pv-camera-face-overlay"
                    data-face-overlay="{{ d.id }}"
                    style="position: absolute; left: 0; top: 0; width: 100%; height: 100%; pointer-events: none; display: none;"
                  ></canvas>
                </div>
                <div class="pv-camera-footer">
                  <div class="pv-camera-status-block">
                    {% set status = camera_status.get(d.id, 'unknown') if camera_status else 'unknown' %}
                    <span class="pv-status-chip pv-status-{{ status }}">
                      {% if status == 'online' %}
                        Online
                      {% elif status == 'offline' %}
                        Offline
                      {% else %}
                        Status unknown
                      {% endif %}
                    </span>
                  </div>
                  <div class="pv-camera-actions">
                    <a
                      href="{{ url_for('main.camera_session', device_id=d.id) }}"
                      class="pv-button"
                    >
                      Start session
                    </a>
                    <a
                      href="{{ url_for('camera_admin.edit_device', device_id=d.id) }}"
                      class="pv-link-muted"
                    >
                      Configure
                    </a>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p style="font-size: 0.9rem; color: #9ca3af;">
            No cameras configured yet. Use the <strong>Cameras</strong> page to add your first
            device.
          </p>
        {% endif %}
      </div>

      {% set status_user = db_status.get('user', 'not_configured') %}
      {% set status_face = db_status.get('face', 'not_configured') %}
      {% set status_record = db_status.get('record', 'not_configured') %}
      <div class="pv-status-bar">
        <div class="pv-status-section">
          <span class="pv-status-label">System</span>
          <span class="pv-status-kv">
            <span>User</span>
            <span class="pv-badge pv-badge-{{ status_user }}">{{ status_user }}</span>
          </span>
          <span class="pv-status-kv">
            <span>Face</span>
            <span class="pv-badge pv-badge-{{ status_face }}">{{ status_face }}</span>
          </span>
          <span class="pv-status-kv">
            <span>Record</span>
            <span class="pv-badge pv-badge-{{ status_record }}">{{ status_record }}</span>
          </span>
        </div>

        <div class="pv-status-section">
          <span class="pv-status-label">Cameras</span>
          {% if devices %}
            {% set stats = namespace(online=0, offline=0, unknown=0) %}
            {% for d in devices %}
              {% set s = camera_status.get(d.id, 'unknown') if camera_status else 'unknown' %}
              {% if s == 'online' %}
                {% set stats.online = stats.online + 1 %}
              {% elif s == 'offline' %}
                {% set stats.offline = stats.offline + 1 %}
              {% else %}
                {% set stats.unknown = stats.unknown + 1 %}
              {% endif %}
            {% endfor %}
            <span class="pv-status-kv">
              <span>{{ devices|length }} total</span>
            </span>
            <span class="pv-status-kv">
              <span>{{ stats.online }} online</span>
            </span>
            <span class="pv-status-kv">
              <span>{{ stats.offline }} offline</span>
            </span>
            {% if stats.unknown %}
              <span class="pv-status-kv">
                <span>{{ stats.unknown }} unknown</span>
              </span>
            {% endif %}
            <a
              href="{{ url_for('camera_admin.list_devices') }}"
              class="pv-link-muted pv-status-manage-link"
            >
              Manage
            </a>
          {% else %}
            <span class="pv-status-kv">
              <span>No cameras</span>
            </span>
          {% endif %}
        </div>
      </div>
    </div>
  </section>
  <script>
    (function () {
      var grid = document.getElementById('pv-camera-grid');
      var layoutButtons = document.querySelectorAll('.pv-layout-button[data-layout]');
      var sizeButtons = document.querySelectorAll('.pv-dashboard-size-button');

      function applyLayout(cols) {
        if (!grid) return;
        grid.classList.remove('pv-layout-4', 'pv-layout-8', 'pv-layout-16');
        grid.classList.add('pv-layout-' + cols);
      }

      if (grid && layoutButtons.length) {
        layoutButtons.forEach(function (btn) {
          btn.addEventListener('click', function () {
            var cols = btn.getAttribute('data-layout');
            if (!cols) return;
            layoutButtons.forEach(function (b) { b.classList.remove('is-active'); });
            btn.classList.add('is-active');
            applyLayout(cols);
          });
        });
        var initial = layoutButtons[0].getAttribute('data-layout') || '4';
        applyLayout(initial);
      }

      function applyDashboardSize(size) {
        var containers = document.querySelectorAll('.pv-camera-preview[data-device-id]');
        var allClasses = ['pv-dashboard-size-320x240', 'pv-dashboard-size-720x480'];
        containers.forEach(function (el) {
          allClasses.forEach(function (cls) { el.classList.remove(cls); });
          el.classList.add('pv-dashboard-size-' + size);
        });
      }

      if (sizeButtons.length) {
        sizeButtons.forEach(function (btn) {
          btn.addEventListener('click', function () {
            var size = btn.getAttribute('data-size');
            if (!size) return;
            sizeButtons.forEach(function (b) { b.classList.remove('is-active'); });
            btn.classList.add('is-active');
            applyDashboardSize(size);

            try {
              fetch('/api/user/display-size', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({ scope: 'dashboard', size: size }),
              }).catch(function () {});
            } catch (e) {}
          });
        });
      }

      var POLL_INTERVAL_MS = 10000;
      var statusEls = document.querySelectorAll('[data-stream-health]');
      var previewImgs = document.querySelectorAll('.pv-camera-preview .pv-camera-live');
      var FACE_RECOGNITION_INTERVAL_MS = 10000; // how often to try automatic face recognition per camera
      var previewFps = {{ preview_low_fps|default(2.0)|tojson }};
      var previewIntervalMs = 0;
      if (typeof previewFps === 'number' && previewFps > 0) {
        previewIntervalMs = Math.max(200, Math.round(1000 / previewFps));
      }

      function updateStreamStatus() {
        if (!statusEls.length) {
          return;
        }
        fetch('{{ url_for("main.streams_status") }}', { cache: 'no-store' })
          .then(function (resp) { return resp.json(); })
          .then(function (data) {
            if (!data || data.ok === false || !Array.isArray(data.streams)) {
              return;
            }
            var byId = {};
            data.streams.forEach(function (s) {
              byId[String(s.device_id)] = s;
            });

            statusEls.forEach(function (el) {
              var id = el.getAttribute('data-device-id');
              var info = byId[id];
              if (!info) {
                el.textContent = 'Stream: not running';
                el.className = 'pv-status-chip pv-status-offline pv-camera-streamhealth';
                el.title = '';
                return;
              }
              var lastError = info.last_error || null;
              var age = typeof info.age_seconds === 'number' ? info.age_seconds : null;

              if (lastError && lastError.stage) {
                el.textContent = 'Stream error: ' + lastError.stage;
                el.className = 'pv-status-chip pv-status-offline pv-camera-streamhealth';
                el.title = lastError.message || '';
              } else if (!info.thread_alive || age === null || age > 10) {
                el.textContent = 'Stream: stale';
                el.className = 'pv-status-chip pv-status-offline pv-camera-streamhealth';
                el.title = '';
              } else {
                el.textContent = 'Stream: OK';
                el.className = 'pv-status-chip pv-status-online pv-camera-streamhealth';
                el.title = '';
              }
            });
          })
          .catch(function () {
            // Do not surface fetch errors in the UI; this is best-effort only.
          });
      }

      if (statusEls.length) {
        updateStreamStatus();
        window.setInterval(updateStreamStatus, POLL_INTERVAL_MS);
      }

      function refreshPreviews() {
        if (!previewImgs.length || !previewIntervalMs) {
          return;
        }
        previewImgs.forEach(function (img) {
          var container = img.closest('.pv-camera-preview');
          if (!container) {
            return;
          }
          var deviceId = container.getAttribute('data-device-id');
          if (!deviceId) {
            return;
          }
          var baseUrl = img.getAttribute('data-preview-url') || img.getAttribute('src');
          if (!baseUrl) {
            return;
          }
          var sep = baseUrl.indexOf('?') === -1 ? '?' : '&';
          img.src = baseUrl + sep + 'ts=' + Date.now();
        });
      }

      if (previewImgs.length && previewIntervalMs) {
        refreshPreviews();
        window.setInterval(refreshPreviews, previewIntervalMs);
      }

      function clearFaceOverlay(deviceId) {
        var canvas = document.querySelector(
          '.pv-camera-preview[data-device-id="' + deviceId + '"] .pv-camera-face-overlay'
        );
        if (!canvas) {
          return;
        }
        var ctx = canvas.getContext('2d');
        if (!ctx) {
          return;
        }
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        canvas.style.display = 'none';
      }

      function drawFaceOverlay(deviceId, faces, imageWidth, imageHeight) {
        var container = document.querySelector(
          '.pv-camera-preview[data-device-id="' + deviceId + '"]'
        );
        if (!container) {
          return;
        }
        var img = container.querySelector('.pv-camera-live');
        var canvas = container.querySelector('.pv-camera-face-overlay');
        if (!img || !canvas) {
          return;
        }

        var w = img.clientWidth || img.naturalWidth || 0;
        var h = img.clientHeight || img.naturalHeight || 0;
        if (!w || !h || !imageWidth || !imageHeight) {
          return;
        }

        canvas.width = w;
        canvas.height = h;
        var ctx = canvas.getContext('2d');
        if (!ctx) {
          return;
        }
        ctx.clearRect(0, 0, w, h);
        ctx.strokeStyle = '#22c55e';
        ctx.lineWidth = 2;
        ctx.font = '11px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
        ctx.fillStyle = 'rgba(34,197,94,0.7)';

        var scaleX = w / imageWidth;
        var scaleY = h / imageHeight;

        faces.forEach(function (face) {
          var top = face.top;
          var right = face.right;
          var bottom = face.bottom;
          var left = face.left;
          var label = face.email || (face.user_id != null ? ('ID ' + face.user_id) : 'Unknown');
          var distance = typeof face.distance === 'number' ? face.distance.toFixed(2) : null;

          var x = left * scaleX;
          var y = top * scaleY;
          var fw = (right - left) * scaleX;
          var fh = (bottom - top) * scaleY;

          ctx.strokeRect(x, y, fw, fh);
          var text = label + (distance ? (' [' + distance + ']') : '');
          var tw = ctx.measureText(text).width + 6;
          var th = 14;
          ctx.fillRect(x, y - th, tw, th);
          ctx.fillStyle = '#0b1120';
          ctx.fillText(text, x + 3, y - 3);
          ctx.fillStyle = 'rgba(34,197,94,0.7)';
        });

        canvas.style.display = 'block';
        window.setTimeout(function () {
          clearFaceOverlay(deviceId);
        }, 2500);
      }

      function runFaceRecognition(deviceId) {
        if (!deviceId) {
          return;
        }
        clearFaceOverlay(deviceId);

        fetch('/api/cameras/' + deviceId + '/face-recognize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: '{}',
        })
          .then(function (resp) { return resp.json(); })
          .then(function (data) {
            if (data && Array.isArray(data.faces) && data.faces.length) {
              drawFaceOverlay(
                deviceId,
                data.faces,
                data.image_width || 0,
                data.image_height || 0,
              );
            } else {
              clearFaceOverlay(deviceId);
            }
          })
          .catch(function () {
            clearFaceOverlay(deviceId);
          });
      }

      function runAutoFaceRecognition() {
        if (!FACE_RECOGNITION_INTERVAL_MS) {
          return;
        }
        var containers = document.querySelectorAll('.pv-camera-preview[data-device-id]');
        if (!containers.length) {
          return;
        }
        containers.forEach(function (container) {
          var deviceId = container.getAttribute('data-device-id');
          if (!deviceId) {
            return;
          }
          runFaceRecognition(deviceId);
        });
      }

      if (FACE_RECOGNITION_INTERVAL_MS > 0) {
        runAutoFaceRecognition();
        window.setInterval(runAutoFaceRecognition, FACE_RECOGNITION_INTERVAL_MS);
      }
    })();
  </script>
{% endblock %}
