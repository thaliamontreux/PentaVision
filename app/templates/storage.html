{% extends 'base.html' %}

{% block title %}Storage · PentaVision{% endblock %}

{% block content %}
  <section class="pv-section">
    <h1>Storage providers</h1>
    {% include 'admin/_nav.html' %}
    <p style="margin-bottom: 1rem; color: #9ca3af; font-size: 0.9rem;">
      Define and manage storage providers for camera recordings. The
      recommended way is to use the dynamic modules in the
      <strong>Our storage providers</strong> section below. The legacy global
      configuration form is kept for backwards compatibility and as a
      fallback when no modules are defined.
    </p>

    {% if errors %}
      <div class="pv-alert pv-alert-error" role="alert">
        <ul>
          {% for error in errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    {% if saved %}
      <div class="pv-alert pv-alert-success" role="status">
        <p>Storage settings updated.</p>
      </div>
    {% endif %}

    <form method="post" class="pv-form" style="margin-bottom: 1.5rem;">
      <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />

      <div class="pv-card">
        <h2>Legacy global storage configuration</h2>
        <p class="pv-card-subtitle">
          Choose which providers are active and where local recordings are written
          before upload.
        </p>

        <div class="pv-field-group">
          <label for="storage_targets">Active targets</label>
          <input
            id="storage_targets"
            name="storage_targets"
            type="text"
            value="{{ form.storage_targets }}"
            placeholder="e.g. local_fs,s3"
          />
          <p class="pv-card-subtitle">
            Comma-separated list of providers to use for new recordings:
            <code>local_fs</code>, <code>db</code>, <code>s3</code>,
            <code>gcs</code>, <code>azure_blob</code>, <code>dropbox</code>,
            <code>webdav</code>.
          </p>
        </div>

        <div class="pv-field-group">
          <label for="local_storage_path">Local filesystem path</label>
          <input
            id="local_storage_path"
            name="local_storage_path"
            type="text"
            value="{{ form.local_storage_path }}"
            placeholder="/var/lib/pentavision/recordings"
          />
          <p class="pv-card-subtitle">
            Base directory for the <code>local_fs</code> provider. If empty,
            the app falls back to <code>RECORDING_BASE_DIR</code> or a default
            under the instance path.
          </p>
        </div>

        <div class="pv-field-group">
          <label for="recording_base_dir">Recording base directory (legacy)</label>
          <input
            id="recording_base_dir"
            name="recording_base_dir"
            type="text"
            value="{{ form.recording_base_dir }}"
          />
          <p class="pv-card-subtitle">
            Optional compatibility setting used by some background workers. Most
            deployments can leave this blank and rely on <em>Local filesystem
            path</em> instead.
          </p>
        </div>
      </div>

      <div class="pv-card" style="margin-top: 1.5rem;">
        <h2>S3-compatible configuration</h2>
        <p class="pv-card-subtitle">
          When <code>s3</code> is included in the active targets, recordings are
          uploaded to an S3-compatible bucket.
        </p>

        <div class="pv-field-group">
          <label for="s3_bucket">Bucket</label>
          <input
            id="s3_bucket"
            name="s3_bucket"
            type="text"
            value="{{ form.s3_bucket }}"
          />
        </div>

        <div class="pv-field-group">
          <label for="s3_endpoint">Endpoint</label>
          <input
            id="s3_endpoint"
            name="s3_endpoint"
            type="text"
            value="{{ form.s3_endpoint }}"
            placeholder="https://s3.amazonaws.com or custom endpoint"
          />
        </div>

        <div class="pv-field-group">
          <label for="s3_region">Region</label>
          <input
            id="s3_region"
            name="s3_region"
            type="text"
            value="{{ form.s3_region }}"
            placeholder="us-east-1"
          />
        </div>

        <div class="pv-field-group">
          <label for="s3_access_key">Access key ID</label>
          <input
            id="s3_access_key"
            name="s3_access_key"
            type="password"
            value="{{ form.s3_access_key }}"
            autocomplete="off"
          />
          <p class="pv-card-subtitle">
            Leave blank to keep the existing key (from the database or
            environment).
          </p>
        </div>

        <div class="pv-field-group">
          <label for="s3_secret_key">Secret access key</label>
          <input
            id="s3_secret_key"
            name="s3_secret_key"
            type="password"
            value="{{ form.s3_secret_key }}"
            autocomplete="off"
          />
          <p class="pv-card-subtitle">
            Leave blank to keep the existing key.
          </p>
        </div>
      </div>

      <div class="pv-card" style="margin-top: 1.5rem;">
        <h2>Google Cloud Storage</h2>
        <p class="pv-card-subtitle">
          When <code>gcs</code> is active, recordings are uploaded to a Google
          Cloud Storage bucket.
        </p>
        <div class="pv-field-group">
          <label for="gcs_bucket">Bucket</label>
          <input
            id="gcs_bucket"
            name="gcs_bucket"
            type="text"
            value="{{ form.gcs_bucket }}"
          />
        </div>
      </div>

      <div class="pv-card" style="margin-top: 1.5rem;">
        <h2>Azure Blob Storage</h2>
        <p class="pv-card-subtitle">
          When <code>azure_blob</code> is active, recordings are uploaded to an
          Azure Blob container.
        </p>
        <div class="pv-field-group">
          <label for="azure_blob_container">Container</label>
          <input
            id="azure_blob_container"
            name="azure_blob_container"
            type="text"
            value="{{ form.azure_blob_container }}"
          />
        </div>
        <div class="pv-field-group">
          <label for="azure_blob_connection_string">Connection string</label>
          <input
            id="azure_blob_connection_string"
            name="azure_blob_connection_string"
            type="password"
            value="{{ form.azure_blob_connection_string }}"
            autocomplete="off"
          />
          <p class="pv-card-subtitle">
            Leave blank to keep the existing connection string.
          </p>
        </div>
      </div>

      <div class="pv-card" style="margin-top: 1.5rem;">
        <h2>Dropbox</h2>
        <p class="pv-card-subtitle">
          When <code>dropbox</code> is active, recordings are uploaded under
          <code>/recordings</code> in the configured Dropbox account.
        </p>
        <div class="pv-field-group">
          <label for="dropbox_access_token">Access token</label>
          <input
            id="dropbox_access_token"
            name="dropbox_access_token"
            type="password"
            value="{{ form.dropbox_access_token }}"
            autocomplete="off"
          />
          <p class="pv-card-subtitle">
            Leave blank to keep the existing token.
          </p>
        </div>
      </div>

      <div class="pv-card" style="margin-top: 1.5rem;">
        <h2>WebDAV / Nextcloud</h2>
        <p class="pv-card-subtitle">
          When <code>webdav</code> is active, recordings are uploaded via
          WebDAV (for example to Nextcloud).
        </p>
        <div class="pv-field-group">
          <label for="webdav_base_url">Base URL</label>
          <input
            id="webdav_base_url"
            name="webdav_base_url"
            type="text"
            value="{{ form.webdav_base_url }}"
            placeholder="https://example.com/remote.php/dav/files/user"
          />
        </div>
        <div class="pv-field-group">
          <label for="webdav_username">Username</label>
          <input
            id="webdav_username"
            name="webdav_username"
            type="text"
            value="{{ form.webdav_username }}"
          />
        </div>
        <div class="pv-field-group">
          <label for="webdav_password">Password / app token</label>
          <input
            id="webdav_password"
            name="webdav_password"
            type="password"
            value="{{ form.webdav_password }}"
            autocomplete="off"
          />
          <p class="pv-card-subtitle">
            Leave blank to keep the existing password or app token.
          </p>
        </div>
      </div>

      <div class="pv-field-group" style="margin-top: 1rem;">
        <button type="submit" class="pv-button-primary">Save storage settings</button>
      </div>
    </form>

    <div class="pv-card">
      <h2>Our storage providers</h2>
      <p class="pv-card-subtitle">
        Add one module for each storage destination you want to use. You can
        create multiple instances of the same provider type and target them by
        name from recording policies.
      </p>
      {% if edit_module %}
        <p class="pv-card-subtitle" style="margin-top: 0.25rem; color: #f97316;">
          Editing module <code>{{ edit_module.name }}</code>. Changes will apply
          to any cameras or policies that reference this module name.
        </p>
      {% endif %}

      {% if module_test_result %}
        <div
          class="pv-alert {% if module_test_result.ok %}pv-alert-success{% else %}pv-alert-error{% endif %}"
          role="status"
          style="margin-bottom: 0.75rem;"
        >
          <p>
            Module <code>{{ module_test_result.module_name }}</code>:
            {{ module_test_result.message }}
          </p>
        </div>
      {% endif %}

      {% set edit_cfg = edit_module_config or {} %}

      <form
        method="post"
        class="pv-form-grid"
        style="margin: 1rem 0 1.25rem 0; grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.4fr); gap: 0.75rem;"
      >
        <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />
        <input
          type="hidden"
          name="action"
          value="{{ 'module_update' if edit_module else 'module_create' }}"
        />
        {% if edit_module %}
          <input type="hidden" name="module_id" value="{{ edit_module.id }}" />
        {% endif %}

        <div>
          <label for="module_name">Module name</label>
          <input
            id="module_name"
            name="module_name"
            type="text"
            placeholder="e.g. s3:primary-archive"
            value="{{ edit_module.name if edit_module else '' }}"
            required
          />
          <p class="pv-card-subtitle" style="font-size: 0.75rem; margin-top: 0.25rem;">
            Unique key used by workers and per-camera policies. Use a stable,
            descriptive name; it must be unique.
          </p>
        </div>

        <div>
          <label for="module_label">Label</label>
          <input
            id="module_label"
            name="module_label"
            type="text"
            placeholder="e.g. Primary S3 archive"
            value="{{ edit_module.label if edit_module and edit_module.label else '' }}"
          />
          <p class="pv-card-subtitle" style="font-size: 0.75rem; margin-top: 0.25rem;">
            Optional human-friendly label shown in the UI.
          </p>
        </div>

        <div>
          <label for="module_provider">Provider</label>
          <select id="module_provider" name="module_provider" required {% if edit_module %}disabled{% endif %}>
            <option value="">Select provider…</option>
            <option value="local_fs" {% if edit_module and edit_module.provider_type == 'local_fs' %}selected{% endif %}>
              Local filesystem
            </option>
            <option value="s3" {% if edit_module and edit_module.provider_type == 's3' %}selected{% endif %}>
              S3-compatible
            </option>
            <option value="gcs" {% if edit_module and edit_module.provider_type == 'gcs' %}selected{% endif %}>
              Google Cloud Storage
            </option>
            <option value="azure_blob" {% if edit_module and edit_module.provider_type == 'azure_blob' %}selected{% endif %}>
              Azure Blob Storage
            </option>
            <option value="dropbox" {% if edit_module and edit_module.provider_type == 'dropbox' %}selected{% endif %}>
              Dropbox
            </option>
            <option value="webdav" {% if edit_module and edit_module.provider_type == 'webdav' %}selected{% endif %}>
              WebDAV / Nextcloud
            </option>
            <option value="gdrive" {% if edit_module and edit_module.provider_type == 'gdrive' %}selected{% endif %}>
              Google Drive
            </option>
            <option value="onedrive" {% if edit_module and edit_module.provider_type == 'onedrive' %}selected{% endif %}>
              Microsoft OneDrive / Graph
            </option>
            <option value="box" {% if edit_module and edit_module.provider_type == 'box' %}selected{% endif %}>
              Box
            </option>
            <option value="swift" {% if edit_module and edit_module.provider_type == 'swift' %}selected{% endif %}>
              OpenStack Swift / Rackspace Cloud Files
            </option>
            <option value="pcloud" {% if edit_module and edit_module.provider_type == 'pcloud' %}selected{% endif %}>
              pCloud
            </option>
            <option value="mega" {% if edit_module and edit_module.provider_type == 'mega' %}selected{% endif %}>
              MEGA (mega.nz)
            </option>
          </select>
          <div style="margin-top: 0.4rem; font-size: 0.8rem; color: #6b7280;">
            <label style="display: inline-flex; align-items: center; gap: 0.35rem;">
              <input type="checkbox" name="module_enabled" value="1" {% if not edit_module or edit_module.is_enabled %}checked{% endif %} />
              <span>Enabled</span>
            </label>
          </div>
        </div>

        <div>
          <div class="pv-module-config-group" data-provider="local_fs" style="display: none;">
            <label for="module_cfg_base_dir">Base directory</label>
            <input id="module_cfg_base_dir" name="module_cfg_base_dir" type="text" placeholder="/var/lib/pentavision/recordings" value="{{ edit_cfg.get('base_dir', '') if edit_module else '' }}"/>
            <p class="pv-card-subtitle" style="font-size: 0.75rem; margin-top: 0.25rem;">
              Optional override for the <code>local_fs</code> base directory.
            </p>
          </div>

          <div class="pv-module-config-group" data-provider="s3" style="display: none;">
            <label for="module_cfg_s3_bucket">S3 bucket</label>
            <input id="module_cfg_s3_bucket" name="module_cfg_s3_bucket" type="text" placeholder="my-recordings-bucket" value="{{ edit_cfg.get('bucket', '') if edit_module else '' }}"/>
            <label for="module_cfg_s3_endpoint" style="margin-top: 0.35rem;">Endpoint</label>
            <input id="module_cfg_s3_endpoint" name="module_cfg_s3_endpoint" type="text" placeholder="https://s3.amazonaws.com or custom endpoint" value="{{ edit_cfg.get('endpoint', '') if edit_module else '' }}"/>
            <label for="module_cfg_s3_region" style="margin-top: 0.35rem;">Region</label>
            <input id="module_cfg_s3_region" name="module_cfg_s3_region" type="text" placeholder="us-east-1" value="{{ edit_cfg.get('region', '') if edit_module else '' }}"/>
            <label for="module_cfg_s3_access_key" style="margin-top: 0.35rem;">Access key ID</label>
            <input id="module_cfg_s3_access_key" name="module_cfg_s3_access_key" type="password" autocomplete="off"/>
            <label for="module_cfg_s3_secret_key" style="margin-top: 0.35rem;">Secret access key</label>
            <input id="module_cfg_s3_secret_key" name="module_cfg_s3_secret_key" type="password" autocomplete="off"/>
          </div>

          <div class="pv-module-config-group" data-provider="gcs" style="display: none;">
            <label for="module_cfg_gcs_bucket">GCS bucket</label>
            <input id="module_cfg_gcs_bucket" name="module_cfg_gcs_bucket" type="text" placeholder="my-gcs-recordings" value="{{ edit_cfg.get('bucket', '') if edit_module else '' }}"/>
          </div>

          <div class="pv-module-config-group" data-provider="azure_blob" style="display: none;">
            <label for="module_cfg_azure_container">Container</label>
            <input id="module_cfg_azure_container" name="module_cfg_azure_container" type="text" value="{{ edit_cfg.get('container', '') if edit_module else '' }}"/>
            <label for="module_cfg_azure_connection_string" style="margin-top: 0.35rem;">Connection string</label>
            <input id="module_cfg_azure_connection_string" name="module_cfg_azure_connection_string" type="password" autocomplete="off"/>
          </div>

          <div class="pv-module-config-group" data-provider="dropbox" style="display: none;">
            <label for="module_cfg_dropbox_access_token">Access token</label>
            <input id="module_cfg_dropbox_access_token" name="module_cfg_dropbox_access_token" type="password" autocomplete="off"/>
          </div>

          <div class="pv-module-config-group" data-provider="webdav" style="display: none;">
            <label for="module_cfg_webdav_base_url">Base URL</label>
            <input id="module_cfg_webdav_base_url" name="module_cfg_webdav_base_url" type="text" placeholder="https://example.com/remote.php/dav/files/user" value="{{ edit_cfg.get('base_url', '') if edit_module else '' }}"/>
            <label for="module_cfg_webdav_username" style="margin-top: 0.35rem;">Username</label>
            <input id="module_cfg_webdav_username" name="module_cfg_webdav_username" type="text" value="{{ edit_cfg.get('username', '') if edit_module else '' }}"/>
            <label for="module_cfg_webdav_password" style="margin-top: 0.35rem;">Password / app token</label>
            <input id="module_cfg_webdav_password" name="module_cfg_webdav_password" type="password" autocomplete="off"/>
          </div>

          <div class="pv-module-config-group" data-provider="gdrive" style="display: none;">
            <label for="module_cfg_gdrive_access_token">Access token</label>
            <input id="module_cfg_gdrive_access_token" name="module_cfg_gdrive_access_token" type="password" autocomplete="off"/>
            <label for="module_cfg_gdrive_folder_id" style="margin-top: 0.35rem;">Folder ID (optional)</label>
            <input id="module_cfg_gdrive_folder_id" name="module_cfg_gdrive_folder_id" type="text" placeholder="Drive folder ID" value="{{ edit_cfg.get('folder_id', '') if edit_module else '' }}"/>
          </div>

          <div class="pv-module-config-group" data-provider="onedrive" style="display: none;">
            <label for="module_cfg_onedrive_access_token">Access token</label>
            <input id="module_cfg_onedrive_access_token" name="module_cfg_onedrive_access_token" type="password" autocomplete="off"/>
            <label for="module_cfg_onedrive_root_path" style="margin-top: 0.35rem;">Root path (optional)</label>
            <input id="module_cfg_onedrive_root_path" name="module_cfg_onedrive_root_path" type="text" placeholder="e.g. Recordings/PentaVision" value="{{ edit_cfg.get('root_path', '') if edit_module else '' }}"/>
          </div>

          <div class="pv-module-config-group" data-provider="box" style="display: none;">
            <label for="module_cfg_box_access_token">Access token</label>
            <input id="module_cfg_box_access_token" name="module_cfg_box_access_token" type="password" autocomplete="off"/>
            <label for="module_cfg_box_folder_id" style="margin-top: 0.35rem;">Folder ID</label>
            <input id="module_cfg_box_folder_id" name="module_cfg_box_folder_id" type="text" placeholder="0 for root, or a folder id" value="{{ edit_cfg.get('folder_id', '') if edit_module else '' }}"/>
          </div>

          <div class="pv-module-config-group" data-provider="swift" style="display: none;">
            <label for="module_cfg_swift_storage_url">Storage URL</label>
            <input id="module_cfg_swift_storage_url" name="module_cfg_swift_storage_url" type="text" placeholder="https://auth.example.com/v1/AUTH_account" value="{{ edit_cfg.get('storage_url', '') if edit_module else '' }}"/>
            <label for="module_cfg_swift_auth_token" style="margin-top: 0.35rem;">Auth token</label>
            <input id="module_cfg_swift_auth_token" name="module_cfg_swift_auth_token" type="password" autocomplete="off"/>
            <label for="module_cfg_swift_container" style="margin-top: 0.35rem;">Container</label>
            <input id="module_cfg_swift_container" name="module_cfg_swift_container" type="text" placeholder="recordings" value="{{ edit_cfg.get('container', '') if edit_module else '' }}"/>
          </div>

          <div class="pv-module-config-group" data-provider="pcloud" style="display: none;">
            <label for="module_cfg_pcloud_access_token">Access token</label>
            <input id="module_cfg_pcloud_access_token" name="module_cfg_pcloud_access_token" type="password" autocomplete="off"/>
            <label for="module_cfg_pcloud_path" style="margin-top: 0.35rem;">Folder path</label>
            <input id="module_cfg_pcloud_path" name="module_cfg_pcloud_path" type="text" placeholder="/PentaVision/Recordings" value="{{ edit_cfg.get('path', '') if edit_module else '' }}"/>
          </div>

          <div class="pv-module-config-group" data-provider="mega" style="display: none;">
            <label for="module_cfg_mega_email">MEGA account email</label>
            <input id="module_cfg_mega_email" name="module_cfg_mega_email" type="email" value="{{ edit_cfg.get('email', '') if edit_module else '' }}"/>
            <label for="module_cfg_mega_password" style="margin-top: 0.35rem;">MEGA account password</label>
            <input id="module_cfg_mega_password" name="module_cfg_mega_password" type="password" autocomplete="off"/>
            <label for="module_cfg_mega_folder_name" style="margin-top: 0.35rem;">Folder name (optional)</label>
            <input id="module_cfg_mega_folder_name" name="module_cfg_mega_folder_name" type="text" placeholder="e.g. PentaVisionRecordings" value="{{ edit_cfg.get('folder_name', '') if edit_module else '' }}"/>
          </div>
        </div>

        <div style="grid-column: 1 / -1; text-align: right; margin-top: 0.25rem;">
          <button type="submit" class="pv-button-primary">
            {% if edit_module %}Save changes{% else %}Add module{% endif %}
          </button>
        </div>
      </form>

      {% if modules %}
        <table class="pv-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Label</th>
              <th>Provider</th>
              <th>Enabled</th>
              <th>Status</th>
              <th style="width: 1%; white-space: nowrap;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for m in modules %}
              <tr>
                <td><code>{{ m.name }}</code></td>
                <td>{{ m.label }}</td>
                <td><code>{{ m.provider_type }}</code></td>
                <td>
                  {% if m.is_enabled %}
                    Enabled
                  {% else %}
                    Disabled
                  {% endif %}
                </td>
                <td>
                  {{ m.status or 'n/a' }}
                  {% if m.status_message %}
                    <div
                      style="font-size: 0.8rem; color: #9ca3af; margin-top: 0.15rem;"
                    >
                      {{ m.status_message }}
                    </div>
                  {% endif %}
                </td>
                <td style="white-space: nowrap;">
                  <form
                    method="post"
                    class="pv-inline-form"
                    style="margin-bottom: 0.2rem;"
                  >
                    <input
                      type="hidden"
                      name="csrf_token"
                      value="{{ global_csrf_token }}"
                    />
                    <input type="hidden" name="action" value="module_test" />
                    <input type="hidden" name="module_id" value="{{ m.id }}" />
                    <button
                      type="submit"
                      class="pv-button-secondary"
                      style="padding: 0.15rem 0.6rem; font-size: 0.8rem;"
                    >
                      Test
                    </button>
                  </form>
                  <form
                    method="post"
                    class="pv-inline-form"
                    style="margin-bottom: 0.2rem;"
                  >
                    <input
                      type="hidden"
                      name="csrf_token"
                      value="{{ global_csrf_token }}"
                    />
                    <input type="hidden" name="action" value="module_toggle" />
                    <input type="hidden" name="module_id" value="{{ m.id }}" />
                    <input
                      type="hidden"
                      name="enable"
                      value="{% if m.is_enabled %}0{% else %}1{% endif %}"
                    />
                    <button
                      type="submit"
                      class="pv-button-secondary"
                      style="padding: 0.15rem 0.6rem; font-size: 0.8rem;"
                    >
                      {% if m.is_enabled %}Disable{% else %}Enable{% endif %}
                    </button>
                  </form>
                  <a
                    href="{{ url_for('main.storage_settings', edit_module=m.id) }}"
                    class="pv-button-secondary"
                    style="padding: 0.15rem 0.6rem; font-size: 0.8rem; margin-left: 0.15rem;"
                  >
                    Edit
                  </a>
                  <form method="post" class="pv-inline-form">
                    <input
                      type="hidden"
                      name="csrf_token"
                      value="{{ global_csrf_token }}"
                    />
                    <input type="hidden" name="action" value="module_delete" />
                    <input type="hidden" name="module_id" value="{{ m.id }}" />
                    <button
                      type="submit"
                      class="pv-button-secondary"
                      style="padding: 0.15rem 0.6rem; font-size: 0.8rem; margin-left: 0.15rem;"
                    >
                      Delete
                    </button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p style="font-size: 0.9rem; color: #9ca3af;">
          No storage modules are defined yet. Use the form above to add a
          module for each storage destination you want to target.
        </p>
      {% endif %}
    </div>

    <div class="pv-card" style="margin-top: 1.5rem;">
      <h2>Active providers</h2>
      {% if providers %}
        <table class="pv-table">
          <thead>
            <tr>
              <th>Provider</th>
              <th>Type</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            {% for p in providers %}
              <tr>
                <td><code>{{ p.name }}</code></td>
                <td>{{ p.type }}</td>
                <td style="font-size: 0.85rem; color: #9ca3af;">
                  {{ p.details }}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p style="font-size: 0.9rem; color: #9ca3af;">
          No storage providers are currently active. Update the
          <em>Active targets</em> field above to include one or more of
          <code>local_fs</code>, <code>db</code>, <code>s3</code>,
          <code>gcs</code>, <code>azure_blob</code>, <code>dropbox</code>, or
          <code>webdav</code>.
        </p>
      {% endif %}
    </div>

    <div class="pv-card" style="margin-top: 1.5rem;">
      <h2>S3-compatible configuration (effective)</h2>
      <p style="font-size: 0.85rem; color: #9ca3af;">
        Effective configuration after combining database settings and
        environment defaults (secrets are masked):
      </p>
      <ul style="font-size: 0.85rem; color: #9ca3af;">
        <li><code>S3_BUCKET</code> – bucket name (required).</li>
        <li><code>S3_ENDPOINT</code> – endpoint URL (optional for AWS S3, required for most third-party providers).</li>
        <li><code>S3_REGION</code> – region (optional if your endpoint implies it).</li>
        <li><code>S3_ACCESS_KEY</code> – access key ID.</li>
        <li><code>S3_SECRET_KEY</code> – secret access key.</li>
      </ul>
      <p style="font-size: 0.85rem; color: #9ca3af; margin-top: 0.5rem;">
        Current S3-related configuration (secrets are masked):
      </p>
      <pre style="font-size: 0.8rem; white-space: pre-wrap;">
Bucket: {{ s3.bucket or 'not set' }}
Endpoint: {{ s3.endpoint or 'not set' }}
Region: {{ s3.region or 'not set' }}
Access key: {{ s3.access_key_masked or 'not set' }}
Secret key: {{ s3.secret_key_masked or 'not set' }}
      </pre>
    </div>

    <div class="pv-card" style="margin-top: 1.5rem;">
      <h2>Google Cloud Storage (effective)</h2>
      <p style="font-size: 0.85rem; color: #9ca3af;">
        Effective GCS configuration (bucket only; credentials are provided via
        the host environment, for example
        <code>GOOGLE_APPLICATION_CREDENTIALS</code>).
      </p>
      <pre style="font-size: 0.8rem; white-space: pre-wrap;">
Bucket: {{ gcs.bucket or 'not set' }}
      </pre>
    </div>

    <div class="pv-card" style="margin-top: 1.5rem;">
      <h2>Azure Blob Storage (effective)</h2>
      <p style="font-size: 0.85rem; color: #9ca3af;">
        Effective Azure configuration (secrets are masked):
      </p>
      <pre style="font-size: 0.8rem; white-space: pre-wrap;">
Container: {{ azure.container or 'not set' }}
Connection string: {{ azure.connection_string_masked or 'not set' }}
      </pre>
    </div>

    <div class="pv-card" style="margin-top: 1.5rem;">
      <h2>Dropbox (effective)</h2>
      <p style="font-size: 0.85rem; color: #9ca3af;">
        Effective Dropbox configuration (token is masked):
      </p>
      <pre style="font-size: 0.8rem; white-space: pre-wrap;">
Access token: {{ dropbox.access_token_masked or 'not set' }}
      </pre>
    </div>

    <div class="pv-card" style="margin-top: 1.5rem;">
      <h2>WebDAV / Nextcloud (effective)</h2>
      <p style="font-size: 0.85rem; color: #9ca3af;">
        Effective WebDAV configuration (password is masked):
      </p>
      <pre style="font-size: 0.8rem; white-space: pre-wrap;">
Base URL: {{ webdav.base_url or 'not set' }}
Username: {{ webdav.username or 'not set' }}
Password: {{ webdav.password_masked or 'not set' }}
      </pre>
    </div>
  </section>

  <script>
    (function () {
      var select = document.getElementById('module_provider');
      if (!select) return;
      function updateModuleConfig() {
        var value = select.value || '';
        var groups = document.querySelectorAll('.pv-module-config-group');
        groups.forEach(function (el) {
          var target = (el.getAttribute('data-provider') || '').trim();
          el.style.display = target && target === value ? '' : 'none';
        });
      }
      select.addEventListener('change', updateModuleConfig);
      updateModuleConfig();
    })();
  </script>
{% endblock %}
