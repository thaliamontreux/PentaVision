{% extends 'base.html' %}

{% block title %}Recording · PentaVision{% endblock %}

{% block content %}
  <section class="pv-section">
    {% if is_system_admin or is_technician %}
      <div class="pv-admin-layout">
        {% include 'admin/_nav.html' %}
        <div class="pv-admin-main">
          <h1>Recording playback</h1>
    {% else %}
          <h1>Recording playback</h1>
    {% endif %}

    {% if not recording %}
      <p class="pv-text-sm pv-text-muted">
        Recording not found.
      </p>
      <p>
        <a href="{{ url_for('main.recordings') }}" class="pv-link-muted">
          Back to recordings
        </a>
      </p>
    {% else %}

    <p class="pv-card-subtitle pv-mb-4">
      Use the controls below to play the recording and analyze individual frames
      for recognized faces. Overlays are drawn client-side using the same
      recognition engine as the live view.
    </p>

    <div class="pv-dashboard-grid pv-dashboard-grid-playback">
      <div class="pv-card">
        <h2>Playback</h2>
        <div class="pv-video-container">
          <video
            id="rec-video"
            class="pv-video-player"
            controls
          >
            <source src="{{ url_for('main.download_camera_recording', recording_id=recording.id, transcode=1) }}" type="video/mp4" />
            Your browser does not support the video tag.
          </video>
          <canvas id="rec-overlay" class="pv-video-overlay"></canvas>
        </div>
        <button
          type="button"
          class="pv-button pv-mt-3"
          id="rec-analyze-btn"
        >
          Analyze current frame
        </button>
        <p class="pv-card-subtitle pv-mt-3">
          The current frame is captured in the browser, sent to the face
          recognition API, and any matches are overlaid on top of the video.
        </p>
      </div>

      <div class="pv-card pv-card-narrow">
        <h2>Recording details</h2>
        <ul class="pv-status-list">
          <li>
            <span>Time ({{ current_timezone }})</span>
            <span>{{ recording.created_at|local_dt }}</span>
          </li>
          <li>
            <span>Camera</span>
            {% if device %}
              <span>{{ device.name }}</span>
            {% else %}
              <span>Unknown</span>
            {% endif %}
          </li>
          <li>
            <span>Provider</span>
            <span>{{ recording.storage_provider }}</span>
          </li>
        </ul>
        <p class="pv-mt-4 pv-text-sm">
          <a href="{{ url_for('main.recordings') }}" class="pv-link-muted">
            Back to recordings list
          </a>
        </p>
      </div>
    </div>

    <div class="pv-card pv-mt-5">
      <h2>Face recognition results</h2>
      <pre id="rec-output" class="pv-output-pre" aria-live="polite"></pre>
    </div>

    <canvas id="rec-canvas" style="display: none;"></canvas>
    {% endif %}

    {% if is_system_admin or is_technician %}
        </div>
      </div>
    {% endif %}
  </section>

  <script>
    (function () {
      var video = document.getElementById('rec-video');
      var overlay = document.getElementById('rec-overlay');
      var canvas = document.getElementById('rec-canvas');
      var outputEl = document.getElementById('rec-output');
      var analyzeBtn = document.getElementById('rec-analyze-btn');

      function setOutput(value) {
        if (!outputEl) return;
        if (typeof value === 'string') {
          outputEl.textContent = value;
        } else {
          try {
            outputEl.textContent = JSON.stringify(value, null, 2);
          } catch (e) {
            outputEl.textContent = String(value);
          }
        }
      }

      function apiPostJson(url, body) {
        return fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify(body || {})
        }).then(function (resp) {
          return resp.json().catch(function () {
            return { error: 'invalid JSON response', status: resp.status };
          });
        });
      }

      function captureFrameAsDataUrl() {
        if (!video || !canvas) return null;
        var w = video.videoWidth || 640;
        var h = video.videoHeight || 360;
        if (!w || !h) return null;
        canvas.width = w;
        canvas.height = h;
        var ctx = canvas.getContext('2d');
        if (!ctx) return null;
        ctx.drawImage(video, 0, 0, w, h);
        return canvas.toDataURL('image/jpeg', 0.9);
      }

      function clearOverlay() {
        if (!overlay) return;
        var ctx = overlay.getContext('2d');
        if (!ctx) return;
        ctx.clearRect(0, 0, overlay.width || 0, overlay.height || 0);
      }

      function drawFacesOverlay(faces, imageWidth, imageHeight) {
        if (!overlay || !video) return;
        var w = video.clientWidth || overlay.clientWidth || 0;
        var h = video.clientHeight || overlay.clientHeight || 0;
        if (!w || !h || !imageWidth || !imageHeight) return;

        overlay.width = w;
        overlay.height = h;
        var ctx = overlay.getContext('2d');
        if (!ctx) return;
        ctx.clearRect(0, 0, w, h);
        ctx.strokeStyle = '#22c55e';
        ctx.lineWidth = 2;
        ctx.font = '12px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
        ctx.fillStyle = 'rgba(34,197,94,0.7)';

        var scaleX = w / imageWidth;
        var scaleY = h / imageHeight;

        faces.forEach(function (face) {
          var top = face.top;
          var right = face.right;
          var bottom = face.bottom;
          var left = face.left;
          var label = face.email || (face.user_id != null ? ('ID ' + face.user_id) : 'Unknown');
          var distance = typeof face.distance === 'number' ? face.distance.toFixed(2) : null;

          var x = left * scaleX;
          var y = top * scaleY;
          var fw = (right - left) * scaleX;
          var fh = (bottom - top) * scaleY;

          ctx.strokeRect(x, y, fw, fh);
          var text = label + (distance ? (' [' + distance + ']') : '');
          var tw = ctx.measureText(text).width + 6;
          var th = 14;
          ctx.fillRect(x, y - th, tw, th);
          ctx.fillStyle = '#0b1120';
          ctx.fillText(text, x + 3, y - 3);
          ctx.fillStyle = 'rgba(34,197,94,0.7)';
        });
      }

      if (analyzeBtn) {
        analyzeBtn.addEventListener('click', function () {
          var dataUrl = captureFrameAsDataUrl();
          if (!dataUrl) {
            setOutput('No video frame available yet. Start playback and try again.');
            return;
          }
          analyzeBtn.disabled = true;
          var originalText = analyzeBtn.textContent;
          analyzeBtn.textContent = 'Analyzing…';
          clearOverlay();

          apiPostJson('{{ url_for("main.face_recognize") }}', {
            image: dataUrl
          }).then(function (data) {
            setOutput(data);
            if (data && Array.isArray(data.faces) && data.faces.length) {
              drawFacesOverlay(
                data.faces,
                data.image_width || 0,
                data.image_height || 0
              );
            } else {
              clearOverlay();
            }
          }).catch(function (err) {
            setOutput(String(err));
            clearOverlay();
          }).finally(function () {
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = originalText;
          });
        });
      }
    })();
  </script>
{% endblock %}
