{% extends 'base.html' %}

{% block title %}Recording ¬∑ PentaVision{% endblock %}

{% block content %}
  <section class="pv-section">
    {% if is_system_admin or is_technician %}
      <div class="pv-admin-layout">
        {% include 'admin/_nav.html' %}
        <div class="pv-admin-main">
          <h1>Recording playback</h1>
    {% else %}
      <div class="pv-playback-header">
        <a href="{{ url_for('main.recordings') }}" class="pv-back-link">‚Üê Back to Recordings</a>
        <h1 class="pv-playback-title">Recording Playback</h1>
        {% if device %}
          <p class="pv-playback-subtitle">{{ device.name }} ¬∑ {{ recording.created_at|local_dt if recording else '' }}</p>
        {% endif %}
      </div>
    {% endif %}

    {% if not recording %}
      <div class="pv-empty">
        <p class="pv-empty-title">Recording not found</p>
        <p class="pv-empty-subtitle">This recording may have been deleted or is no longer available.</p>
        <div class="pv-empty-actions">
          <a href="{{ url_for('main.recordings') }}" class="pv-button">Back to Recordings</a>
        </div>
      </div>
    {% else %}

    {% if is_system_admin or is_technician %}
    <p class="pv-card-subtitle pv-mb-4">
      Use the controls below to play the recording and analyze individual frames
      for recognized faces. Overlays are drawn client-side using the same
      recognition engine as the live view.
    </p>

    <div class="pv-dashboard-grid pv-dashboard-grid-playback">
      <div class="pv-card">
        <h2>Playback</h2>
        <div class="pv-video-container">
          <video
            id="rec-video"
            class="pv-video-player"
            controls
          >
            <source src="{{ url_for('main.download_camera_recording', recording_id=recording.id) }}" type="video/mp4" />
            Your browser does not support the video tag.
          </video>
          <canvas id="rec-overlay" class="pv-video-overlay"></canvas>
        </div>
        <button
          type="button"
          class="pv-button pv-mt-3"
          id="rec-analyze-btn"
        >
          Analyze current frame
        </button>
        <p class="pv-card-subtitle pv-mt-3">
          The current frame is captured in the browser, sent to the face
          recognition API, and any matches are overlaid on top of the video.
        </p>
      </div>

      <div class="pv-card pv-card-narrow">
        <h2>Recording details</h2>
        <ul class="pv-status-list">
          <li>
            <span>Time ({{ current_timezone }})</span>
            <span>{{ recording.created_at|local_dt }}</span>
          </li>
          <li>
            <span>Camera</span>
            {% if device %}
              <span>{{ device.name }}</span>
            {% else %}
              <span>Unknown</span>
            {% endif %}
          </li>
          <li>
            <span>Provider</span>
            <span>{{ recording.storage_provider }}</span>
          </li>
        </ul>
        <p class="pv-mt-4 pv-text-sm">
          <a href="{{ url_for('main.recordings') }}" class="pv-link-muted">
            Back to recordings list
          </a>
        </p>
      </div>
    </div>

    <div class="pv-card pv-mt-5">
      <h2>Face recognition results</h2>
      <pre id="rec-output" class="pv-output-pre" aria-live="polite"></pre>
    </div>
    {% else %}
    <div class="pv-player-shell">
      <div class="pv-player-main">
        <div class="pv-player-video-wrap">
          <video
            id="rec-video"
            class="pv-player-video"
            controls
            autoplay
          >
            <source src="{{ url_for('main.download_camera_recording', recording_id=recording.id) }}" type="video/mp4" />
            Your browser does not support the video tag.
          </video>
          <canvas id="rec-overlay" class="pv-video-overlay"></canvas>
        </div>
        <div class="pv-player-controls">
          <div class="pv-player-nav">
            {% if prev_recording_id %}
              <a href="{{ url_for('main.recording_detail', recording_id=prev_recording_id, autoplay=1) }}" class="pv-player-nav-btn" title="Previous recording">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                Previous
              </a>
            {% else %}
              <span class="pv-player-nav-btn pv-player-nav-disabled">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
                Previous
              </span>
            {% endif %}

            <label class="pv-player-autoplay-toggle">
              <input type="checkbox" id="autoplay-toggle" {% if autoplay %}checked{% endif %}>
              <span class="pv-player-autoplay-label">Auto-play next</span>
            </label>

            {% if next_recording_id %}
              <a href="{{ url_for('main.recording_detail', recording_id=next_recording_id, autoplay=1) }}" class="pv-player-nav-btn" id="next-btn" title="Next recording">
                Next
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
              </a>
            {% else %}
              <span class="pv-player-nav-btn pv-player-nav-disabled">
                Next
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>
              </span>
            {% endif %}
          </div>
        </div>
      </div>
      <div class="pv-player-sidebar">
        <div class="pv-player-info-card">
          <h3 class="pv-player-info-title">Recording Info</h3>
          <div class="pv-player-info-row">
            <span class="pv-player-info-label">Camera</span>
            <span class="pv-player-info-value">{% if device %}{{ device.name }}{% else %}Unknown{% endif %}</span>
          </div>
          <div class="pv-player-info-row">
            <span class="pv-player-info-label">Time</span>
            <span class="pv-player-info-value">{{ recording.created_at|local_dt }}</span>
          </div>
          <div class="pv-player-info-row">
            <span class="pv-player-info-label">Storage</span>
            <span class="pv-player-info-value">{{ recording.storage_provider }}</span>
          </div>
        </div>
        <div class="pv-player-actions">
          <a href="{{ url_for('main.download_camera_recording', recording_id=recording.id, download=1) }}" class="pv-player-btn pv-player-btn-download">
            ‚Üì Download Recording
          </a>
          <button type="button" class="pv-player-btn pv-player-btn-analyze" id="rec-analyze-btn">
            üîç Analyze Faces
          </button>
        </div>
        <div class="pv-player-results">
          <h4 class="pv-player-results-title">Face Recognition</h4>
          <pre id="rec-output" class="pv-player-output" aria-live="polite">Click "Analyze Faces" to scan the current frame.</pre>
        </div>
      </div>
    </div>
    {% endif %}

    <canvas id="rec-canvas" class="pv-hidden"></canvas>
    {% endif %}

    {% if is_system_admin or is_technician %}
        </div>
      </div>
    {% endif %}
  </section>

  <script>
    (function () {
      var video = document.getElementById('rec-video');
      var overlay = document.getElementById('rec-overlay');
      var canvas = document.getElementById('rec-canvas');
      var outputEl = document.getElementById('rec-output');
      var analyzeBtn = document.getElementById('rec-analyze-btn');
      var autoplayToggle = document.getElementById('autoplay-toggle');
      var nextBtn = document.getElementById('next-btn');

      // Auto-play next recording when current ends
      if (video && autoplayToggle && nextBtn) {
        video.addEventListener('ended', function () {
          if (autoplayToggle.checked) {
            // Navigate to next recording with autoplay enabled
            window.location.href = nextBtn.href;
          }
        });
      }

      // Persist autoplay preference in localStorage
      if (autoplayToggle) {
        var savedAutoplay = localStorage.getItem('pv_recording_autoplay');
        if (savedAutoplay === 'true') {
          autoplayToggle.checked = true;
        } else if (savedAutoplay === 'false') {
          autoplayToggle.checked = false;
        }
        // If URL has autoplay=1, override
        if (window.location.search.indexOf('autoplay=1') !== -1) {
          autoplayToggle.checked = true;
        }

        autoplayToggle.addEventListener('change', function () {
          localStorage.setItem('pv_recording_autoplay', autoplayToggle.checked ? 'true' : 'false');
        });
      }

      function setOutput(value) {
        if (!outputEl) return;
        if (typeof value === 'string') {
          outputEl.textContent = value;
        } else {
          try {
            outputEl.textContent = JSON.stringify(value, null, 2);
          } catch (e) {
            outputEl.textContent = String(value);
          }
        }
      }

      function apiPostJson(url, body) {
        return fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify(body || {})
        }).then(function (resp) {
          return resp.json().catch(function () {
            return { error: 'invalid JSON response', status: resp.status };
          });
        });
      }

      function captureFrameAsDataUrl() {
        if (!video || !canvas) return null;
        var w = video.videoWidth || 640;
        var h = video.videoHeight || 360;
        if (!w || !h) return null;
        canvas.width = w;
        canvas.height = h;
        var ctx = canvas.getContext('2d');
        if (!ctx) return null;
        ctx.drawImage(video, 0, 0, w, h);
        return canvas.toDataURL('image/jpeg', 0.9);
      }

      function clearOverlay() {
        if (!overlay) return;
        var ctx = overlay.getContext('2d');
        if (!ctx) return;
        ctx.clearRect(0, 0, overlay.width || 0, overlay.height || 0);
      }

      function drawFacesOverlay(faces, imageWidth, imageHeight) {
        if (!overlay || !video) return;
        var w = video.clientWidth || overlay.clientWidth || 0;
        var h = video.clientHeight || overlay.clientHeight || 0;
        if (!w || !h || !imageWidth || !imageHeight) return;

        overlay.width = w;
        overlay.height = h;
        var ctx = overlay.getContext('2d');
        if (!ctx) return;
        ctx.clearRect(0, 0, w, h);
        ctx.strokeStyle = '#22c55e';
        ctx.lineWidth = 2;
        ctx.font = '12px system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';
        ctx.fillStyle = 'rgba(34,197,94,0.7)';

        var scaleX = w / imageWidth;
        var scaleY = h / imageHeight;

        faces.forEach(function (face) {
          var top = face.top;
          var right = face.right;
          var bottom = face.bottom;
          var left = face.left;
          var label = face.email || (face.user_id != null ? ('ID ' + face.user_id) : 'Unknown');
          var distance = typeof face.distance === 'number' ? face.distance.toFixed(2) : null;

          var x = left * scaleX;
          var y = top * scaleY;
          var fw = (right - left) * scaleX;
          var fh = (bottom - top) * scaleY;

          ctx.strokeRect(x, y, fw, fh);
          var text = label + (distance ? (' [' + distance + ']') : '');
          var tw = ctx.measureText(text).width + 6;
          var th = 14;
          ctx.fillRect(x, y - th, tw, th);
          ctx.fillStyle = '#0b1120';
          ctx.fillText(text, x + 3, y - 3);
          ctx.fillStyle = 'rgba(34,197,94,0.7)';
        });
      }

      if (analyzeBtn) {
        analyzeBtn.addEventListener('click', function () {
          var dataUrl = captureFrameAsDataUrl();
          if (!dataUrl) {
            setOutput('No video frame available yet. Start playback and try again.');
            return;
          }
          analyzeBtn.disabled = true;
          var originalText = analyzeBtn.textContent;
          analyzeBtn.textContent = 'Analyzing‚Ä¶';
          clearOverlay();

          apiPostJson('{{ url_for("main.face_recognize") }}', {
            image: dataUrl
          }).then(function (data) {
            setOutput(data);
            if (data && Array.isArray(data.faces) && data.faces.length) {
              drawFacesOverlay(
                data.faces,
                data.image_width || 0,
                data.image_height || 0
              );
            } else {
              clearOverlay();
            }
          }).catch(function (err) {
            setOutput(String(err));
            clearOverlay();
          }).finally(function () {
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = originalText;
          });
        });
      }
    })();
  </script>
{% endblock %}
