{% extends 'base.html' %}

{% block title %}Property Roles · {{ prop.name }} · PentaVision{% endblock %}

{% block content %}
  <section class="pv-section">
    <div class="pv-page-header">
      <div>
        <h1 class="pv-page-title">Property Roles</h1>
        <p class="pv-page-subtitle">{{ prop.name }} · Manage role assignments for property users</p>
      </div>
      <div class="pv-page-actions">
        <a href="{{ url_for('pm.property_users', property_id=prop.id) }}" class="pv-button">
          Back to Users
        </a>
      </div>
    </div>

    {% if errors %}
      <div class="pv-alert pv-alert-error pv-mb-4" role="alert">
        <ul>
          {% for error in errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    {% if property_users %}
      <div class="pv-card">
        <div class="pv-card-header">
          <h2>User Role Assignments</h2>
          <p class="pv-card-subtitle">Assign property-scoped roles to users</p>
        </div>

        <div class="pv-table-wrap">
          <table class="pv-table">
            <thead>
              <tr>
                <th>Username</th>
                <th>Full Name</th>
                <th>Status</th>
                <th>Assigned Roles</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for pu in property_users %}
                <tr>
                  <td><strong>{{ pu.username }}</strong></td>
                  <td>{{ pu.full_name or '—' }}</td>
                  <td>
                    {% if pu.is_active %}
                      <span class="pv-badge pv-badge-success">Active</span>
                    {% else %}
                      <span class="pv-badge pv-badge-muted">Inactive</span>
                    {% endif %}
                  </td>
                  <td>
                    {% set assigned_role_ids = user_roles_map.get(pu.id, []) %}
                    {% if assigned_role_ids %}
                      {% for role in all_roles %}
                        {% if role.id in assigned_role_ids %}
                          <span class="pv-badge pv-badge-primary pv-mr-1">{{ role.name }}</span>
                        {% endif %}
                      {% endfor %}
                    {% else %}
                      <span class="pv-text-muted">No roles assigned</span>
                    {% endif %}
                  </td>
                  <td>
                    <button
                      type="button"
                      class="pv-button pv-button-sm"
                      onclick="openRoleModal('{{ pu.uid }}', '{{ pu.username }}', {{ assigned_role_ids|tojson }})"
                    >
                      Manage Roles
                    </button>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    {% else %}
      <div class="pv-empty">
        <svg class="pv-empty-icon" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        <p class="pv-empty-title">No property users found</p>
        <p class="pv-empty-subtitle">Create property users first to assign roles</p>
        <a href="{{ url_for('pm.property_users', property_id=prop.id) }}" class="pv-button pv-button-primary pv-mt-3">
          Go to Users
        </a>
      </div>
    {% endif %}

    {% if all_roles %}
      <div class="pv-card pv-mt-5">
        <div class="pv-card-header">
          <h2>Available Roles</h2>
          <p class="pv-card-subtitle">Roles that can be assigned to property users</p>
        </div>
        <div class="pv-role-list">
          {% for role in all_roles %}
            <div class="pv-role-card">
              <div class="pv-role-card-header">
                <h3 class="pv-role-card-title">{{ role.name }}</h3>
                {% if role.scope %}
                  <span class="pv-badge pv-badge-muted">{{ role.scope }}</span>
                {% endif %}
              </div>
              {% if role.description %}
                <p class="pv-role-card-description">{{ role.description }}</p>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  </section>

  <div id="roleModal" class="pv-modal" style="display: none;">
    <div class="pv-modal-dialog">
      <div class="pv-modal-header">
        <h2 class="pv-modal-title">Manage Roles</h2>
        <button type="button" class="pv-modal-close" onclick="closeRoleModal()">&times;</button>
      </div>
      <form id="roleForm" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="pv-modal-body">
          <p class="pv-mb-3">
            <strong>User:</strong> <span id="modalUsername"></span>
          </p>
          <div class="pv-field-group">
            <label class="pv-label">Assigned Roles</label>
            <div class="pv-checkbox-group">
              {% for role in all_roles %}
                <label class="pv-checkbox-label">
                  <input
                    type="checkbox"
                    name="role_ids"
                    value="{{ role.id }}"
                    class="role-checkbox"
                  >
                  <span>{{ role.name }}</span>
                  {% if role.description %}
                    <span class="pv-text-muted pv-text-sm"> — {{ role.description }}</span>
                  {% endif %}
                </label>
              {% endfor %}
            </div>
          </div>
        </div>
        <div class="pv-modal-footer">
          <button type="button" class="pv-button" onclick="closeRoleModal()">Cancel</button>
          <button type="submit" class="pv-button pv-button-primary">Save Roles</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function openRoleModal(userUid, username, assignedRoleIds) {
      document.getElementById('modalUsername').textContent = username;
      
      var form = document.getElementById('roleForm');
      form.action = '{{ url_for("pm.property_user_roles_update", property_id=prop.id, property_user_uid="__UID__") }}'.replace('__UID__', userUid);
      
      var checkboxes = document.querySelectorAll('.role-checkbox');
      checkboxes.forEach(function(cb) {
        cb.checked = assignedRoleIds.includes(parseInt(cb.value));
      });
      
      document.getElementById('roleModal').style.display = 'flex';
    }

    function closeRoleModal() {
      document.getElementById('roleModal').style.display = 'none';
    }

    window.onclick = function(event) {
      var modal = document.getElementById('roleModal');
      if (event.target === modal) {
        closeRoleModal();
      }
    };
  </script>
{% endblock %}
