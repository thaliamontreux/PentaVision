{% extends 'base.html' %}

{% block title %}{{ prop.name }} Users ¬∑ PentaVision{% endblock %}

{% block content %}
  <section class="pv-section">
    <div class="pv-page-header">
      <div>
        <a href="{{ url_for('pm.index') }}" class="pv-back-link">‚Üê Back to Properties</a>
        <h1 class="pv-page-title">{{ prop.name }} Users</h1>
        <p class="pv-page-subtitle">Manage property-local users with password and optional 8-digit PIN access.</p>
      </div>
      <div class="pv-page-actions">
        <a href="{{ url_for('pm.property_roles', property_id=prop.id) }}" class="pv-button pv-button-primary">
          Manage Roles
        </a>
      </div>
    </div>

    {% if errors %}
      <div class="pv-alert pv-alert-error pv-mb-4" role="alert">
        <ul>
          {% for error in errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <div class="pv-pm-users-layout">
      <div class="pv-pm-create-card">
        <div class="pv-pm-create-header">
          <span class="pv-pm-create-icon">‚ûï</span>
          <h3 class="pv-pm-create-title">Create New User</h3>
        </div>
        <form method="post" action="{{ url_for('pm.property_users_create', property_id=prop.id) }}" class="pv-pm-create-form">
          <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />

          <div class="pv-field-group">
            <label for="pvPuUsername">Username</label>
            <input id="pvPuUsername" name="username" autocomplete="username" required />
          </div>

          <div class="pv-field-group">
            <label for="pvPuFullName">Full name</label>
            <input id="pvPuFullName" name="full_name" autocomplete="name" />
          </div>

          <div class="pv-field-group">
            <label for="pvPuPassword">Password</label>
            <input id="pvPuPassword" name="password" type="password" autocomplete="new-password" required />
          </div>

          <div class="pv-field-group">
            <label for="pvPuPin">PIN (optional, 8 digits)</label>
            <input id="pvPuPin" name="pin" inputmode="numeric" pattern="\d{8}" maxlength="8" autocomplete="off" placeholder="12345678" />
          </div>

          <button class="pv-pm-btn pv-pm-btn-primary pv-pm-btn-full" type="submit">Create User</button>
        </form>

        {% if is_system_admin or is_property_admin %}
          <div class="pv-pm-create-divider"></div>
          <form
            method="post"
            action="{{ url_for('pm.property_users_migrate_legacy', property_id=prop.id) }}"
            onsubmit="return confirm('Migrate legacy users from the old/global database into this property tenant DB? This is safe to run multiple times.');"
          >
            <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />
            <button type="submit" class="pv-pm-btn pv-pm-btn-subtle pv-pm-btn-full">
              üì¶ Migrate Legacy Users
            </button>
          </form>
        {% endif %}
      </div>

      <div class="pv-pm-users-list">
        <div class="pv-pm-users-header">
          <h3 class="pv-pm-users-title">Property Users</h3>
          <span class="pv-pm-users-count">{{ rows|length if rows else 0 }} users</span>
        </div>

        {% if rows and rows|length %}
          <div class="pv-pm-user-cards">
            {% for u in rows %}
              <div class="pv-pm-user-card{% if not u.is_active %} pv-pm-user-disabled{% endif %}">
                <div class="pv-pm-user-avatar">
                  {{ (u.username or 'U')[0]|upper }}
                </div>
                <div class="pv-pm-user-info">
                  <div class="pv-pm-user-name">{{ u.full_name or u.username }}</div>
                  <div class="pv-pm-user-username">@{{ u.username }}</div>
                </div>
                <div class="pv-pm-user-status">
                  {% if u.is_active %}
                    <span class="pv-pm-status-active">Active</span>
                  {% else %}
                    <span class="pv-pm-status-disabled">Disabled</span>
                  {% endif %}
                </div>
                <div class="pv-pm-user-actions">
                  <a href="{{ url_for('pm.property_user_detail', property_id=prop.id, property_user_uid=(u.uid or '')) }}" class="pv-pm-action-btn" title="Edit user">‚úèÔ∏è</a>
                  <form method="post" action="{{ url_for('pm.property_users_toggle_uid', property_id=prop.id, property_user_uid=(u.uid or '')) }}" class="pv-inline-form">
                    <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />
                    <button type="submit" class="pv-pm-action-btn" title="{% if u.is_active %}Disable{% else %}Enable{% endif %} user">
                      {% if u.is_active %}üö´{% else %}‚úÖ{% endif %}
                    </button>
                  </form>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="pv-pm-users-empty">
            <span class="pv-pm-users-empty-icon">üë•</span>
            <p>No property users yet</p>
            <p class="pv-pm-users-empty-hint">Create a user using the form on the left.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </section>
{% endblock %}
