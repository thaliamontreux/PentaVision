{% extends 'base.html' %}

{% block title %}Storage Modules · PentaVision{% endblock %}

{% block content %}
  <section class="pv-section pv-storage-shell">
    <div class="pv-storage-header">
      <div>
        <h1 style="margin: 0;">Storage Modules</h1>
        <div class="pv-card-subtitle" style="margin-top: 0.35rem;">Manage where your RTSP camera recordings are stored.</div>
      </div>
      <button type="button" class="pv-storage-add" id="pv-storage-add-btn">+ Add Storage Provider</button>
    </div>

    {% include 'admin/_nav.html' %}

    {% if errors %}
      <div class="pv-alert pv-alert-error" role="alert">
        <ul>
          {% for error in errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    <div id="pv-toast" style="position: fixed; right: 18px; bottom: 18px; z-index: 9999; display: none; max-width: min(520px, calc(100vw - 36px)); padding: 0.8rem 0.95rem; border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,0.35);"></div>

    <div class="pv-storage-grid">
      <aside class="pv-storage-left">
        <div class="pv-storage-left-inner">
          <div class="pv-storage-left-controls">
            <input type="text" id="pv-storage-filter" class="pv-storage-filter" placeholder="Filter modules…" autocomplete="off" />
          </div>
          {% if modules %}
            {% for m in modules %}
              <a
                class="pv-storage-provider {% if selected_module and selected_module.id == m.id %}is-selected{% endif %}"
                href="{{ url_for('main.storage_settings', edit_module=m.id) }}"
                data-filter-text="{{ (m.label or m.name or '')|lower }} {{ (m.provider_type or '')|lower }}"
              >
                <div class="pv-storage-provider-icon" aria-hidden="true" data-provider="{{ m.provider_type }}">
                  <span class="pv-storage-provider-icon-text">{{ (m.provider_type or '?')[:2] }}</span>
                </div>
                <div class="pv-storage-provider-meta">
                  <div class="pv-storage-provider-title">{{ m.label or m.name }}</div>
                  <div class="pv-storage-provider-sub">
                    <span class="pv-storage-dot {% if not m.is_enabled %}is-muted{% elif m.status == 'ok' %}is-ok{% else %}is-warn{% endif %}"></span>
                    <span class="pv-storage-pill">{{ m.provider_type }}</span>
                    <span class="pv-storage-pill">P{{ m.priority if m.priority is not none else 100 }}</span>
                    {% if not m.is_enabled %}<span class="pv-storage-pill is-muted">Disabled</span>{% endif %}
                  </div>
                </div>
              </a>
            {% endfor %}
          {% else %}
            <div class="pv-card" style="margin-top: 0.5rem;">
              <div class="pv-card-title" style="margin-bottom: 0.25rem;">No storage modules yet</div>
              <div class="pv-card-subtitle">Click <strong>Add Storage Provider</strong> to create your first module.</div>
            </div>
          {% endif %}
        </div>
      </aside>

      <section class="pv-storage-right">
        <div class="pv-storage-panel">
          <div class="pv-storage-tabs" role="tablist" aria-label="Storage module tabs">
            <button type="button" class="pv-storage-tab is-active" data-tab="overview">Overview</button>
            <button type="button" class="pv-storage-tab" data-tab="configuration">Configuration</button>
            <button type="button" class="pv-storage-tab" data-tab="streams">Streams</button>
            <button type="button" class="pv-storage-tab" data-tab="logs">Logs</button>
            <button type="button" class="pv-storage-tab" data-tab="advanced">Advanced</button>
          </div>

          <div class="pv-storage-tabpanel is-active" data-panel="overview">
            {% if selected_module %}
              <div class="pv-card" style="margin-top: 0.75rem;">
                <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap;">
                  <div>
                    <div class="pv-card-title" style="margin-bottom: 0.15rem;">{{ selected_module.label or selected_module.name }}</div>
                    <div class="pv-card-subtitle">
                      <span class="pv-storage-pill">{{ selected_module.provider_type }}</span>
                      <span class="pv-storage-pill {% if not selected_module.is_enabled %}is-muted{% elif selected_module.status == 'ok' %}is-ok{% else %}is-warn{% endif %}">
                        {% if not selected_module.is_enabled %}Disabled{% elif selected_module.status == 'ok' %}Healthy{% else %}{{ selected_module.status or 'Unknown' }}{% endif %}
                      </span>
                      <span style="opacity: 0.8;">·</span>
                      <span>Name: <code>{{ selected_module.name }}</code></span>
                    </div>
                  </div>
                  <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <form method="post" class="pv-inline-form pv-module-test-form">
                      <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />
                      <input type="hidden" name="action" value="module_test" />
                      <input type="hidden" name="module_id" value="{{ selected_module.id }}" />
                      <button type="submit" class="pv-button-secondary">Test</button>
                    </form>

                    <form method="post" class="pv-inline-form">
                      <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />
                      <input type="hidden" name="action" value="module_toggle" />
                      <input type="hidden" name="module_id" value="{{ selected_module.id }}" />
                      <input type="hidden" name="enable" value="{% if selected_module.is_enabled %}0{% else %}1{% endif %}" />
                      {% if selected_module.is_enabled and selected_metrics and selected_metrics.active_streams|int > 0 %}
                        <label style="display: inline-flex; align-items: center; gap: 0.35rem; font-size: 0.85rem; color: #9ca3af; margin-right: 0.25rem;">
                          <input type="checkbox" name="force_disable" value="1" />
                          <span>Force disable</span>
                        </label>
                      {% endif %}
                      <button type="submit" class="pv-button-secondary">{% if selected_module.is_enabled %}Disable{% else %}Enable{% endif %}</button>
                    </form>

                    <form method="post" class="pv-inline-form" onsubmit="return confirm('Clone this module? The clone will be created disabled.');">
                      <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />
                      <input type="hidden" name="action" value="module_clone" />
                      <input type="hidden" name="module_id" value="{{ selected_module.id }}" />
                      <input type="hidden" name="clone_name" value="{{ selected_module.name }}-copy" />
                      <button type="submit" class="pv-button-secondary">Clone</button>
                    </form>

                    <form method="post" class="pv-inline-form" onsubmit="return confirm('Delete this module? This cannot be undone.');">
                      <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />
                      <input type="hidden" name="action" value="module_delete" />
                      <input type="hidden" name="module_id" value="{{ selected_module.id }}" />
                      <label style="display: inline-flex; align-items: center; gap: 0.35rem; font-size: 0.85rem; color: #9ca3af; margin-right: 0.25rem;">
                        <input type="checkbox" name="force_delete" value="1" />
                        <span>Force delete</span>
                      </label>
                      <button type="submit" class="pv-button-secondary">Delete</button>
                    </form>
                  </div>
                </div>
              </div>

              <div class="pv-storage-overview-grid">
                <div class="pv-storage-metric">
                  <div class="pv-storage-metric-title">Health</div>
                  <div class="pv-storage-metric-value">{% if not selected_module.is_enabled %}Disabled{% elif selected_module.status == 'ok' %}Healthy{% else %}{{ selected_module.status or 'Unknown' }}{% endif %}</div>
                  <div class="pv-storage-metric-sub">{{ selected_module.status_message or 'No recent status.' }}</div>
                </div>
                <div class="pv-storage-metric">
                  <div class="pv-storage-metric-title">Last write</div>
                  <div class="pv-storage-metric-value">{{ selected_metrics.last_write_text if selected_metrics else 'n/a' }}</div>
                  <div class="pv-storage-metric-sub">Provider: <code>{{ selected_module.name }}</code></div>
                </div>
                <div class="pv-storage-metric">
                  <div class="pv-storage-metric-title">Active streams</div>
                  <div class="pv-storage-metric-value">{{ selected_metrics.active_streams if selected_metrics else 0 }}</div>
                  <div class="pv-storage-metric-sub">Based on recent segments.</div>
                </div>
                <div class="pv-storage-metric">
                  <div class="pv-storage-metric-title">Last successful write</div>
                  <div class="pv-storage-metric-value">{{ selected_metrics.last_ok_text if selected_metrics else 'n/a' }}</div>
                  <div class="pv-storage-metric-sub">From write stats.</div>
                </div>
                <div class="pv-storage-metric">
                  <div class="pv-storage-metric-title">Last error</div>
                  <div class="pv-storage-metric-value">{{ selected_metrics.last_error_text if selected_metrics else 'n/a' }}</div>
                  <div class="pv-storage-metric-sub">{{ selected_metrics.last_error_message if selected_metrics and selected_metrics.last_error_message else 'No recent errors.' }}</div>
                </div>
                <div class="pv-storage-metric">
                  <div class="pv-storage-metric-title">Write volume (15m)</div>
                  <div class="pv-storage-metric-value">{{ selected_metrics.writes_15m if selected_metrics else 0 }}</div>
                  <div class="pv-storage-metric-sub">Bytes: {{ selected_metrics.bytes_15m if selected_metrics else 0 }}</div>
                </div>
              </div>

              <div class="pv-card" style="margin-top: 0.75rem;">
                <div class="pv-card-title" style="margin-bottom: 0.25rem;">Recent errors</div>
                <div class="pv-card-subtitle">Most recent error-level events for this module.</div>
                {% if recent_error_rows %}
                  <table class="pv-table" style="margin-top: 0.65rem;">
                    <thead>
                      <tr>
                        <th>Time</th>
                        <th>Type</th>
                        <th>Message</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for e in recent_error_rows %}
                        <tr>
                          <td>{{ e.created_at }}</td>
                          <td><code>{{ e.event_type }}</code></td>
                          <td style="max-width: 560px; overflow: hidden; text-overflow: ellipsis;">{{ e.message }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                {% else %}
                  <div class="pv-card-subtitle" style="margin-top: 0.75rem;">No recent errors.</div>
                {% endif %}
              </div>
            {% else %}
              <div class="pv-storage-empty">
                <div class="pv-card-title" style="margin-bottom: 0.25rem;">Select a storage module</div>
                <div class="pv-card-subtitle">Choose a provider on the left or add a new one.</div>
              </div>
            {% endif %}
          </div>

          <div class="pv-storage-tabpanel" data-panel="configuration">
            {% set edit_module = selected_module %}
            {% set edit_cfg = edit_module_config or {} %}

            {% set cfg_readonly = (selected_module and selected_metrics and selected_metrics.active_streams|int > 0) %}
            {% if cfg_readonly %}
              <div class="pv-alert pv-alert-warn" role="status" style="margin-top: 0.75rem;">
                <p>This module currently has active streams. Configuration is read-only until streams stop.</p>
              </div>
            {% endif %}

            <form method="post" class="pv-storage-form" id="pv-storage-form">
              <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />
              <input type="hidden" name="action" id="pv-storage-action" value="{{ 'module_update' if edit_module else 'module_create' }}" />
              <input type="hidden" name="module_test_fingerprint" id="pv-edit-test-fp" value="" />
              <input type="hidden" name="module_test_ok" id="pv-edit-test-ok" value="" />
              {% if edit_module %}<input type="hidden" name="module_id" value="{{ edit_module.id }}" />{% endif %}

              <div class="pv-storage-config-grid">
                <div class="pv-field-group">
                  <label for="module_name">Name</label>
                  <input id="module_name" name="module_name" type="text" value="{{ edit_module.name if edit_module else '' }}" required {% if cfg_readonly %}disabled{% endif %} />
                </div>
                <div class="pv-field-group">
                  <label for="module_label">Label</label>
                  <input id="module_label" name="module_label" type="text" value="{{ edit_module.label if edit_module and edit_module.label else '' }}" {% if cfg_readonly %}disabled{% endif %} />
                </div>
                <div class="pv-field-group">
                  <label for="module_priority">Priority</label>
                  <input id="module_priority" name="module_priority" type="number" min="0" max="999" step="1" value="{{ edit_module.priority if edit_module and edit_module.priority is not none else 100 }}" {% if cfg_readonly %}disabled{% endif %} />
                  <div style="margin-top: 0.35rem; font-size: 0.8rem; color: #9ca3af;">Lower number = higher priority. Mode B uses this for primary + failover.</div>
                </div>
                <div class="pv-field-group">
                  <label for="module_provider">Provider</label>
                  <select id="module_provider" name="module_provider" required {% if edit_module %}disabled{% endif %}>
                    <option value="">Select provider…</option>
                    <option value="db" {% if edit_module and edit_module.provider_type == 'db' %}selected{% endif %}>Database (RecordDB)</option>
                    <option value="sql_db" {% if edit_module and edit_module.provider_type == 'sql_db' %}selected{% endif %}>SQL Database (External)</option>
                    <option value="local_fs" {% if edit_module and edit_module.provider_type == 'local_fs' %}selected{% endif %}>Local filesystem</option>
                    <option value="local_drive" {% if edit_module and edit_module.provider_type == 'local_drive' %}selected{% endif %}>Local drive path</option>
                    <option value="s3" {% if edit_module and edit_module.provider_type == 's3' %}selected{% endif %}>S3-compatible</option>
                    <option value="gcs" {% if edit_module and edit_module.provider_type == 'gcs' %}selected{% endif %}>Google Cloud Storage</option>
                    <option value="azure_blob" {% if edit_module and edit_module.provider_type == 'azure_blob' %}selected{% endif %}>Azure Blob Storage</option>
                    <option value="dropbox" {% if edit_module and edit_module.provider_type == 'dropbox' %}selected{% endif %}>Dropbox</option>
                    <option value="webdav" {% if edit_module and edit_module.provider_type == 'webdav' %}selected{% endif %}>WebDAV</option>
                    <option value="ftp" {% if edit_module and edit_module.provider_type == 'ftp' %}selected{% endif %}>FTP / FTPS</option>
                    <option value="sftp" {% if edit_module and edit_module.provider_type == 'sftp' %}selected{% endif %}>SFTP</option>
                    <option value="scp" {% if edit_module and edit_module.provider_type == 'scp' %}selected{% endif %}>SCP</option>
                    <option value="onedrive" {% if edit_module and edit_module.provider_type == 'onedrive' %}selected{% endif %}>OneDrive</option>
                    <option value="box" {% if edit_module and edit_module.provider_type == 'box' %}selected{% endif %}>Box</option>
                    <option value="swift" {% if edit_module and edit_module.provider_type == 'swift' %}selected{% endif %}>Swift</option>
                    <option value="pcloud" {% if edit_module and edit_module.provider_type == 'pcloud' %}selected{% endif %}>pCloud</option>
                    <option value="mega" {% if edit_module and edit_module.provider_type == 'mega' %}selected{% endif %}>MEGA</option>
                    {% if module_definitions %}
                      {% for d in module_definitions %}
                        {% if d.provider_type not in ['db','sql_db','local_fs','local_drive','s3','gcs','azure_blob','dropbox','webdav','ftp','sftp','scp','onedrive','box','swift','pcloud','mega'] %}
                          <option value="{{ d.provider_type }}" {% if edit_module and edit_module.provider_type == d.provider_type %}selected{% endif %}>{{ d.display_name }}</option>
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                  </select>
                  <div style="margin-top: 0.4rem; font-size: 0.85rem; color: #9ca3af;">
                    <label style="display: inline-flex; align-items: center; gap: 0.35rem;">
                      <input type="checkbox" name="module_enabled" value="1" {% if not edit_module or edit_module.is_enabled %}checked{% endif %} {% if cfg_readonly %}disabled{% endif %} />
                      <span>Enabled</span>
                    </label>
                  </div>
                </div>
                <div>
                  {% include 'modules/storage/local_fs/template.html' %}
                  {% include 'modules/storage/local_drive/template.html' %}
                  {% include 'modules/storage/sql_db/template.html' %}
                  {% include 'modules/storage/s3/template.html' %}
                  {% include 'modules/storage/gcs/template.html' %}
                  {% include 'modules/storage/azure_blob/template.html' %}
                  {% include 'modules/storage/dropbox/template.html' %}
                  {% include 'modules/storage/webdav/template.html' %}
                  {% include 'modules/storage/ftp/template.html' %}
                  {% include 'modules/storage/sftp/template.html' %}
                  {% include 'modules/storage/scp/template.html' %}
                  {% include 'modules/storage/onedrive/template.html' %}
                  {% include 'modules/storage/box/template.html' %}
                  {% include 'modules/storage/swift/template.html' %}
                  {% include 'modules/storage/pcloud/template.html' %}
                  {% include 'modules/storage/mega/template.html' %}
                  {% include 'modules/storage/db/template.html' %}
                </div>
              </div>

              <div class="pv-storage-actions">
                <button type="button" class="pv-button-secondary" id="pv-edit-test" data-pv-submit-action="{{ 'module_test' if cfg_readonly else 'module_draft_test' }}">Test Connection</button>
                {% if edit_module and edit_module.provider_type in ['s3', 'sql_db', 'azure_blob'] %}
                  <button type="button" class="pv-button-secondary" id="pv-edit-write-test" data-pv-submit-action="{{ 'module_write_test' if cfg_readonly else 'module_draft_write_test' }}">Test Write</button>
                {% endif %}
                <button type="submit" class="pv-storage-save" data-pv-submit-action="{{ 'module_update' if edit_module else 'module_create' }}" {% if not module_test_ready or cfg_readonly %}disabled{% endif %}>Save</button>
              </div>
            </form>
          </div>

          <div class="pv-storage-tabpanel" data-panel="streams">
            {% if not selected_module %}
              <div class="pv-card" style="margin-top: 0.75rem;">
                <div class="pv-card-title" style="margin-bottom: 0.25rem;">Streams</div>
                <div class="pv-card-subtitle">Select a storage module to view streams.</div>
              </div>
            {% else %}
              <div class="pv-card" style="margin-top: 0.75rem;">
                <div class="pv-card-title" style="margin-bottom: 0.25rem;">Recent recording segments</div>
                <div class="pv-card-subtitle">Last 25 segments stored under <code>{{ selected_module.name }}</code>.</div>
                {% if streams_rows %}
                  <table class="pv-table" style="margin-top: 0.65rem;">
                    <thead>
                      <tr>
                        <th>Created</th>
                        <th>Device</th>
                        <th>Key</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for r in streams_rows %}
                        <tr>
                          <td>{{ r.created_at }}</td>
                          <td><code>{{ r.device_id }}</code></td>
                          <td style="max-width: 520px; overflow: hidden; text-overflow: ellipsis;"><code>{{ r.storage_key }}</code></td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                {% else %}
                  <div class="pv-card-subtitle" style="margin-top: 0.75rem;">No segments yet for this module.</div>
                {% endif %}
              </div>

              <div class="pv-card" style="margin-top: 0.75rem;">
                <div class="pv-card-title" style="margin-bottom: 0.25rem;">Upload queue</div>
                <div class="pv-card-subtitle">Pending or failed uploads targeting <code>{{ selected_module.name }}</code>.</div>
                {% if upload_rows %}
                  <table class="pv-table" style="margin-top: 0.65rem;">
                    <thead>
                      <tr>
                        <th>Created</th>
                        <th>Device</th>
                        <th>Status</th>
                        <th>Attempts</th>
                        <th>Last error</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for u in upload_rows %}
                        <tr>
                          <td>{{ u.created_at }}</td>
                          <td><code>{{ u.device_id }}</code></td>
                          <td><code>{{ u.status }}</code></td>
                          <td>{{ u.attempts }}</td>
                          <td style="max-width: 420px; overflow: hidden; text-overflow: ellipsis;">{{ u.last_error }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                {% else %}
                  <div class="pv-card-subtitle" style="margin-top: 0.75rem;">No queued uploads for this module.</div>
                {% endif %}
              </div>
            {% endif %}
          </div>

          <div class="pv-storage-tabpanel" data-panel="logs">
            {% if not selected_module %}
              <div class="pv-card" style="margin-top: 0.75rem;">
                <div class="pv-card-title" style="margin-bottom: 0.25rem;">Logs</div>
                <div class="pv-card-subtitle">Select a storage module to view logs.</div>
              </div>
            {% else %}
              <div class="pv-card" style="margin-top: 0.75rem;">
                <div class="pv-card-title" style="margin-bottom: 0.25rem;">Module events</div>
                <div class="pv-card-subtitle">Last 50 events for <code>{{ selected_module.name }}</code>.</div>
                {% if logs_rows %}
                  <table class="pv-table" style="margin-top: 0.65rem;">
                    <thead>
                      <tr>
                        <th>Time</th>
                        <th>Level</th>
                        <th>Type</th>
                        <th>Message</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for e in logs_rows %}
                        <tr>
                          <td>{{ e.created_at }}</td>
                          <td><code>{{ e.level }}</code></td>
                          <td><code>{{ e.event_type }}</code></td>
                          <td style="max-width: 560px; overflow: hidden; text-overflow: ellipsis;">{{ e.message }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                {% else %}
                  <div class="pv-card-subtitle" style="margin-top: 0.75rem;">No events recorded yet.</div>
                {% endif %}
              </div>
            {% endif %}
          </div>

          <div class="pv-storage-tabpanel" data-panel="advanced">
            <div class="pv-card" style="margin-top: 0.75rem;">
              <div class="pv-card-title" style="margin-bottom: 0.25rem;">Advanced</div>
              <div class="pv-card-subtitle">Advanced settings will live here.</div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <details class="pv-storage-legacy" style="margin-top: 1.25rem;">
      <summary>Legacy global storage settings (fallback)</summary>
      <div class="pv-card" style="margin-top: 0.75rem;">
        <form method="post" class="pv-form">
          <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />
          <div class="pv-field-group">
            <label for="storage_targets">Active targets</label>
            <input id="storage_targets" name="storage_targets" type="text" value="{{ form.storage_targets }}" />
          </div>
          <div class="pv-field-group">
            <label for="local_storage_path">Local filesystem path</label>
            <input id="local_storage_path" name="local_storage_path" type="text" value="{{ form.local_storage_path }}" />
          </div>
          <div class="pv-field-group">
            <button type="submit" class="pv-button-primary">Save legacy settings</button>
          </div>
        </form>
      </div>
    </details>

    <div class="pv-modal" id="pv-storage-wizard" role="dialog" aria-modal="true" aria-labelledby="pv-storage-wizard-title">
      <div class="pv-modal-dialog" style="max-width: 760px; width: 92vw;">
        <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
          <div>
            <div id="pv-storage-wizard-title" class="pv-card-title" style="margin: 0;">Add Storage Provider</div>
            <div class="pv-card-subtitle" style="margin-top: 0.25rem;">Select a provider, enter credentials, test, then save.</div>
          </div>
          <button type="button" class="pv-button pv-button-small" id="pv-storage-wizard-close">Close</button>
        </div>

        <div class="pv-storage-wizard-steps" style="margin-top: 0.75rem;">
          <div class="pv-storage-step is-active" data-step="1">1. Provider</div>
          <div class="pv-storage-step" data-step="2">2. Credentials</div>
          <div class="pv-storage-step" data-step="3">3. Test</div>
          <div class="pv-storage-step" data-step="4">4. Save</div>
        </div>

        <form method="post" id="pv-storage-wizard-form" style="margin-top: 0.9rem;">
          <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />
          <input type="hidden" name="action" id="pv-storage-wizard-action" value="module_create" />
          <input type="hidden" name="module_test_fingerprint" id="pv-wiz-test-fp" value="" />
          <input type="hidden" name="module_test_ok" id="pv-wiz-test-ok" value="" />

          <div class="pv-storage-wizard-panel is-active" data-panel-step="1">
            <div class="pv-field-group">
              <label for="pv-wiz-provider">Provider</label>
              <select id="pv-wiz-provider" name="module_provider" required>
                <option value="">Select provider…</option>
                <option value="db">Database (RecordDB)</option>
                <option value="sql_db">SQL Database (External)</option>
                <option value="local_fs">Local filesystem</option>
                <option value="local_drive">Local drive path</option>
                <option value="s3">S3-compatible</option>
                <option value="gcs">Google Cloud Storage</option>
                <option value="azure_blob">Azure Blob Storage</option>
                <option value="dropbox">Dropbox</option>
                <option value="webdav">WebDAV</option>
                <option value="ftp">FTP / FTPS</option>
                <option value="sftp">SFTP</option>
                <option value="scp">SCP</option>
                <option value="onedrive">OneDrive</option>
                <option value="box">Box</option>
                <option value="swift">Swift</option>
                <option value="pcloud">pCloud</option>
                <option value="mega">MEGA</option>
                {% if module_definitions %}
                  {% for d in module_definitions %}
                    {% if d.provider_type not in ['db','sql_db','local_fs','local_drive','s3','gcs','azure_blob','dropbox','webdav','ftp','sftp','scp','onedrive','box','swift','pcloud','mega'] %}
                      <option value="{{ d.provider_type }}">{{ d.display_name }}</option>
                    {% endif %}
                  {% endfor %}
                {% endif %}
              </select>
            </div>
          </div>

          <div class="pv-storage-wizard-panel" data-panel-step="2">
            <div class="pv-storage-config-grid">
              <div class="pv-field-group">
                <label for="pv-wiz-name">Name</label>
                <input id="pv-wiz-name" name="module_name" type="text" placeholder="e.g. s3:primary" required />
              </div>
              <div class="pv-field-group">
                <label for="pv-wiz-label">Label</label>
                <input id="pv-wiz-label" name="module_label" type="text" placeholder="e.g. Primary archive" />
              </div>
              <div class="pv-field-group">
                <label for="pv-wiz-priority">Priority</label>
                <input id="pv-wiz-priority" name="module_priority" type="number" min="0" max="999" step="1" value="100" />
                <div style="margin-top: 0.35rem; font-size: 0.8rem; color: #9ca3af;">Lower number = higher priority.</div>
              </div>
              <div class="pv-field-group" style="grid-column: 1 / -1;">
                <label style="display: inline-flex; align-items: center; gap: 0.4rem;">
                  <input type="checkbox" name="module_enabled" value="1" checked />
                  <span>Enabled</span>
                </label>
              </div>
              <div style="grid-column: 1 / -1;">
                {% include 'modules/storage/local_fs/wizard.html' %}
                {% include 'modules/storage/local_drive/wizard.html' %}
                {% include 'modules/storage/sql_db/wizard.html' %}
                {% include 'modules/storage/db/wizard.html' %}
                {% include 'modules/storage/s3/wizard.html' %}
                {% include 'modules/storage/gcs/wizard.html' %}
                {% include 'modules/storage/azure_blob/wizard.html' %}
                {% include 'modules/storage/dropbox/wizard.html' %}
                {% include 'modules/storage/webdav/wizard.html' %}
                {% include 'modules/storage/ftp/wizard.html' %}
                {% include 'modules/storage/sftp/wizard.html' %}
                {% include 'modules/storage/scp/wizard.html' %}
                {% include 'modules/storage/onedrive/wizard.html' %}
                {% include 'modules/storage/box/wizard.html' %}
                {% include 'modules/storage/swift/wizard.html' %}
                {% include 'modules/storage/pcloud/wizard.html' %}
                {% include 'modules/storage/mega/wizard.html' %}
              </div>
            </div>
          </div>

          <div class="pv-storage-wizard-panel" data-panel-step="3">
            <div class="pv-card" style="margin-top: 0.25rem;">
              <div class="pv-card-title" style="margin-bottom: 0.25rem;">Test Connection</div>
              <div class="pv-card-subtitle">We will validate credentials and verify the provider is reachable.</div>
            </div>
          </div>

          <div class="pv-storage-wizard-panel" data-panel-step="4">
            <div class="pv-card" style="margin-top: 0.25rem;">
              <div class="pv-card-title" style="margin-bottom: 0.25rem;">Save</div>
              <div class="pv-card-subtitle">Save is only enabled after a successful test.</div>
            </div>
          </div>

          <div class="pv-storage-actions" style="margin-top: 0.9rem; justify-content: space-between;">
            <div style="display: flex; gap: 0.5rem;">
              <button type="button" class="pv-button-secondary" id="pv-wiz-back">Back</button>
              <button type="button" class="pv-button-secondary" id="pv-wiz-next">Next</button>
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button type="button" class="pv-button-secondary" id="pv-wiz-test" data-pv-submit-action="module_draft_test">Test</button>
              <button type="submit" class="pv-storage-save" id="pv-wiz-save" data-pv-submit-action="module_create" {% if not module_test_ready %}disabled{% endif %}>Save</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </section>

  <script>
    (function () {
      var tabs = document.querySelectorAll('.pv-storage-tab');
      var panels = document.querySelectorAll('.pv-storage-tabpanel');
      function setTab(name) {
        tabs.forEach(function (t) {
          t.classList.toggle('is-active', (t.getAttribute('data-tab') || '') === name);
        });
        panels.forEach(function (p) {
          p.classList.toggle('is-active', (p.getAttribute('data-panel') || '') === name);
        });
      }
      tabs.forEach(function (t) {
        t.addEventListener('click', function () {
          setTab(t.getAttribute('data-tab') || 'overview');
        });
      });

      var addBtn = document.getElementById('pv-storage-add-btn');
      if (addBtn) {
        addBtn.addEventListener('click', function () {
          var modal = document.getElementById('pv-storage-wizard');
          if (modal) {
            modal.classList.add('is-visible');
          }
          setTab('overview');
        });
      }

      var wiz = document.getElementById('pv-storage-wizard');
      var wizClose = document.getElementById('pv-storage-wizard-close');
      function closeWizard() {
        if (wiz) wiz.classList.remove('is-visible');
      }
      if (wizClose) wizClose.addEventListener('click', closeWizard);
      if (wiz) {
        wiz.addEventListener('click', function (ev) {
          if (ev.target === wiz) closeWizard();
        });
      }

      var wizForm = document.getElementById('pv-storage-wizard-form');
      var wizAction = document.getElementById('pv-storage-wizard-action');
      var wizProvider = document.getElementById('pv-wiz-provider');
      var wizSteps = document.querySelectorAll('.pv-storage-step');
      var wizPanels = document.querySelectorAll('.pv-storage-wizard-panel');
      var wizBack = document.getElementById('pv-wiz-back');
      var wizNext = document.getElementById('pv-wiz-next');
      var wizTest = document.getElementById('pv-wiz-test');
      var wizSave = document.getElementById('pv-wiz-save');
      var toastEl = document.getElementById('pv-toast');
      var wizTestFp = document.getElementById('pv-wiz-test-fp');
      var wizTestOk = document.getElementById('pv-wiz-test-ok');

      var wizStep = 1;
      function setWizardStep(step) {
        wizStep = step;
        wizSteps.forEach(function (el) {
          el.classList.toggle('is-active', (el.getAttribute('data-step') || '') === String(step));
        });
        wizPanels.forEach(function (el) {
          el.classList.toggle('is-active', (el.getAttribute('data-panel-step') || '') === String(step));
        });
        if (wizBack) wizBack.disabled = step <= 1;
      }

      function updateWizardProviderConfig() {
        if (!wizProvider) return;
        var value = wizProvider.value || '';
        var groups = wizForm.querySelectorAll('.pv-module-config-group');
        groups.forEach(function (el) {
          var target = (el.getAttribute('data-provider') || '').trim();
          el.style.display = target && target === value ? '' : 'none';
        });

        try {
          var wSel = document.getElementById('pv-wiz-sql-db-type');
          var wShow = wSel && String(wSel.value || '').toLowerCase() === 'mssql';
          var wBlocks = wizForm.querySelectorAll('.pv-wiz-sql-db-mssql-only');
          if (wBlocks && wBlocks.length) {
            wBlocks.forEach(function (el) {
              el.style.display = wShow ? '' : 'none';
            });
          }
        } catch (e) {}
      }
      if (wizProvider) {
        wizProvider.addEventListener('change', function () {
          updateWizardProviderConfig();
        });
      }

      try {
        var wizSqlDbType = document.getElementById('pv-wiz-sql-db-type');
        if (wizSqlDbType) {
          wizSqlDbType.addEventListener('change', function () {
            updateWizardProviderConfig();
          });
        }
      } catch (e) {}

      if (wizBack) {
        wizBack.addEventListener('click', function () {
          setWizardStep(Math.max(1, wizStep - 1));
        });
      }
      if (wizNext) {
        wizNext.addEventListener('click', function () {
          if (wizStep === 1 && wizProvider && !wizProvider.value) {
            return;
          }
          updateWizardProviderConfig();
          setWizardStep(Math.min(4, wizStep + 1));
        });
      }

      if (wizForm) {
        wizForm.addEventListener('click', function (ev) {
          var btn = ev.target && ev.target.closest ? ev.target.closest('button') : ev.target;
          if (!btn || !btn.getAttribute) return;
          var action = btn.getAttribute('data-pv-submit-action');
          if (!action) return;
          if (wizAction) wizAction.value = action;
        });

        wizForm.addEventListener('submit', function (ev) {
          var a = wizAction ? String(wizAction.value || '') : '';
          if (a === 'module_draft_test') {
            ev.preventDefault();
            runWizardTestAjax();
          }
        });

        setWizardStep(1);
        updateWizardProviderConfig();
      }

      function showToast(message, ok) {
        if (!toastEl) return;
        toastEl.textContent = String(message || '');
        toastEl.style.display = 'block';
        toastEl.style.background = '#86efac';
        toastEl.style.color = '#111827';
        window.clearTimeout(showToast._t);
        showToast._t = window.setTimeout(function () {
          toastEl.style.display = 'none';
        }, 10000);
      }

      try {
        var qs = new URLSearchParams(window.location.search || '');
        var toastMsg = qs.get('pv_toast') || '';
        if (toastMsg) {
          showToast(toastMsg, true);
        }
      } catch (e) {
      }

      var moduleTestForms = document.querySelectorAll('.pv-module-test-form');
      if (moduleTestForms && moduleTestForms.length) {
        moduleTestForms.forEach(function (f) {
          f.addEventListener('submit', function (ev) {
            ev.preventDefault();
            var btn = f.querySelector('button[type="submit"]');
            if (btn) {
              btn.disabled = true;
              btn.textContent = 'Testing…';
            }

            var fd = new FormData(f);
            fetch(window.location.pathname + window.location.search, {
              method: 'POST',
              body: fd,
              credentials: 'same-origin',
              headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
              }
            })
              .then(function (r) { return r.json(); })
              .then(function (data) {
                var msg = 'Module ' + (data && data.module_name ? data.module_name : '') + ': ' + (data && data.message ? data.message : '');
                showToast(msg, !!(data && data.ok));
              })
              .catch(function (e) {
                showToast('Test failed: ' + e, false);
              })
              .finally(function () {
                if (btn) {
                  btn.disabled = false;
                  btn.textContent = 'Test';
                }
              });
          });
        });
      }

      function runWizardTestAjax() {
        if (!wizForm) return;
        setWizardStep(3);
        if (wizAction) wizAction.value = 'module_draft_test';
        var fd = new FormData(wizForm);

        if (wizTest) {
          wizTest.disabled = true;
          wizTest.textContent = 'Testing…';
        }

        fetch(window.location.pathname, {
          method: 'POST',
          body: fd,
          credentials: 'same-origin',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Accept': 'application/json'
          }
        })
          .then(function (r) {
            return r.json();
          })
          .then(function (data) {
            var ok = !!(data && data.ok);
            var msg = 'Module ' + (data && data.module_name ? data.module_name : '') + ': ' + (data && data.message ? data.message : '');
            showToast(msg, ok);

            if (wizSave) {
              wizSave.disabled = !(data && data.module_test_ready);
            }

            if (wizTestFp) {
              wizTestFp.value = (data && data.fingerprint) ? String(data.fingerprint) : '';
            }
            if (wizTestOk) {
              wizTestOk.value = (data && data.module_test_ready) ? '1' : '';
            }

            if (data && data.module_test_ready) {
              setWizardStep(4);
            } else {
              setWizardStep(3);
            }
          })
          .catch(function (e) {
            showToast('Test failed: ' + e, false);
            setWizardStep(3);
          })
          .finally(function () {
            if (wizTest) {
              wizTest.disabled = false;
              wizTest.textContent = 'Test';
            }
          });
      }

      if (wizTest) {
        wizTest.addEventListener('click', function (ev) {
          ev.preventDefault();
          runWizardTestAjax();
        });
      }

      {% if open_wizard %}
        if (wiz) {
          wiz.classList.add('is-visible');
        }
      {% endif %}

      {% if wizard_draft %}
        try {
          var draft = {{ wizard_draft|tojson }};
          if (draft && wizForm) {
            Object.keys(draft).forEach(function (k) {
              if (!k || k === '_step') return;
              var el = wizForm.querySelector('[name="' + k.replace(/"/g, '\\"') + '"]');
              if (!el) return;
              if (el.type === 'checkbox') {
                var v = String(draft[k] || '');
                el.checked = (v === '1' || v.toLowerCase() === 'true' || v.toLowerCase() === 'on' || v.toLowerCase() === 'yes');
              } else {
                el.value = String(draft[k] || '');
              }
            });
            if (wizProvider) {
              updateWizardProviderConfig();
            }
          }
        } catch (e) {
        }
      {% endif %}

      {% if wizard_step %}
        try {
          var stepVal = parseInt('{{ wizard_step }}', 10);
          if (!isNaN(stepVal) && stepVal >= 1 && stepVal <= 4) {
            setWizardStep(stepVal);
          }
        } catch (e) {
        }
      {% endif %}

      var select = document.getElementById('module_provider');
      function updateSqlDbTypeFields() {
        var sel = document.getElementById('module_cfg_sql_db_type');
        var show = sel && String(sel.value || '').toLowerCase() === 'mssql';
        var blocks = document.querySelectorAll('.pv-sql-db-mssql-only');
        if (blocks && blocks.length) {
          blocks.forEach(function (el) {
            el.style.display = show ? '' : 'none';
          });
        }
      }
      function updateModuleConfig() {
        if (!select) return;
        var value = select.value || '';
        var groups = document.querySelectorAll('.pv-module-config-group');
        groups.forEach(function (el) {
          var target = (el.getAttribute('data-provider') || '').trim();
          el.style.display = target && target === value ? '' : 'none';
        });
        updateSqlDbTypeFields();
      }
      if (select) {
        select.addEventListener('change', updateModuleConfig);
        updateModuleConfig();
      }

      var sqlDbTypeSel = document.getElementById('module_cfg_sql_db_type');
      if (sqlDbTypeSel) {
        sqlDbTypeSel.addEventListener('change', updateSqlDbTypeFields);
      }

      var form = document.getElementById('pv-storage-form');
      if (form) {
        var editActionInput = document.getElementById('pv-storage-action');
        var editSaveBtn = form.querySelector('.pv-storage-save');
        var editTestFp = document.getElementById('pv-edit-test-fp');
        var editTestOk = document.getElementById('pv-edit-test-ok');
        var editTestBtn = document.getElementById('pv-edit-test');

        form.addEventListener('click', function (ev) {
          var btn = ev.target && ev.target.closest ? ev.target.closest('button') : ev.target;
          if (!btn || !btn.getAttribute) return;
          var action = btn.getAttribute('data-pv-submit-action');
          if (!action) return;
          var actionInput = document.getElementById('pv-storage-action');
          if (actionInput) actionInput.value = action;
        });

        function runEditTestAjax(triggerBtn) {
          if (!form) return;
          var btn = triggerBtn || editTestBtn;
          var desiredAction = 'module_draft_test';
          try {
            if (btn && btn.getAttribute) {
              desiredAction = String(btn.getAttribute('data-pv-submit-action') || 'module_draft_test');
            }
          } catch (e) { desiredAction = 'module_draft_test'; }

          try {
            if (editTestOk) editTestOk.value = '';
            if (editTestFp) editTestFp.value = '';
          } catch (e) {}

          if (btn) {
            btn.disabled = true;
            try {
              btn.dataset.pvOrigText = btn.textContent;
            } catch (e) {}
            btn.textContent = 'Testing…';
          }
          if (editActionInput) editActionInput.value = desiredAction;
          var fd = new FormData(form);
          fetch(window.location.pathname + window.location.search, {
            method: 'POST',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'Accept': 'application/json'
            },
            body: fd
          })
            .then(function (r) {
              var ct = '';
              try { ct = String(r.headers.get('content-type') || '').toLowerCase(); } catch (e) { ct = ''; }
              if (ct.indexOf('application/json') >= 0) {
                return r.json().catch(function () {
                  return r.text().then(function (t) {
                    throw new Error('Invalid JSON response (' + (r.status || 0) + '): ' + String(t || '').slice(0, 200));
                  });
                });
              }
              return r.text().then(function (t) {
                var preview = String(t || '').replace(/\s+/g, ' ').slice(0, 200);
                throw new Error('Non-JSON response (' + (r.status || 0) + '): ' + preview);
              });
            })
            .then(function (data) {
              var ok = !!(data && data.ok);
              var msg = 'Module ' + (data && data.module_name ? data.module_name : '') + ': ' + (data && data.message ? data.message : '');
              showToast(msg, ok);

              if (String(desiredAction || '') === 'module_draft_test') {
                if (editSaveBtn) {
                  editSaveBtn.disabled = !(data && data.module_test_ready);
                }
                if (editTestFp) {
                  editTestFp.value = (data && data.fingerprint) ? String(data.fingerprint) : '';
                }
                if (editTestOk) {
                  editTestOk.value = (data && data.module_test_ready) ? '1' : '';
                }
              }
            })
            .catch(function (e) {
              showToast('Test failed: ' + e, false);
            })
            .finally(function () {
              if (btn) {
                btn.disabled = false;
                var orig = '';
                try {
                  orig = btn.dataset.pvOrigText || '';
                } catch (e) {}
                btn.textContent = orig || btn.textContent || 'Test';
              }
            });
        }

        if (editTestBtn) {
          editTestBtn.addEventListener('click', function (ev) {
            ev.preventDefault();
            runEditTestAjax();
          });
        }

        var editWriteTestBtn = document.getElementById('pv-edit-write-test');
        if (editWriteTestBtn) {
          editWriteTestBtn.addEventListener('click', function (ev) {
            ev.preventDefault();
            runEditTestAjax(editWriteTestBtn);
          });
        }

        form.addEventListener('submit', function (ev) {
          if (ev && ev.submitter && ev.submitter.getAttribute) {
            var act = ev.submitter.getAttribute('data-pv-submit-action');
            if (act === 'module_draft_test') {
              ev.preventDefault();
              runEditTestAjax(ev.submitter);
            }
          }
        });
      }

      var filterInput = document.getElementById('pv-storage-filter');
      function applyModuleFilter() {
        if (!filterInput) return;
        var q = (filterInput.value || '').trim().toLowerCase();
        var items = document.querySelectorAll('.pv-storage-provider');
        items.forEach(function (el) {
          var txt = (el.getAttribute('data-filter-text') || '').toLowerCase();
          if (!q) {
            el.style.display = '';
            return;
          }
          el.style.display = txt.indexOf(q) >= 0 ? '' : 'none';
        });
      }
      if (filterInput) {
        filterInput.addEventListener('input', applyModuleFilter);
      }
    })();
  </script>
{% endblock %}
