{% extends 'base.html' %}

{% block title %}Recording settings · PentaVision{% endblock %}

{% block content %}
  <section class="pv-section">
    <h1>Recording settings</h1>
    <div class="pv-admin-topnav">
      {% include 'admin/_nav.html' %}
    </div>

    {% if errors %}
      <div class="pv-alert pv-alert-error" role="alert">
        <ul>
          {% for error in errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    {% if saved %}
      <div class="pv-alert pv-alert-success" role="status">
        <p>Recording settings updated.</p>
      </div>
    {% endif %}

    {% if test_result %}
      <div class="pv-alert {% if test_result.ok %}pv-alert-success{% else %}pv-alert-error{% endif %}" role="status">
        <p>
          Storage module <code>{{ test_result.module_name }}</code>:
          {{ test_result.message }}
        </p>
      </div>
    {% endif %}

    <div class="pv-card" style="margin-bottom: 1.5rem;">
      <h2>Overview</h2>
      <p class="pv-card-subtitle">
        Current time: {{ current_time_local.strftime('%Y-%m-%d %H:%M:%S') }} ({{ current_timezone }})
      </p>
      <p class="pv-card-subtitle">
        Recording windows are evaluated using each camera's recording schedule. When no schedule is configured for a camera, it records 24 hours a day.
      </p>
    </div>

    <div class="pv-card" style="margin-bottom: 1.5rem;">
      <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem; flex-wrap: wrap;">
        <div>
          <h2 style="margin-bottom: 0.15rem;">Storage schedules</h2>
          <p class="pv-card-subtitle" style="margin-top: 0;">
            Programmed schedules control both when cameras record and which storage modules receive segments.
          </p>
        </div>
        <button type="button" class="pv-button-primary" id="pv-add-storage-schedule">+ Add Storage Schedule</button>
      </div>

      {% if storage_schedules %}
        <table class="pv-table" style="margin-top: 0.75rem;">
          <thead>
            <tr>
              <th>Camera</th>
              <th>Storage modules</th>
              <th>Retention (days)</th>
              <th>Mode</th>
              <th>Window</th>
              <th style="width: 1%; white-space: nowrap;">Status</th>
              <th style="width: 1%; white-space: nowrap;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for s in storage_schedules %}
              <tr>
                <td>{{ s.camera_name }}</td>
                <td style="font-size: 0.85rem;"><code>{{ s.storage_targets or 'Global default' }}</code></td>
                <td>{{ s.retention_days if s.retention_days is not none else '\u2013' }}</td>
                <td>{{ s.mode }}</td>
                <td>
                  {% if s.mode == 'always' %}
                    24 hours
                  {% else %}
                    {{ s.start_time or '\u2013' }} to {{ s.end_time or '\u2013' }}
                  {% endif %}
                </td>
                <td>
                  {% if s.is_enabled %}
                    <span style="color: #16a34a;">Enabled</span>
                  {% else %}
                    <span style="color: #6b7280;">Disabled</span>
                  {% endif %}
                </td>
                <td style="white-space: nowrap;">
                  <form method="post" class="pv-inline-form" style="display: inline-flex;">
                    <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />
                    <input type="hidden" name="action" value="toggle_storage_schedule" />
                    <input type="hidden" name="entry_id" value="{{ s.id }}" />
                    <input type="hidden" name="enable" value="{% if s.is_enabled %}0{% else %}1{% endif %}" />
                    <button type="submit" class="pv-button-secondary" style="padding: 0.2rem 0.6rem; font-size: 0.8rem;">
                      {% if s.is_enabled %}Disable{% else %}Enable{% endif %}
                    </button>
                  </form>
                  <form method="post" class="pv-inline-form" style="display: inline-flex;" onsubmit="return confirm('Delete this schedule entry?');">
                    <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />
                    <input type="hidden" name="action" value="delete_storage_schedule" />
                    <input type="hidden" name="entry_id" value="{{ s.id }}" />
                    <button type="submit" class="pv-button-secondary" style="padding: 0.2rem 0.6rem; font-size: 0.8rem;">
                      Delete
                    </button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p class="pv-card-subtitle" style="margin-top: 0.75rem;">
          No storage schedules yet. Click <strong>Add Storage Schedule</strong> to create your first programmed schedule.
        </p>
      {% endif %}
    </div>

    <div class="pv-dashboard-grid" style="grid-template-columns: minmax(0, 1.2fr) minmax(0, 2fr); gap: 1.5rem; align-items: flex-start;">
      <div class="pv-card">
        <h2>Storage modules</h2>
        <p class="pv-card-subtitle">
          These modules define where recordings are stored. Multiple modules can use the same provider type (for example, several Google Cloud Storage buckets or Google Drive folders).
        </p>
        {% if modules %}
          <table class="pv-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Label</th>
                <th>Provider</th>
                <th>Status</th>
                <th style="width: 1%; white-space: nowrap;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for m in modules %}
                <tr>
                  <td><code>{{ m.name }}</code></td>
                  <td>{{ m.label or '\u00a0' }}</td>
                  <td>{{ m.provider_type }}</td>
                  <td>
                    {% if m.is_enabled %}
                      <span style="color: #16a34a;">Enabled</span>
                    {% else %}
                      <span style="color: #6b7280;">Disabled</span>
                    {% endif %}
                  </td>
                  <td>
                    <form method="post" class="pv-inline-form">
                      <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />
                      <input type="hidden" name="action" value="test_module" />
                      <input type="hidden" name="module_id" value="{{ m.id }}" />
                      <button type="submit" class="pv-button-secondary" style="padding: 0.2rem 0.6rem; font-size: 0.8rem;">
                        Test
                      </button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="pv-card-subtitle">
            No storage modules are configured yet. The system will fall back to the legacy global storage settings.
          </p>
        {% endif %}
      </div>

      <div class="pv-card">
        <h2>Legacy per-camera overrides</h2>
        <p class="pv-card-subtitle">
          These settings are used only when no storage schedule entries exist for a camera.
        </p>
        {% if cameras %}
          <table class="pv-table">
            <thead>
              <tr>
                <th>Camera</th>
                <th>Storage modules</th>
                <th>Retention (days)</th>
                <th>Mode</th>
                <th>Window</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for c in cameras %}
                <tr>
                  <td>{{ c.name }}</td>
                  <td style="font-size: 0.85rem;">
                    <form method="post" class="pv-inline-form" style="align-items: flex-start; gap: 0.5rem;">
                      <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />
                      <input type="hidden" name="action" value="update_storage" />
                      <input type="hidden" name="device_id" value="{{ c.id }}" />
                      <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                        {% for m in modules %}
                          {% if m.is_enabled %}
                            <label style="display: inline-flex; align-items: center; gap: 0.2rem; padding: 0.1rem 0.4rem; border-radius: 999px; border: 1px solid #e5e7eb; font-size: 0.75rem; white-space: nowrap;">
                              <input
                                type="checkbox"
                                name="targets"
                                value="{{ m.name }}"
                                {% if m.name in c.selected_targets %}checked{% endif %}
                              />
                              <span>{{ m.label or m.name }}</span>
                            </label>
                          {% endif %}
                        {% endfor %}
                      </div>
                      <button type="submit" class="pv-button-primary" style="padding: 0.15rem 0.75rem; font-size: 0.8rem; white-space: nowrap;">
                        Save modules
                      </button>
                    </form>
                    <p class="pv-card-subtitle" style="font-size: 0.7rem; margin-top: 0.1rem;">
                      Effective targets: {{ c.storage_targets or 'Global default' }}
                    </p>
                  </td>
                  <td>{{ c.retention_days if c.retention_days is not none else '\u2013' }}</td>
                  <td>
                    <form method="post" class="pv-inline-form">
                      <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />
                      <input type="hidden" name="action" value="update_schedule" />
                      <input type="hidden" name="device_id" value="{{ c.id }}" />
                      <select name="mode">
                        <option value="always" {% if c.mode == 'always' %}selected{% endif %}>Always</option>
                        <option value="scheduled" {% if c.mode == 'scheduled' %}selected{% endif %}>Scheduled</option>
                        <option value="motion_only" {% if c.mode == 'motion_only' %}selected{% endif %}>Motion only</option>
                        <option value="scheduled_motion" {% if c.mode == 'scheduled_motion' %}selected{% endif %}>Scheduled + motion</option>
                      </select>
                  </td>
                  <td>
                      <div style="display: flex; gap: 0.25rem; align-items: center;">
                        <input
                          type="time"
                          name="start_time"
                          value="{{ c.start_time }}"
                          style="max-width: 6.5rem;"
                        />
                        <span style="font-size: 0.8rem; color: #9ca3af;">to</span>
                        <input
                          type="time"
                          name="end_time"
                          value="{{ c.end_time }}"
                          style="max-width: 6.5rem;"
                        />
                      </div>
                      <p class="pv-card-subtitle" style="font-size: 0.75rem; margin-top: 0.25rem;">
                        {{ c.schedule_summary }}
                      </p>
                  </td>
                  <td style="white-space: nowrap;">
                      <button type="submit" class="pv-button-secondary" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;">
                        Save schedule
                      </button>
                      <button
                        type="button"
                        class="pv-button-secondary rs-24h-btn"
                        data-device-id="{{ c.id }}"
                        style="padding: 0.25rem 0.6rem; font-size: 0.8rem; margin-left: 0.25rem;"
                      >
                        24h
                      </button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="pv-card-subtitle">No cameras are configured.</p>
        {% endif %}
      </div>
    </div>
  </section>

  <script>
    (function () {
      var addBtn = document.getElementById('pv-add-storage-schedule');
      var modal = document.getElementById('pv-storage-schedule-modal');
      var modalClose = document.getElementById('pv-storage-schedule-close');
      var cameraSel = document.getElementById('pv-ss-camera');
      var previewImg = document.getElementById('pv-ss-preview');
      var modeSel = document.getElementById('pv-ss-mode');
      var timeBlock = document.getElementById('pv-ss-time-block');

      function openModal() {
        if (!modal) return;
        modal.classList.add('is-visible');
        if (cameraSel) {
          updatePreview();
        }
        updateTimeBlock();
      }
      function closeModal() {
        if (!modal) return;
        modal.classList.remove('is-visible');
      }
      function updatePreview() {
        if (!cameraSel || !previewImg) return;
        var id = cameraSel.value;
        if (!id) {
          previewImg.src = '';
          previewImg.style.display = 'none';
          return;
        }
        previewImg.style.display = '';
        previewImg.src = '/cameras/' + encodeURIComponent(id) + '/preview_low.jpg?ts=' + Date.now();
      }
      function updateTimeBlock() {
        if (!modeSel || !timeBlock) return;
        var m = String(modeSel.value || 'always');
        timeBlock.style.display = (m === 'always') ? 'none' : '';
      }

      if (addBtn) addBtn.addEventListener('click', openModal);
      if (modalClose) modalClose.addEventListener('click', closeModal);
      if (modal) {
        modal.addEventListener('click', function (ev) {
          if (ev.target === modal) closeModal();
        });
      }
      if (cameraSel) cameraSel.addEventListener('change', updatePreview);
      if (modeSel) modeSel.addEventListener('change', updateTimeBlock);

      var buttons = document.querySelectorAll('.rs-24h-btn');
      buttons.forEach(function (btn) {
        btn.addEventListener('click', function () {
          var row = btn.closest('tr');
          if (!row) return;
          var form = row.querySelector('form');
          if (!form) return;
          var modeSelect = form.querySelector('select[name="mode"]');
          var startInput = form.querySelector('input[name="start_time"]');
          var endInput = form.querySelector('input[name="end_time"]');
          if (modeSelect) modeSelect.value = 'always';
          if (startInput) startInput.value = '';
          if (endInput) endInput.value = '';
          form.submit();
        });
      });
    })();
  </script>

  <div class="pv-modal" id="pv-storage-schedule-modal" role="dialog" aria-modal="true" aria-labelledby="pv-storage-schedule-title">
    <div class="pv-modal-dialog" style="max-width: 860px; width: 92vw;">
      <div style="display: flex; align-items: flex-start; justify-content: space-between; gap: 1rem;">
        <div>
          <div id="pv-storage-schedule-title" class="pv-card-title" style="margin: 0;">Add Storage Schedule</div>
          <div class="pv-card-subtitle" style="margin-top: 0.2rem;">Create a programmed schedule entry for a camera.</div>
        </div>
        <button type="button" class="pv-button-secondary" id="pv-storage-schedule-close">Close</button>
      </div>

      <form method="post" style="margin-top: 1rem;">
        <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />
        <input type="hidden" name="action" value="create_storage_schedule" />

        <div class="pv-dashboard-grid" style="grid-template-columns: minmax(0, 1fr) minmax(0, 1.2fr); gap: 1rem; align-items: start;">
          <div class="pv-card" style="margin: 0;">
            <h2 style="margin-bottom: 0.5rem;">Camera</h2>
            <label class="pv-card-subtitle" for="pv-ss-camera" style="display: block; margin-bottom: 0.35rem;">Select camera</label>
            <select id="pv-ss-camera" name="device_id" style="width: 100%;">
              <option value="">Select…</option>
              {% for c in cameras %}
                <option value="{{ c.id }}">{{ c.name }}</option>
              {% endfor %}
            </select>
            <div style="margin-top: 0.75rem;">
              <div class="pv-card-subtitle" style="margin-bottom: 0.35rem;">Preview</div>
              <img id="pv-ss-preview" src="" alt="Camera preview" style="width: 100%; border-radius: 0.65rem; border: 1px solid rgba(148, 163, 184, 0.18); display: none;" />
            </div>
          </div>

          <div class="pv-card" style="margin: 0;">
            <h2 style="margin-bottom: 0.5rem;">Schedule</h2>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
              <div>
                <label class="pv-card-subtitle" for="pv-ss-retention" style="display: block; margin-bottom: 0.35rem;">Retention (days)</label>
                <input id="pv-ss-retention" name="retention_days" type="number" min="0" placeholder="e.g. 30" style="width: 100%;" />
              </div>
              <div>
                <label class="pv-card-subtitle" for="pv-ss-mode" style="display: block; margin-bottom: 0.35rem;">Mode</label>
                <select id="pv-ss-mode" name="mode" style="width: 100%;">
                  <option value="always">Always</option>
                  <option value="scheduled">Scheduled</option>
                  <option value="motion_only">Motion only</option>
                  <option value="scheduled_motion">Scheduled + motion</option>
                </select>
              </div>
            </div>

            <div id="pv-ss-time-block" style="margin-top: 0.75rem;">
              <div class="pv-card-subtitle" style="margin-bottom: 0.35rem;">Time window</div>
              <div style="display: flex; gap: 0.35rem; align-items: center; flex-wrap: wrap;">
                <input type="time" name="start_time" style="max-width: 8.5rem;" />
                <span style="font-size: 0.85rem; color: #9ca3af;">to</span>
                <input type="time" name="end_time" style="max-width: 8.5rem;" />
              </div>
            </div>

            <div style="margin-top: 0.9rem;">
              <div class="pv-card-subtitle" style="margin-bottom: 0.35rem;">Storage modules</div>
              <div style="display: flex; flex-wrap: wrap; gap: 0.35rem;">
                {% for m in modules %}
                  {% if m.is_enabled %}
                    <label style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.2rem 0.55rem; border-radius: 999px; border: 1px solid rgba(148, 163, 184, 0.18); font-size: 0.8rem; white-space: nowrap;">
                      <input type="checkbox" name="targets" value="{{ m.name }}" />
                      <span>{{ m.label or m.name }}</span>
                    </label>
                  {% endif %}
                {% endfor %}
              </div>
              <p class="pv-card-subtitle" style="margin-top: 0.5rem;">If no modules are selected, the schedule will be created but will not record until targets are selected.</p>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 0.5rem; margin-top: 1rem;">
              <button type="submit" class="pv-button-primary">Save schedule</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
{% endblock %}
