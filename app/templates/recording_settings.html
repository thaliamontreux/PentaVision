{% extends 'base.html' %}

{% block title %}Recording settings Â· PentaVision{% endblock %}

{% block content %}
  <section class="pv-section">
    <h1>Recording settings</h1>
    <div class="pv-admin-topnav">
      {% include 'admin/_nav.html' %}
    </div>

    {% if errors %}
      <div class="pv-alert pv-alert-error" role="alert">
        <ul>
          {% for error in errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    {% if saved %}
      <div class="pv-alert pv-alert-success" role="status">
        <p>Recording settings updated.</p>
      </div>
    {% endif %}

    {% if test_result %}
      <div class="pv-alert {% if test_result.ok %}pv-alert-success{% else %}pv-alert-error{% endif %}" role="status">
        <p>
          Storage module <code>{{ test_result.module_name }}</code>:
          {{ test_result.message }}
        </p>
      </div>
    {% endif %}

    <div class="pv-card" style="margin-bottom: 1.5rem;">
      <h2>Overview</h2>
      <p class="pv-card-subtitle">
        Current time: {{ current_time_local.strftime('%Y-%m-%d %H:%M:%S') }} ({{ current_timezone }})
      </p>
      <p class="pv-card-subtitle">
        Recording windows are evaluated using each camera's recording schedule. When no schedule is configured for a camera, it records 24 hours a day.
      </p>
    </div>

    <div class="pv-dashboard-grid" style="grid-template-columns: minmax(0, 1.2fr) minmax(0, 2fr); gap: 1.5rem; align-items: flex-start;">
      <div class="pv-card">
        <h2>Storage modules</h2>
        <p class="pv-card-subtitle">
          These modules define where recordings are stored. Multiple modules can use the same provider type (for example, several Google Cloud Storage buckets or Google Drive folders).
        </p>
        {% if modules %}
          <table class="pv-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Label</th>
                <th>Provider</th>
                <th>Status</th>
                <th style="width: 1%; white-space: nowrap;">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for m in modules %}
                <tr>
                  <td><code>{{ m.name }}</code></td>
                  <td>{{ m.label or '\u00a0' }}</td>
                  <td>{{ m.provider_type }}</td>
                  <td>
                    {% if m.is_enabled %}
                      <span style="color: #16a34a;">Enabled</span>
                    {% else %}
                      <span style="color: #6b7280;">Disabled</span>
                    {% endif %}
                  </td>
                  <td>
                    <form method="post" class="pv-inline-form">
                      <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />
                      <input type="hidden" name="action" value="test_module" />
                      <input type="hidden" name="module_id" value="{{ m.id }}" />
                      <button type="submit" class="pv-button-secondary" style="padding: 0.2rem 0.6rem; font-size: 0.8rem;">
                        Test
                      </button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="pv-card-subtitle">
            No storage modules are configured yet. The system will fall back to the legacy global storage settings.
          </p>
        {% endif %}
      </div>

      <div class="pv-card">
        <h2>Per-camera storage & schedules</h2>
        <p class="pv-card-subtitle">
          Choose where each camera records and when it records. Only storage modules defined above can be selected.
        </p>
        {% if cameras %}
          <table class="pv-table">
            <thead>
              <tr>
                <th>Camera</th>
                <th>Storage modules</th>
                <th>Retention (days)</th>
                <th>Mode</th>
                <th>Window</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for c in cameras %}
                <tr>
                  <td>{{ c.name }}</td>
                  <td style="font-size: 0.85rem;">
                    <form method="post" class="pv-inline-form" style="align-items: flex-start; gap: 0.5rem;">
                      <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />
                      <input type="hidden" name="action" value="update_storage" />
                      <input type="hidden" name="device_id" value="{{ c.id }}" />
                      <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                        {% for m in modules %}
                          {% if m.is_enabled %}
                            <label style="display: inline-flex; align-items: center; gap: 0.2rem; padding: 0.1rem 0.4rem; border-radius: 999px; border: 1px solid #e5e7eb; font-size: 0.75rem; white-space: nowrap;">
                              <input
                                type="checkbox"
                                name="targets"
                                value="{{ m.name }}"
                                {% if m.name in c.selected_targets %}checked{% endif %}
                              />
                              <span>{{ m.label or m.name }}</span>
                            </label>
                          {% endif %}
                        {% endfor %}
                      </div>
                      <button type="submit" class="pv-button-secondary" style="padding: 0.15rem 0.6rem; font-size: 0.75rem; white-space: nowrap;">
                        Save
                      </button>
                    </form>
                    <p class="pv-card-subtitle" style="font-size: 0.7rem; margin-top: 0.1rem;">
                      Effective targets: {{ c.storage_targets or 'Global default' }}
                    </p>
                  </td>
                  <td>{{ c.retention_days if c.retention_days is not none else '\u2013' }}</td>
                  <td>
                    <form method="post" class="pv-inline-form">
                      <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />
                      <input type="hidden" name="action" value="update_schedule" />
                      <input type="hidden" name="device_id" value="{{ c.id }}" />
                      <select name="mode">
                        <option value="always" {% if c.mode == 'always' %}selected{% endif %}>Always</option>
                        <option value="scheduled" {% if c.mode == 'scheduled' %}selected{% endif %}>Scheduled</option>
                        <option value="motion_only" {% if c.mode == 'motion_only' %}selected{% endif %}>Motion only</option>
                        <option value="scheduled_motion" {% if c.mode == 'scheduled_motion' %}selected{% endif %}>Scheduled + motion</option>
                      </select>
                  </td>
                  <td>
                      <div style="display: flex; gap: 0.25rem; align-items: center;">
                        <input
                          type="time"
                          name="start_time"
                          value="{{ c.start_time }}"
                          style="max-width: 6.5rem;"
                        />
                        <span style="font-size: 0.8rem; color: #9ca3af;">to</span>
                        <input
                          type="time"
                          name="end_time"
                          value="{{ c.end_time }}"
                          style="max-width: 6.5rem;"
                        />
                      </div>
                      <p class="pv-card-subtitle" style="font-size: 0.75rem; margin-top: 0.25rem;">
                        {{ c.schedule_summary }}
                      </p>
                  </td>
                  <td style="white-space: nowrap;">
                      <button type="submit" class="pv-button-primary" style="padding: 0.25rem 0.75rem; font-size: 0.8rem;">
                        Save
                      </button>
                      <button
                        type="button"
                        class="pv-button-secondary rs-24h-btn"
                        data-device-id="{{ c.id }}"
                        style="padding: 0.25rem 0.6rem; font-size: 0.8rem; margin-left: 0.25rem;"
                      >
                        24h
                      </button>
                    </form>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p class="pv-card-subtitle">No cameras are configured.</p>
        {% endif %}
      </div>
    </div>
  </section>

  <script>
    (function () {
      var buttons = document.querySelectorAll('.rs-24h-btn');
      buttons.forEach(function (btn) {
        btn.addEventListener('click', function () {
          var row = btn.closest('tr');
          if (!row) return;
          var form = row.querySelector('form');
          if (!form) return;
          var modeSelect = form.querySelector('select[name="mode"]');
          var startInput = form.querySelector('input[name="start_time"]');
          var endInput = form.querySelector('input[name="end_time"]');
          if (modeSelect) modeSelect.value = 'always';
          if (startInput) startInput.value = '';
          if (endInput) endInput.value = '';
          form.submit();
        });
      });
    })();
  </script>
{% endblock %}
