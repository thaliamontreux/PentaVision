{% extends "base.html" %}

{% block title %}Configure {{ plugin.name }}{% endblock %}

{% block content %}
<div class="config-container">
    <div class="config-header">
        <a href="{{ url_for('plugins.property_plugins_list', property_id=property_id) }}" class="back-link">
            ← Back to Plugins
        </a>
        <h1>Configure {{ plugin.name }}</h1>
        <p class="config-subtitle">{{ plugin.description }}</p>
    </div>

    <form id="configForm" class="config-form">
        <div class="config-sections">
            {% if config_schema.properties %}
            {% for field_name, field_schema in config_schema.properties.items() %}
            <div class="config-field {% if field_name in config_schema.get('required', []) %}required{% endif %}">
                <label for="field-{{ field_name }}">
                    {{ field_schema.title or field_name }}
                    {% if field_name in config_schema.get('required', []) %}
                    <span class="required-mark">*</span>
                    {% endif %}
                </label>

                {% if field_schema.description %}
                <p class="field-description">{{ field_schema.description }}</p>
                {% endif %}

                {% if field_schema.type == 'boolean' %}
                <label class="toggle-switch">
                    <input type="checkbox"
                           id="field-{{ field_name }}"
                           name="{{ field_name }}"
                           {% if current_config.get(field_name, field_schema.get('default', false)) %}checked{% endif %}>
                    <span class="toggle-slider"></span>
                </label>

                {% elif field_schema.type == 'array' and field_schema.items and field_schema.items.enum %}
                <div class="checkbox-group">
                    {% for option in field_schema.items.enum %}
                    <label class="checkbox-item">
                        <input type="checkbox"
                               name="{{ field_name }}"
                               value="{{ option }}"
                               {% if option in current_config.get(field_name, field_schema.get('default', [])) %}checked{% endif %}>
                        {{ option|replace('_', ' ')|title }}
                    </label>
                    {% endfor %}
                </div>

                {% elif field_schema.type == 'integer' %}
                <input type="number"
                       id="field-{{ field_name }}"
                       name="{{ field_name }}"
                       value="{{ current_config.get(field_name, field_schema.get('default', '')) }}"
                       {% if field_schema.minimum is defined %}min="{{ field_schema.minimum }}"{% endif %}
                       {% if field_schema.maximum is defined %}max="{{ field_schema.maximum }}"{% endif %}
                       class="config-input">

                {% elif field_schema.format == 'password' %}
                <div class="password-field">
                    <input type="password"
                           id="field-{{ field_name }}"
                           name="{{ field_name }}"
                           value="{{ current_config.get(field_name, '') }}"
                           class="config-input"
                           autocomplete="off">
                    <button type="button" class="toggle-password" onclick="togglePassword('field-{{ field_name }}')">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                    </button>
                </div>

                {% else %}
                <input type="text"
                       id="field-{{ field_name }}"
                       name="{{ field_name }}"
                       value="{{ current_config.get(field_name, field_schema.get('default', '')) }}"
                       {% if field_schema.pattern %}pattern="{{ field_schema.pattern }}"{% endif %}
                       class="config-input"
                       {% if field_schema.placeholder %}placeholder="{{ field_schema.placeholder }}"{% endif %}>
                {% endif %}
            </div>
            {% endfor %}
            {% else %}
            <div class="no-config">
                <p>This plugin does not require any configuration.</p>
            </div>
            {% endif %}
        </div>

        <div class="config-actions">
            <button type="button" class="btn btn-secondary" onclick="testConnection()">
                Test Connection
            </button>
            <button type="submit" class="btn btn-primary">
                Save Configuration
            </button>
        </div>
    </form>

    <div class="config-status" id="statusPanel" style="display: none;">
        <div class="status-content">
            <span class="status-icon"></span>
            <span class="status-message"></span>
        </div>
    </div>
</div>

<style>
.config-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.back-link {
    display: inline-block;
    margin-bottom: 16px;
    color: #667eea;
    text-decoration: none;
    font-size: 14px;
}

.back-link:hover {
    text-decoration: underline;
}

.config-header {
    margin-bottom: 32px;
}

.config-header h1 {
    margin: 0 0 8px 0;
    font-size: 28px;
}

.config-subtitle {
    margin: 0;
    color: #666;
    font-size: 16px;
}

.config-form {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 24px;
}

.config-sections {
    display: flex;
    flex-direction: column;
    gap: 24px;
}

.config-field {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.config-field label {
    font-weight: 600;
    font-size: 14px;
    color: #333;
}

.required-mark {
    color: #dc3545;
}

.field-description {
    margin: 0;
    font-size: 13px;
    color: #666;
}

.config-input {
    padding: 10px 14px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.2s, box-shadow 0.2s;
}

.config-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.password-field {
    position: relative;
    display: flex;
}

.password-field .config-input {
    flex: 1;
    padding-right: 44px;
}

.toggle-password {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    color: #888;
    padding: 4px;
}

.toggle-password:hover {
    color: #333;
}

.toggle-switch {
    position: relative;
    display: inline-block;
    width: 52px;
    height: 28px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: 0.3s;
    border-radius: 28px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
}

input:checked + .toggle-slider {
    background-color: #667eea;
}

input:checked + .toggle-slider:before {
    transform: translateX(24px);
}

.checkbox-group {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
}

.checkbox-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: normal;
    cursor: pointer;
}

.checkbox-item input {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.config-actions {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 32px;
    padding-top: 24px;
    border-top: 1px solid #e0e0e0;
}

.btn {
    padding: 10px 20px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
}

.btn-primary {
    background: #667eea;
    color: white;
    border: none;
}

.btn-primary:hover {
    background: #5a6fd6;
}

.btn-secondary {
    background: white;
    color: #333;
    border: 1px solid #ddd;
}

.btn-secondary:hover {
    background: #f5f5f5;
}

.config-status {
    margin-top: 20px;
    padding: 16px;
    border-radius: 6px;
}

.config-status.success {
    background: #e8f5e9;
    border: 1px solid #a5d6a7;
}

.config-status.error {
    background: #ffebee;
    border: 1px solid #ef9a9a;
}

.config-status.info {
    background: #e3f2fd;
    border: 1px solid #90caf9;
}

.status-content {
    display: flex;
    align-items: center;
    gap: 12px;
}

.status-icon {
    font-size: 20px;
}

.no-config {
    text-align: center;
    padding: 40px;
    color: #666;
}
</style>

<script>
const propertyId = {{ property_id }};
const pluginKey = '{{ plugin.plugin_key }}';

document.getElementById('configForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    await saveConfig();
});

async function saveConfig() {
    const formData = new FormData(document.getElementById('configForm'));
    const config = {};

    // Process form data
    for (const [key, value] of formData.entries()) {
        // Handle checkboxes for array fields
        if (config[key] !== undefined) {
            if (!Array.isArray(config[key])) {
                config[key] = [config[key]];
            }
            config[key].push(value);
        } else {
            config[key] = value;
        }
    }

    // Handle boolean checkboxes
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        if (!cb.name.includes('[]') && !formData.getAll(cb.name).length) {
            // Single checkbox that's unchecked
            const isArrayField = document.querySelectorAll(`input[name="${cb.name}"]`).length > 1;
            if (!isArrayField) {
                config[cb.name] = false;
            }
        }
    });

    // Convert checkbox groups to arrays
    document.querySelectorAll('.checkbox-group').forEach(group => {
        const checkboxes = group.querySelectorAll('input[type="checkbox"]');
        if (checkboxes.length > 0) {
            const name = checkboxes[0].name;
            config[name] = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
        }
    });

    // Convert single checkboxes to booleans
    document.querySelectorAll('.toggle-switch input[type="checkbox"]').forEach(cb => {
        config[cb.name] = cb.checked;
    });

    // Convert number fields
    document.querySelectorAll('input[type="number"]').forEach(input => {
        if (config[input.name] !== undefined && config[input.name] !== '') {
            config[input.name] = parseInt(config[input.name], 10);
        }
    });

    showStatus('info', 'Saving configuration...');

    try {
        const response = await fetch(`/properties/${propertyId}/plugins/${pluginKey}/configure`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(config)
        });

        const data = await response.json();

        if (data.success) {
            showStatus('success', '✓ Configuration saved successfully');
        } else {
            showStatus('error', '✗ ' + (data.error || 'Failed to save configuration'));
        }
    } catch (err) {
        showStatus('error', '✗ Error: ' + err.message);
    }
}

async function testConnection() {
    showStatus('info', 'Testing connection...');

    // For now, just save and show success
    // In the future, this would call a test endpoint on the plugin
    await saveConfig();

    setTimeout(() => {
        showStatus('success', '✓ Configuration saved. Plugin will test connection on next health check.');
    }, 500);
}

function showStatus(type, message) {
    const panel = document.getElementById('statusPanel');
    panel.style.display = 'block';
    panel.className = 'config-status ' + type;
    panel.querySelector('.status-message').textContent = message;

    if (type === 'success') {
        setTimeout(() => {
            panel.style.display = 'none';
        }, 5000);
    }
}

function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    field.type = field.type === 'password' ? 'text' : 'password';
}
</script>
{% endblock %}
