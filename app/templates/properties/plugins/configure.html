{% extends 'base.html' %}

{% block title %}Configure {{ plugin.name }} · PentaVision{% endblock %}

{% block content %}
<!-- Splash Screen -->
<div id="splashScreen" class="plugin-splash">
  <div class="splash-content">
    <img src="{{ url_for('plugins.plugin_splash_image', plugin_key=plugin.plugin_key) }}"
         alt="{{ plugin.name }}"
         class="splash-image"
         onerror="skipSplash()">
    <div class="splash-loader">
      <div class="splash-progress"></div>
    </div>
    <p class="splash-text">Loading {{ plugin.name }}...</p>
  </div>
</div>

<!-- Main Configuration Panel -->
<section class="pv-section" id="configPanel" style="display: none;">
  <div class="pv-admin-layout">
    {% include 'admin/_nav.html' %}
    <div class="pv-admin-main">

      <div class="pv-page-header">
        <div>
          <a href="{{ url_for('plugins.property_plugins_list', property_id=property_id) }}" class="pv-back-link">
            ← Back to Plugins
          </a>
          <h1 class="pv-page-title">Configure {{ plugin.name }}</h1>
          <p class="pv-page-subtitle">{{ plugin.description }}</p>
        </div>
      </div>

      <div class="pv-card">
        <form id="configForm">
          <div class="config-sections">
            {% if config_schema.properties %}
            {% for field_name, field_schema in config_schema.properties.items() %}
            <div class="pv-form-group">
              <label class="pv-label" for="field-{{ field_name }}">
                {{ field_schema.title or field_name }}
                {% if field_name in config_schema.get('required', []) %}
                <span class="pv-required">*</span>
                {% endif %}
              </label>

              {% if field_schema.description %}
              <p class="pv-field-hint">{{ field_schema.description }}</p>
              {% endif %}

              {% if field_schema.type == 'boolean' %}
              <label class="pv-toggle">
                <input type="checkbox"
                       id="field-{{ field_name }}"
                       name="{{ field_name }}"
                       {% if current_config.get(field_name, field_schema.get('default', false)) %}checked{% endif %}>
                <span class="pv-toggle-slider"></span>
              </label>

              {% elif field_schema.type == 'array' and field_schema.items and field_schema.items.enum %}
              <div class="pv-checkbox-group">
                {% for option in field_schema.items.enum %}
                <label class="pv-checkbox-item">
                  <input type="checkbox"
                         name="{{ field_name }}"
                         value="{{ option }}"
                         {% if option in current_config.get(field_name, field_schema.get('default', [])) %}checked{% endif %}>
                  <span>{{ option|replace('_', ' ')|title }}</span>
                </label>
                {% endfor %}
              </div>

              {% elif field_schema.type == 'integer' %}
              <input type="number"
                     id="field-{{ field_name }}"
                     name="{{ field_name }}"
                     value="{{ current_config.get(field_name, field_schema.get('default', '')) }}"
                     {% if field_schema.minimum is defined %}min="{{ field_schema.minimum }}"{% endif %}
                     {% if field_schema.maximum is defined %}max="{{ field_schema.maximum }}"{% endif %}
                     class="pv-input">

              {% elif field_schema.format == 'password' %}
              <div class="pv-password-field">
                <input type="password"
                       id="field-{{ field_name }}"
                       name="{{ field_name }}"
                       value="{{ current_config.get(field_name, '') }}"
                       class="pv-input"
                       autocomplete="off">
                <button type="button" class="pv-password-toggle" onclick="togglePassword('field-{{ field_name }}')">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                  </svg>
                </button>
              </div>

              {% else %}
              <input type="text"
                     id="field-{{ field_name }}"
                     name="{{ field_name }}"
                     value="{{ current_config.get(field_name, field_schema.get('default', '')) }}"
                     {% if field_schema.pattern %}pattern="{{ field_schema.pattern }}"{% endif %}
                     class="pv-input"
                     {% if field_schema.placeholder %}placeholder="{{ field_schema.placeholder }}"{% endif %}>
              {% endif %}
            </div>
            {% endfor %}
            {% else %}
            <div class="pv-empty pv-empty-sm">
              <p>This plugin does not require any configuration.</p>
            </div>
            {% endif %}
          </div>

          <div class="pv-form-actions">
            <button type="button" class="pv-btn pv-btn-secondary" onclick="testConnection()">
              Test Connection
            </button>
            <button type="submit" class="pv-btn pv-btn-primary">
              Save Configuration
            </button>
          </div>
        </form>

        <div class="pv-status-panel" id="statusPanel" style="display: none;">
          <span class="pv-status-message"></span>
        </div>
      </div>

    </div>
  </div>
</section>

<style>
.pv-back-link {
  display: inline-block;
  margin-bottom: 8px;
  color: var(--pv-accent, #667eea);
  text-decoration: none;
  font-size: 13px;
}
.pv-back-link:hover {
  text-decoration: underline;
}

.config-sections {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.pv-form-group {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.pv-label {
  font-weight: 600;
  font-size: 14px;
  color: var(--pv-text, #e0e0e0);
}

.pv-required {
  color: #ef5350;
}

.pv-field-hint {
  margin: 0;
  font-size: 12px;
  color: var(--pv-text-muted, #888);
}

.pv-input {
  padding: 10px 14px;
  background: var(--pv-input-bg, #1a1a2e);
  border: 1px solid var(--pv-border, #333);
  border-radius: 6px;
  font-size: 14px;
  color: var(--pv-text, #e0e0e0);
  transition: border-color 0.2s, box-shadow 0.2s;
}
.pv-input:focus {
  outline: none;
  border-color: var(--pv-accent, #667eea);
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
}
.pv-input::placeholder {
  color: var(--pv-text-muted, #666);
}

.pv-password-field {
  position: relative;
  display: flex;
}
.pv-password-field .pv-input {
  flex: 1;
  padding-right: 44px;
}
.pv-password-toggle {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  cursor: pointer;
  color: var(--pv-text-muted, #888);
  padding: 4px;
}
.pv-password-toggle:hover {
  color: var(--pv-text, #e0e0e0);
}

.pv-toggle {
  position: relative;
  display: inline-block;
  width: 48px;
  height: 26px;
}
.pv-toggle input {
  opacity: 0;
  width: 0;
  height: 0;
}
.pv-toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: var(--pv-border, #444);
  transition: 0.3s;
  border-radius: 26px;
}
.pv-toggle-slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 4px;
  bottom: 4px;
  background-color: #fff;
  transition: 0.3s;
  border-radius: 50%;
}
input:checked + .pv-toggle-slider {
  background-color: var(--pv-accent, #667eea);
}
input:checked + .pv-toggle-slider:before {
  transform: translateX(22px);
}

.pv-checkbox-group {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
}
.pv-checkbox-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: normal;
  cursor: pointer;
  color: var(--pv-text, #e0e0e0);
  font-size: 14px;
}
.pv-checkbox-item input {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: var(--pv-accent, #667eea);
}

.pv-form-actions {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  margin-top: 24px;
  padding-top: 20px;
  border-top: 1px solid var(--pv-border, #333);
}

.pv-status-panel {
  margin-top: 16px;
  padding: 12px 16px;
  border-radius: 6px;
  font-size: 14px;
}
.pv-status-panel.success {
  background: rgba(76, 175, 80, 0.15);
  border: 1px solid rgba(76, 175, 80, 0.4);
  color: #81c784;
}
.pv-status-panel.error {
  background: rgba(244, 67, 54, 0.15);
  border: 1px solid rgba(244, 67, 54, 0.4);
  color: #ef5350;
}
.pv-status-panel.info {
  background: rgba(33, 150, 243, 0.15);
  border: 1px solid rgba(33, 150, 243, 0.4);
  color: #64b5f6;
}

.pv-empty-sm {
  padding: 30px;
  text-align: center;
  color: var(--pv-text-muted, #888);
}

/* Splash Screen Styles */
.plugin-splash {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: linear-gradient(135deg, #0d0d1a 0%, #1a1a2e 50%, #16213e 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 1;
  transition: opacity 0.5s ease-out;
}
.plugin-splash.fade-out {
  opacity: 0;
  pointer-events: none;
}
.splash-content {
  text-align: center;
  max-width: 600px;
  padding: 40px;
}
.splash-image {
  max-width: 100%;
  max-height: 300px;
  border-radius: 12px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  margin-bottom: 30px;
}
.splash-loader {
  width: 200px;
  height: 4px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 2px;
  margin: 0 auto 20px;
  overflow: hidden;
}
.splash-progress {
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, #667eea, #764ba2);
  border-radius: 2px;
  animation: splashProgress 5s linear forwards;
}
@keyframes splashProgress {
  0% { width: 0%; }
  100% { width: 100%; }
}
.splash-text {
  color: rgba(255, 255, 255, 0.7);
  font-size: 14px;
  margin: 0;
}
</style>

<script>
const propertyId = {{ property_id }};
const pluginKey = '{{ plugin.plugin_key }}';

// Splash screen handling
let splashTimeout;

function showConfigPanel() {
    const splash = document.getElementById('splashScreen');
    const config = document.getElementById('configPanel');

    splash.classList.add('fade-out');
    config.style.display = 'block';

    setTimeout(() => {
        splash.style.display = 'none';
    }, 500);
}

function skipSplash() {
    clearTimeout(splashTimeout);
    showConfigPanel();
}

// Start splash timer (5 seconds)
splashTimeout = setTimeout(showConfigPanel, 5000);

document.getElementById('configForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    await saveConfig();
});

async function saveConfig() {
    const formData = new FormData(document.getElementById('configForm'));
    const config = {};

    // Process form data
    for (const [key, value] of formData.entries()) {
        // Handle checkboxes for array fields
        if (config[key] !== undefined) {
            if (!Array.isArray(config[key])) {
                config[key] = [config[key]];
            }
            config[key].push(value);
        } else {
            config[key] = value;
        }
    }

    // Handle boolean checkboxes
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        if (!cb.name.includes('[]') && !formData.getAll(cb.name).length) {
            // Single checkbox that's unchecked
            const isArrayField = document.querySelectorAll(`input[name="${cb.name}"]`).length > 1;
            if (!isArrayField) {
                config[cb.name] = false;
            }
        }
    });

    // Convert checkbox groups to arrays
    document.querySelectorAll('.checkbox-group').forEach(group => {
        const checkboxes = group.querySelectorAll('input[type="checkbox"]');
        if (checkboxes.length > 0) {
            const name = checkboxes[0].name;
            config[name] = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
        }
    });

    // Convert single checkboxes to booleans
    document.querySelectorAll('.toggle-switch input[type="checkbox"]').forEach(cb => {
        config[cb.name] = cb.checked;
    });

    // Convert number fields
    document.querySelectorAll('input[type="number"]').forEach(input => {
        if (config[input.name] !== undefined && config[input.name] !== '') {
            config[input.name] = parseInt(config[input.name], 10);
        }
    });

    showStatus('info', 'Saving configuration...');

    try {
        const response = await fetch(`/properties/${propertyId}/plugins/${pluginKey}/configure`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(config)
        });

        const data = await response.json();

        if (data.success) {
            showStatus('success', '✓ Configuration saved successfully');
        } else {
            showStatus('error', '✗ ' + (data.error || 'Failed to save configuration'));
        }
    } catch (err) {
        showStatus('error', '✗ Error: ' + err.message);
    }
}

async function testConnection() {
    showStatus('info', 'Testing connection...');

    // For now, just save and show success
    // In the future, this would call a test endpoint on the plugin
    await saveConfig();

    setTimeout(() => {
        showStatus('success', '✓ Configuration saved. Plugin will test connection on next health check.');
    }, 500);
}

function showStatus(type, message) {
    const panel = document.getElementById('statusPanel');
    panel.style.display = 'block';
    panel.className = 'config-status ' + type;
    panel.querySelector('.status-message').textContent = message;

    if (type === 'success') {
        setTimeout(() => {
            panel.style.display = 'none';
        }, 5000);
    }
}

function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    field.type = field.type === 'password' ? 'text' : 'password';
}
</script>
{% endblock %}
