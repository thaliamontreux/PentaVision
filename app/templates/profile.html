{% extends 'base.html' %}

{% block title %}Profile · PentaVision{% endblock %}

{% block content %}
  <section class="pv-section">
    <h1>Your profile</h1>

    {% if errors %}
      <div class="pv-alert pv-alert-error" role="alert">
        <ul>
          {% for error in errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    {% if saved %}
      <div class="pv-alert pv-alert-success" role="status">
        <p>Profile updated.</p>
      </div>
    {% endif %}

    <form method="post" class="pv-form pv-form-two-column">
      <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />

      <div class="pv-card">
        <h2>Basic information</h2>
        <div class="pv-field-group">
          <label for="full_name">Full name</label>
          <input
            id="full_name"
            name="full_name"
            type="text"
            value="{{ form.full_name }}"
          />
        </div>

        <div class="pv-field-group">
          <label for="preferred_name">Preferred name</label>
          <input
            id="preferred_name"
            name="preferred_name"
            type="text"
            value="{{ form.preferred_name }}"
          />
        </div>

        <div class="pv-field-group">
          <label for="primary_phone">Primary phone</label>
          <input
            id="primary_phone"
            name="primary_phone"
            type="tel"
            value="{{ form.primary_phone }}"
          />
        </div>

        <div class="pv-field-group">
          <label for="timezone">Time zone</label>
          <input
            id="timezone"
            name="timezone"
            type="text"
            placeholder="e.g. America/Chicago"
            value="{{ form.timezone }}"
          />
        </div>

        <div class="pv-field-group">
          <label for="mfa_preference">Preferred sign-in method</label>
          {% set mfa = form.mfa_preference or 'password_totp' %}
          <select id="mfa_preference" name="mfa_preference">
            <option value="password_only" {% if mfa == 'password_only' %}selected{% endif %}>
              Password only
            </option>
            <option value="password_totp" {% if mfa == 'password_totp' %}selected{% endif %}>
              Password + TOTP
            </option>
            <option value="passkey_first" {% if mfa == 'passkey_first' %}selected{% endif %}>
              Passkey first, password fallback
            </option>
          </select>
          <p class="pv-card-subtitle">
            This controls how the system presents sign-in options to you when both
            passwords and passkeys are available.
          </p>
        </div>
      </div>

      <div class="pv-card">
        <h2>Notification settings</h2>
        <p class="pv-card-subtitle">
          Choose which security events should trigger notifications for your
          account.
        </p>

        <div class="pv-field-group">
          <label>
            <input
              type="checkbox"
              name="intrusion_alerts"
              value="1"
              {% if notif.intrusion_alerts %}checked{% endif %}
            />
            Intrusion / alarm events
          </label>
        </div>

        <div class="pv-field-group">
          <label>
            <input
              type="checkbox"
              name="fire_alerts"
              value="1"
              {% if notif.fire_alerts %}checked{% endif %}
            />
            Fire / smoke events
          </label>
        </div>

        <div class="pv-field-group">
          <label>
            <input
              type="checkbox"
              name="system_faults"
              value="1"
              {% if notif.system_faults %}checked{% endif %}
            />
            System faults and health warnings
          </label>
        </div>

        <div class="pv-field-group">
          <label>
            <input
              type="checkbox"
              name="camera_motion_events"
              value="1"
              {% if notif.camera_motion_events %}checked{% endif %}
            />
            Camera motion events
          </label>
        </div>

        <div class="pv-field-group">
          <label>
            <input
              type="checkbox"
              name="door_window_activity"
              value="1"
              {% if notif.door_window_activity %}checked{% endif %}
            />
            Door and window activity
          </label>
        </div>

        <div class="pv-field-group">
          <label>
            <input
              type="checkbox"
              name="environmental_alerts"
              value="1"
              {% if notif.environmental_alerts %}checked{% endif %}
            />
            Environmental alerts (temperature, water, etc.)
          </label>
        </div>

        <div class="pv-field-group">
          <label for="escalation_level">Escalation level</label>
          {% set esc = notif.escalation_level or 'normal' %}
          <select id="escalation_level" name="escalation_level">
            <option value="low" {% if esc == 'low' %}selected{% endif %}>Low</option>
            <option value="normal" {% if esc == 'normal' %}selected{% endif %}>
              Normal
            </option>
            <option value="high" {% if esc == 'high' %}selected{% endif %}>High</option>
            <option value="critical" {% if esc == 'critical' %}selected{% endif %}>
              Critical
            </option>
          </select>
        </div>
      </div>

      <div class="pv-card">
        <h2>Security &amp; multi-factor authentication</h2>
        <p class="pv-card-subtitle">
          Manage additional sign-in protections for your account. Changes here
          work together with your preferred sign-in method above.
        </p>

        <div class="pv-field-group">
          <strong>Current MFA status</strong>
          <p class="pv-card-subtitle" style="margin-top: 0.25rem;">
            TOTP: {{ 'Enabled' if mfa_status.totp_enabled else 'Not enabled' }} ·
            Passkeys: {{ mfa_status.passkey_count or 0 }} registered
          </p>
        </div>

        <input
          type="hidden"
          id="security-email"
          value="{{ current_user.email if current_user else '' }}"
        />

        <div class="pv-field-group">
          <h3 style="margin-bottom: 0.25rem;">TOTP authenticator app</h3>
          <p class="pv-card-subtitle">
            Use an authenticator app (like Google Authenticator, 1Password, or
            Authy) to generate one-time codes.
          </p>

          <label for="security-password">Current password</label>
          <input
            id="security-password"
            type="password"
            autocomplete="current-password"
          />

          <button
            type="button"
            class="pv-button"
            id="totp-setup-btn"
            style="margin-top: 0.5rem;"
          >
            Generate TOTP setup
          </button>

          <div
            id="totp-setup-output"
            class="pv-card-subtitle"
            style="margin-top: 0.5rem; white-space: pre-wrap;"
          ></div>
        </div>

        <div class="pv-field-group" style="margin-top: 1rem;">
          <h3 style="margin-bottom: 0.25rem;">Passkeys (WebAuthn)</h3>
          <p class="pv-card-subtitle">
            Register a passkey tied to this browser or device. When available,
            passkeys can be used to sign in without typing your password.
          </p>

          <label for="pk-nickname">Passkey nickname (optional)</label>
          <input id="pk-nickname" type="text" />

          <button
            type="button"
            class="pv-button"
            id="pk-register-btn"
            style="margin-top: 0.5rem;"
          >
            Register passkey for this device
          </button>

          <div
            id="pk-output"
            class="pv-card-subtitle"
            style="margin-top: 0.5rem; white-space: pre-wrap;"
          ></div>
        </div>
      </div>

      <div class="pv-field-group" style="grid-column: 1 / -1; margin-top: 1rem;">
        <button type="submit" class="pv-button-primary">Save changes</button>
      </div>
    </form>
  </section>
  <script>
    (function () {
      function setOutput(el, value) {
        if (!el) return;
        if (typeof value === 'string') {
          el.textContent = value;
          return;
        }
        try {
          el.textContent = JSON.stringify(value, null, 2);
        } catch (e) {
          el.textContent = String(value);
        }
      }

      function apiPostJson(url, body) {
        return fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'same-origin',
          body: JSON.stringify(body || {})
        }).then(function (resp) {
          return resp.json().catch(function () {
            return { error: 'invalid JSON response', status: resp.status };
          });
        });
      }

      var emailInput = document.getElementById('security-email');
      var email = emailInput ? String(emailInput.value || '').trim() : '';

      var totpBtn = document.getElementById('totp-setup-btn');
      if (totpBtn) {
        totpBtn.addEventListener('click', function () {
          var pwInput = document.getElementById('security-password');
          var out = document.getElementById('totp-setup-output');
          var password = pwInput ? pwInput.value : '';
          if (!email) {
            setOutput(out, 'No email is associated with this session.');
            return;
          }
          if (!password) {
            setOutput(out, 'Enter your current password to generate TOTP setup.');
            return;
          }
          setOutput(out, 'Requesting TOTP setup…');
          apiPostJson('{{ url_for("auth.totp_setup") }}', {
            email: email,
            password: password
          }).then(function (data) {
            if (data.error) {
              setOutput(out, 'Error: ' + data.error);
              return;
            }
            var lines = [];
            if (data.secret) {
              lines.push('Secret: ' + data.secret);
            }
            if (data.otpauth_url) {
              lines.push('Add to your authenticator app using this URI:');
              lines.push(data.otpauth_url);
            }
            setOutput(out, lines.join('\n'));
          }).catch(function (err) {
            setOutput(out, String(err));
          });
        });
      }

      function bufferFromBase64Url(b64url) {
        var s = String(b64url || '');
        s = s.replace(/-/g, '+').replace(/_/g, '/');
        var pad = s.length % 4;
        if (pad) {
          s += '='.repeat(4 - pad);
        }
        var binary = atob(s);
        var bytes = new Uint8Array(binary.length);
        for (var i = 0; i < bytes.length; i++) {
          bytes[i] = binary.charCodeAt(i);
        }
        return bytes.buffer;
      }

      function base64UrlFromBuffer(buf) {
        var bytes = new Uint8Array(buf || []);
        var binary = '';
        for (var i = 0; i < bytes.length; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
      }

      function decodePublicKeyOptions(opts) {
        if (!opts || !opts.publicKey) return opts;
        var pk = opts.publicKey;
        if (pk.challenge) {
          pk.challenge = bufferFromBase64Url(pk.challenge);
        }
        if (pk.user && pk.user.id) {
          pk.user.id = bufferFromBase64Url(pk.user.id);
        }
        if (Array.isArray(pk.excludeCredentials)) {
          pk.excludeCredentials = pk.excludeCredentials.map(function (cred) {
            if (cred && cred.id) {
              cred.id = bufferFromBase64Url(cred.id);
            }
            return cred;
          });
        }
        return opts;
      }

      var pkBtn = document.getElementById('pk-register-btn');
      if (pkBtn) {
        pkBtn.addEventListener('click', function () {
          var out = document.getElementById('pk-output');
          if (!window.PublicKeyCredential) {
            setOutput(out, 'Passkeys are not supported in this browser.');
            return;
          }
          if (!email) {
            setOutput(out, 'No email is associated with this session.');
            return;
          }
          var pwInput = document.getElementById('security-password');
          var password = pwInput ? pwInput.value : '';
          if (!password) {
            setOutput(out, 'Enter your current password before registering a passkey.');
            return;
          }
          var nicknameInput = document.getElementById('pk-nickname');
          var nickname = nicknameInput ? nicknameInput.value.trim() : '';
          setOutput(out, 'Starting passkey registration…');
          apiPostJson('{{ url_for("auth.passkey_register_begin") }}', {
            email: email,
            password: password,
            nickname: nickname
          }).then(function (options) {
            if (options.error) {
              setOutput(out, 'Error: ' + options.error);
              return;
            }
            decodePublicKeyOptions(options);
            return navigator.credentials.create(options).then(function (cred) {
              var att = {
                id: cred.id,
                rawId: base64UrlFromBuffer(cred.rawId),
                type: cred.type,
                response: {
                  clientDataJSON: base64UrlFromBuffer(cred.response.clientDataJSON),
                  attestationObject: base64UrlFromBuffer(cred.response.attestationObject)
                }
              };
              return apiPostJson('{{ url_for("auth.passkey_register_complete") }}', att);
            });
          }).then(function (data) {
            if (!data) return;
            if (data.error) {
              setOutput(out, 'Error: ' + data.error);
            } else {
              setOutput(out, data);
            }
          }).catch(function (err) {
            setOutput(out, String(err));
          });
        });
      }
    })();
  </script>
{% endblock %}
