{% extends 'base.html' %}

{% block title %}Profile ¬∑ PentaVision{% endblock %}

{% block content %}
  <section class="pv-section">
    <h1>Your profile</h1>

    {% if errors %}
      <div class="pv-alert pv-alert-error" role="alert">
        <ul>
          {% for error in errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    {% if saved %}
      <div class="pv-alert pv-alert-success" role="status">
        <p>Profile updated.</p>
      </div>
    {% endif %}

    <form method="post" class="pv-form pv-form-two-column">
      <input type="hidden" name="csrf_token" value="{{ global_csrf_token }}" />

      <div class="pv-card">
        <h2>Basic information</h2>
        <div class="pv-field-group">
          <label for="full_name">Full name</label>
          <input
            id="full_name"
            name="full_name"
            type="text"
            value="{{ form.full_name }}"
          />
        </div>

        <div class="pv-field-group">
          <label for="preferred_name">Preferred name</label>
          <input
            id="preferred_name"
            name="preferred_name"
            type="text"
            value="{{ form.preferred_name }}"
          />
        </div>

        <div class="pv-field-group">
          <label for="pronouns">Pronouns</label>
          <select id="pronouns" name="pronouns">
            <option value="" {% if not form.pronouns %}selected{% endif %}>Prefer not to say</option>
            <option value="she/her" {% if form.pronouns == 'she/her' %}selected{% endif %}>She / her</option>
            <option value="he/him" {% if form.pronouns == 'he/him' %}selected{% endif %}>He / him</option>
            <option value="they/them" {% if form.pronouns == 'they/them' %}selected{% endif %}>They / them</option>
            <option value="custom" {% if form.pronouns not in ['', 'she/her', 'he/him', 'they/them'] %}selected{% endif %}>Custom‚Ä¶</option>
          </select>
          <input
            id="pronouns_custom"
            name="pronouns_custom"
            type="text"
            placeholder="Enter your pronouns"
            value="{% if form.pronouns not in ['', 'she/her', 'he/him', 'they/them'] %}{{ form.pronouns }}{% endif %}"
            style="margin-top: 0.5rem; display: {% if form.pronouns not in ['', 'she/her', 'he/him', 'they/them'] %}block{% else %}none{% endif %};"
          />
        </div>

        <div class="pv-field-group">
          <label for="primary_phone_national">Primary phone</label>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <select id="primary_phone_country" name="primary_phone_country" style="max-width: 7rem;">
              <option value="">Code</option>
              <option value="1">+1 (US/Canada)</option>
              <option value="44">+44 (UK)</option>
              <option value="61">+61 (Australia)</option>
              <option value="64">+64 (New Zealand)</option>
              <option value="33">+33 (France)</option>
              <option value="49">+49 (Germany)</option>
              <option value="81">+81 (Japan)</option>
              <option value="91">+91 (India)</option>
              <option value="34">+34 (Spain)</option>
              <option value="39">+39 (Italy)</option>
              <option value="46">+46 (Sweden)</option>
              <option value="47">+47 (Norway)</option>
              <option value="48">+48 (Poland)</option>
              <option value="55">+55 (Brazil)</option>
              <option value="52">+52 (Mexico)</option>
            </select>
            <input
              id="primary_phone_national"
              name="primary_phone_national"
              type="tel"
              placeholder="Local number"
            />
          </div>
          <input
            id="primary_phone"
            name="primary_phone"
            type="hidden"
            value="{{ form.primary_phone }}"
          />
          <p class="pv-card-subtitle">
            Your phone will be stored in an international format (e.g. +1‚Ä¶)
            so alerts can reach you reliably.
          </p>
        </div>

        <div class="pv-field-group">
          <label for="timezone">Time zone</label>
          <select id="timezone" name="timezone">
            <option value="">Select time zone‚Ä¶</option>
          </select>
          <input
            id="timezone_fallback"
            name="timezone_fallback"
            type="text"
            placeholder="e.g. America/Chicago"
            value="{{ form.timezone }}"
            style="margin-top: 0.5rem; display: none;"
          />
          <p class="pv-card-subtitle">
            Choose your IANA time zone (like America/Chicago). If the list
            doesnt work in your browser, you can type it manually.
          </p>
        </div>

        <div class="pv-field-group">
          <label for="mfa_preference">Preferred sign-in method</label>
          {% set mfa = form.mfa_preference or 'password_totp' %}
          <select id="mfa_preference" name="mfa_preference">
            <option value="password_only" {% if mfa == 'password_only' %}selected{% endif %}>
              Password only
            </option>
            <option value="password_totp" {% if mfa == 'password_totp' %}selected{% endif %}>
              Password + TOTP
            </option>
            <option value="passkey_first" {% if mfa == 'passkey_first' %}selected{% endif %}>
              Passkey first, password fallback
            </option>
          </select>
          <p class="pv-card-subtitle">
            This controls how the system presents sign-in options to you when both
            passwords and passkeys are available.
          </p>
        </div>
      </div>

      <div class="pv-card">
        <h2>Notification settings</h2>
        <p class="pv-card-subtitle">
          Choose which security events should trigger notifications for your
          account.
        </p>

        <div class="pv-field-group">
          <label>
            <input
              type="checkbox"
              name="intrusion_alerts"
              value="1"
              {% if notif.intrusion_alerts %}checked{% endif %}
            />
            Intrusion / alarm events
          </label>
        </div>

        <div class="pv-field-group">
          <label>
            <input
              type="checkbox"
              name="fire_alerts"
              value="1"
              {% if notif.fire_alerts %}checked{% endif %}
            />
            Fire / smoke events
          </label>
        </div>

        <div class="pv-field-group">
          <label>
            <input
              type="checkbox"
              name="system_faults"
              value="1"
              {% if notif.system_faults %}checked{% endif %}
            />
            System faults and health warnings
          </label>
        </div>

        <div class="pv-field-group">
          <label>
            <input
              type="checkbox"
              name="camera_motion_events"
              value="1"
              {% if notif.camera_motion_events %}checked{% endif %}
            />
            Camera motion events
          </label>
        </div>

        <div class="pv-field-group">
          <label>
            <input
              type="checkbox"
              name="door_window_activity"
              value="1"
              {% if notif.door_window_activity %}checked{% endif %}
            />
            Door and window activity
          </label>
        </div>

        <div class="pv-field-group">
          <label>
            <input
              type="checkbox"
              name="environmental_alerts"
              value="1"
              {% if notif.environmental_alerts %}checked{% endif %}
            />
            Environmental alerts (temperature, water, etc.)
          </label>
        </div>

        <div class="pv-field-group">
          <label for="escalation_level">Escalation level</label>
          {% set esc = notif.escalation_level or 'normal' %}
          <select id="escalation_level" name="escalation_level">
            <option value="low" {% if esc == 'low' %}selected{% endif %}>Low</option>
            <option value="normal" {% if esc == 'normal' %}selected{% endif %}>
              Normal
            </option>
            <option value="high" {% if esc == 'high' %}selected{% endif %}>High</option>
            <option value="critical" {% if esc == 'critical' %}selected{% endif %}>
              Critical
            </option>
          </select>
        </div>
      </div>

      <div class="pv-card">
        <h2>Security &amp; multi-factor authentication</h2>
        <p class="pv-card-subtitle">
          Manage additional sign-in protections for your account. Changes here
          work together with your preferred sign-in method above.
        </p>

        <div class="pv-field-group">
          <strong>Current MFA status</strong>
          <p class="pv-card-subtitle" style="margin-top: 0.25rem;">
            TOTP: {{ 'Enabled' if mfa_status.totp_enabled else 'Not enabled' }} ¬∑
            Passkeys: {{ mfa_status.passkey_count or 0 }} registered
          </p>
        </div>

        <input
          type="hidden"
          id="security-email"
          value="{{ current_user.email if current_user else '' }}"
        />

        <div class="pv-field-group">
          <h3 style="margin-bottom: 0.25rem;">TOTP authenticator app</h3>
          <p class="pv-card-subtitle">
            Use an authenticator app (like Google Authenticator, 1Password, or
            Authy) to generate one-time codes.
          </p>

          <label for="security-password">Current password</label>
          <input
            id="security-password"
            type="password"
            autocomplete="current-password"
          />

          <button
            type="button"
            class="pv-button"
            id="totp-setup-btn"
            style="margin-top: 0.5rem;"
          >
            Generate TOTP setup
          </button>

          <div
            id="totp-setup-output"
            class="pv-card-subtitle"
            style="margin-top: 0.5rem; white-space: pre-wrap;"
          ></div>
        </div>

        <div class="pv-modal" id="totp-setup-modal">
          <div class="pv-modal-dialog">
            <h2 style="margin-top: 0; margin-bottom: 0.5rem;">Set up TOTP</h2>
            <div
              id="totp-setup-error"
              class="pv-card-subtitle"
              style="color: #fca5a5; min-height: 1.2rem;"
            ></div>
            <div
              style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 0.25rem;"
            >
              <div style="flex: 0 0 auto;">
                <img
                  id="totp-qr-image"
                  alt="TOTP QR code"
                  style="width: 180px; height: 180px; border-radius: 0.5rem; background: #020617;"
                />
              </div>
              <div style="flex: 1 1 0; min-width: 0;">
                <div class="pv-field-group">
                  <label for="totp-secret-input">Secret key</label>
                  <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <input
                      id="totp-secret-input"
                      type="password"
                      readonly
                      style="flex: 1;"
                    />
                    <button
                      type="button"
                      id="totp-secret-toggle"
                      class="pv-button pv-button-small"
                      aria-pressed="false"
                      aria-label="Show secret key"
                    >
                      üëÅ
                    </button>
                  </div>
                </div>
                <div class="pv-field-group">
                  <label for="totp-confirm-code">Authentication code</label>
                  <input
                    id="totp-confirm-code"
                    type="text"
                    inputmode="numeric"
                    autocomplete="one-time-code"
                  />
                </div>
              </div>
            </div>
            <div
              style="margin-top: 0.75rem; display: flex; justify-content: flex-end; gap: 0.5rem;"
            >
              <button type="button" class="pv-button" id="totp-setup-close">
                Close
              </button>
              <button
                type="button"
                class="pv-button-primary"
                id="totp-setup-confirm"
              >
                Confirm
              </button>
            </div>
          </div>
        </div>

        <div class="pv-field-group" style="margin-top: 1rem;">
          <h3 style="margin-bottom: 0.25rem;">Passkeys (WebAuthn)</h3>
          <p class="pv-card-subtitle">
            Register a passkey tied to this browser or device. When available,
            passkeys can be used to sign in without typing your password.
          </p>

          <label for="pk-nickname">Passkey nickname (optional)</label>
          <input id="pk-nickname" type="text" />

          <button
            type="button"
            class="pv-button"
            id="pk-register-btn"
            style="margin-top: 0.5rem;"
          >
            Register passkey for this device
          </button>

          <div
            id="pk-output"
            class="pv-card-subtitle"
            style="margin-top: 0.5rem; white-space: pre-wrap;"
          ></div>
        </div>
      </div>

      <div class="pv-field-group" style="grid-column: 1 / -1; margin-top: 1rem;">
        <button type="submit" class="pv-button-primary">Save changes</button>
      </div>
    </form>
  </section>
  <script>
    (function () {
      // --- Pronouns: toggle custom field and sync value ---
      var pronounsSelect = document.getElementById('pronouns');
      var pronounsCustom = document.getElementById('pronouns_custom');
      if (pronounsSelect && pronounsCustom) {
        pronounsSelect.addEventListener('change', function () {
          var v = pronounsSelect.value || '';
          if (v === 'custom') {
            pronounsCustom.style.display = 'block';
            pronounsCustom.focus();
          } else {
            pronounsCustom.style.display = 'none';
            pronounsCustom.value = '';
          }
        });
        // On submit, if custom is selected, copy custom text into pronouns value.
        var form = pronounsSelect.form;
        if (form) {
          form.addEventListener('submit', function () {
            if (pronounsSelect.value === 'custom' && pronounsCustom.value.trim()) {
              pronounsSelect.value = pronounsCustom.value.trim();
            }
          });
        }
      }

      // --- Phone: split/join country code + national number ---
      var hiddenPhone = document.getElementById('primary_phone');
      var phoneCountry = document.getElementById('primary_phone_country');
      var phoneNational = document.getElementById('primary_phone_national');
      if (hiddenPhone && phoneCountry && phoneNational) {
        var stored = String(hiddenPhone.value || '');
        if (stored.startsWith('+')) {
          stored = stored.slice(1);
        }
        // Rough parse: take leading digits as country code up to 3 digits.
        var cc = '';
        var rest = stored;
        var i;
        for (i = 1; i <= 3 && i <= stored.length; i++) {
          var prefix = stored.slice(0, i);
          if (/^\d+$/.test(prefix)) {
            cc = prefix;
            rest = stored.slice(i);
          }
        }
        if (cc) {
          phoneCountry.value = cc;
          phoneNational.value = rest;
        } else {
          phoneNational.value = stored;
        }

        var syncPhone = function () {
          var c = (phoneCountry.value || '').replace(/\D/g, '');
          var n = (phoneNational.value || '').replace(/[^0-9x+]/gi, '');
          if (c && n) {
            hiddenPhone.value = '+' + c + n;
          } else {
            hiddenPhone.value = n || '';
          }
        };
        phoneCountry.addEventListener('change', syncPhone);
        phoneNational.addEventListener('input', syncPhone);
      }

      // --- Time zone: populate select with browser-known zones, fallback to textbox ---
      var tzSelect = document.getElementById('timezone');
      var tzFallback = document.getElementById('timezone_fallback');
      if (tzSelect && tzFallback) {
        var initialTz = tzFallback.value || '';
        var zones = [];
        if (typeof Intl !== 'undefined' && Intl.supportedValuesOf) {
          try {
            zones = Intl.supportedValuesOf('timeZone');
          } catch (e) {
            zones = [];
          }
        }
        if (zones && zones.length) {
          zones.forEach(function (z) {
            var opt = document.createElement('option');
            opt.value = z;
            opt.textContent = z;
            if (initialTz && initialTz === z) {
              opt.selected = true;
            }
            tzSelect.appendChild(opt);
          });
          if (!initialTz && Intl.DateTimeFormat) {
            try {
              var guess = Intl.DateTimeFormat().resolvedOptions().timeZone;
              if (guess) {
                tzSelect.value = guess;
              }
            } catch (e) {}
          }
          tzFallback.style.display = 'none';
        } else {
          // Fallback: hide select and rely on manual textbox.
          tzSelect.style.display = 'none';
          tzFallback.style.display = 'block';
        }

        var form2 = tzSelect.form || tzFallback.form;
        if (form2) {
          form2.addEventListener('submit', function () {
            if (tzSelect.style.display !== 'none' && tzSelect.value) {
              tzFallback.value = tzSelect.value;
            }
          });
        }
      }

      function setOutput(el, value) {
        if (!el) return;
        if (typeof value === 'string') {
          el.textContent = value;
          return;
        }
        try {
          el.textContent = JSON.stringify(value, null, 2);
        } catch (e) {
          el.textContent = String(value);
        }
      }

      function apiPostJson(url, body) {
        return fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'same-origin',
          body: JSON.stringify(body || {})
        }).then(function (resp) {
          return resp.json().catch(function () {
            return { error: 'invalid JSON response', status: resp.status };
          });
        });
      }

      var emailInput = document.getElementById('security-email');
      var email = emailInput ? String(emailInput.value || '').trim() : '';

      var lastTotpPassword = '';
      var totpModal = document.getElementById('totp-setup-modal');
      var totpQrImage = document.getElementById('totp-qr-image');
      var totpSecretInput = document.getElementById('totp-secret-input');
      var totpCodeInput = document.getElementById('totp-confirm-code');
      var totpErrorEl = document.getElementById('totp-setup-error');
      var totpCloseBtn = document.getElementById('totp-setup-close');
      var totpConfirmBtn = document.getElementById('totp-setup-confirm');
      var totpSecretToggle = document.getElementById('totp-secret-toggle');

      var totpBtn = document.getElementById('totp-setup-btn');
      if (totpBtn) {
        totpBtn.addEventListener('click', function () {
          var pwInput = document.getElementById('security-password');
          var out = document.getElementById('totp-setup-output');
          var password = pwInput ? pwInput.value : '';
          if (!email) {
            setOutput(out, 'No email is associated with this session.');
            return;
          }
          if (!password) {
            setOutput(out, 'Enter your current password to generate TOTP setup.');
            return;
          }
          lastTotpPassword = password;
          setOutput(out, 'Requesting TOTP setup‚Ä¶');
          apiPostJson('{{ url_for("auth.totp_setup") }}', {
            email: email,
            password: password
          }).then(function (data) {
            if (data.error) {
              setOutput(out, 'Error: ' + data.error);
              return;
            }
            if (totpModal && totpSecretInput && totpQrImage && totpCodeInput) {
              if (totpErrorEl) {
                totpErrorEl.textContent = '';
              }
              totpSecretInput.value = data.secret || '';
              totpSecretInput.type = 'password';
              if (totpSecretToggle) {
                totpSecretToggle.setAttribute('aria-pressed', 'false');
              }
              totpCodeInput.value = '';
              if (data.otpauth_url) {
                var encoded = encodeURIComponent(data.otpauth_url);
                totpQrImage.src =
                  'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' +
                  encoded;
              } else {
                totpQrImage.removeAttribute('src');
              }
              totpModal.classList.add('is-visible');
            } else {
              var lines = [];
              if (data.secret) {
                lines.push('Secret: ' + data.secret);
              }
              if (data.otpauth_url) {
                lines.push('Add to your authenticator app using this URI:');
                lines.push(data.otpauth_url);
              }
              setOutput(out, lines.join('\n'));
            }
          }).catch(function (err) {
            setOutput(out, String(err));
          });
        });
      }

      if (totpSecretToggle && totpSecretInput) {
        totpSecretToggle.addEventListener('click', function () {
          if (totpSecretInput.type === 'password') {
            totpSecretInput.type = 'text';
            totpSecretToggle.setAttribute('aria-pressed', 'true');
          } else {
            totpSecretInput.type = 'password';
            totpSecretToggle.setAttribute('aria-pressed', 'false');
          }
        });
      }

      if (totpCloseBtn && totpModal) {
        totpCloseBtn.addEventListener('click', function () {
          totpModal.classList.remove('is-visible');
        });
      }

      if (totpConfirmBtn) {
        totpConfirmBtn.addEventListener('click', function () {
          var out = document.getElementById('totp-setup-output');
          var code = totpCodeInput ? String(totpCodeInput.value || '').trim() : '';
          if (!email) {
            if (totpErrorEl) {
              totpErrorEl.textContent = 'No email is associated with this session.';
            }
            return;
          }
          if (!lastTotpPassword) {
            if (totpErrorEl) {
              totpErrorEl.textContent = 'Enter your current password before confirming.';
            }
            return;
          }
          if (!code) {
            if (totpErrorEl) {
              totpErrorEl.textContent = 'Enter the code from your authenticator app.';
            }
            return;
          }
          if (totpErrorEl) {
            totpErrorEl.textContent = '';
          }
          apiPostJson('{{ url_for("auth.totp_verify") }}', {
            email: email,
            password: lastTotpPassword,
            code: code
          }).then(function (data) {
            if (data.error) {
              if (totpErrorEl) {
                totpErrorEl.textContent = 'Error: ' + data.error;
              }
              return;
            }
            if (totpModal) {
              totpModal.classList.remove('is-visible');
            }
            if (totpErrorEl) {
              totpErrorEl.textContent = '';
            }
            if (out) {
              setOutput(out, 'TOTP setup confirmed. Codes from your authenticator will now be accepted.');
            }
          }).catch(function (err) {
            if (totpErrorEl) {
              totpErrorEl.textContent = String(err);
            }
          });
        });
      }

      function bufferFromBase64Url(b64url) {
        var s = String(b64url || '');
        s = s.replace(/-/g, '+').replace(/_/g, '/');
        var pad = s.length % 4;
        if (pad) {
          s += '='.repeat(4 - pad);
        }
        var binary = atob(s);
        var bytes = new Uint8Array(binary.length);
        for (var i = 0; i < bytes.length; i++) {
          bytes[i] = binary.charCodeAt(i);
        }
        return bytes.buffer;
      }

      function base64UrlFromBuffer(buf) {
        var bytes = new Uint8Array(buf || []);
        var binary = '';
        for (var i = 0; i < bytes.length; i++) {
          binary += String.fromCharCode(bytes[i]);
        }
        return btoa(binary).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
      }

      function decodePublicKeyOptions(opts) {
        if (!opts) return opts;

        // Some servers return the publicKey options object directly instead of
        // wrapping it in { publicKey: ... }. Normalize that here.
        if (!opts.publicKey) {
          if (opts.public_key) {
            // python-fido2 CredentialCreationOptions serialized via vars():
            // { public_key: { rp, user, challenge, ... } }
            opts = { publicKey: opts.public_key };
          } else if (opts.challenge || opts.rp || opts.user) {
            // Bare PublicKeyCredentialCreationOptions dict.
            opts = { publicKey: opts };
          }
        }
        if (!opts.publicKey) return opts;

        var pk = opts.publicKey;
        if (pk.challenge) {
          pk.challenge = bufferFromBase64Url(pk.challenge);
        }
        if (pk.user) {
          if (pk.user.id) {
            pk.user.id = bufferFromBase64Url(pk.user.id);
          }
          // Normalize display_name (snake_case) to displayName as required by WebAuthn.
          if (!pk.user.displayName && pk.user.display_name) {
            pk.user.displayName = String(pk.user.display_name);
          }
          if (!pk.user.displayName && pk.user.name) {
            pk.user.displayName = String(pk.user.name);
          }
          if (pk.user.display_name) {
            delete pk.user.display_name;
          }
        }
        // Edge is very strict about the optional "hints" field and expects a
        // sequence. We don't rely on it, so remove it entirely to avoid type
        // errors.
        if (Object.prototype.hasOwnProperty.call(pk, 'hints')) {
          delete pk.hints;
        }
        // Normalize pub_key_cred_params (snake_case from backend) to
        // pubKeyCredParams as required by WebAuthn.
        if (!pk.pubKeyCredParams && Array.isArray(pk.pub_key_cred_params)) {
          pk.pubKeyCredParams = pk.pub_key_cred_params.map(function (param) {
            if (!param) return { type: 'public-key', alg: -7 };
            var t = param.type;
            // If python-fido2 enum or object, try to extract .value.
            if (t && typeof t === 'object' && typeof t.value === 'string') {
              t = t.value;
            }
            if (typeof t !== 'string') {
              t = 'public-key';
            }
            var alg = typeof param.alg === 'number' ? param.alg : -7;
            return { type: t, alg: alg };
          });
        }
        if (pk.pub_key_cred_params) {
          delete pk.pub_key_cred_params;
        }
        if (Array.isArray(pk.excludeCredentials)) {
          pk.excludeCredentials = pk.excludeCredentials.map(function (cred) {
            if (cred && cred.id) {
              cred.id = bufferFromBase64Url(cred.id);
            }
            return cred;
          });
        }
        return opts;
      }

      var pkBtn = document.getElementById('pk-register-btn');
      if (pkBtn) {
        pkBtn.addEventListener('click', function () {
          var out = document.getElementById('pk-output');
          if (!window.PublicKeyCredential) {
            if (!window.isSecureContext) {
              setOutput(
                out,
                'Passkeys require a secure context (HTTPS or localhost). Load this page over HTTPS to use passkeys.'
              );
            } else {
              setOutput(
                out,
                'Passkeys/WebAuthn are not available or are disabled in this browser.'
              );
            }
            return;
          }
          if (!email) {
            setOutput(out, 'No email is associated with this session.');
            return;
          }
          var pwInput = document.getElementById('security-password');
          var password = pwInput ? pwInput.value : '';
          if (!password) {
            setOutput(out, 'Enter your current password before registering a passkey.');
            return;
          }
          var nicknameInput = document.getElementById('pk-nickname');
          var nickname = nicknameInput ? nicknameInput.value.trim() : '';
          setOutput(out, 'Starting passkey registration‚Ä¶');
          apiPostJson('{{ url_for("auth.passkey_register_begin") }}', {
            email: email,
            password: password,
            nickname: nickname
          }).then(function (options) {
            if (options.error) {
              setOutput(out, 'Error: ' + options.error);
              return;
            }
            options = decodePublicKeyOptions(options);
            if (!options || !options.publicKey) {
              setOutput(out, { error: 'invalid passkey registration options', options: options });
              return;
            }
            return navigator.credentials.create(options).then(function (cred) {
              var rawIdB64 = base64UrlFromBuffer(cred.rawId);
              var att = {
                // Ensure id and rawId are identical base64url strings so the
                // backend/python-fido2 sees them as consistent.
                id: rawIdB64,
                rawId: rawIdB64,
                type: cred.type,
                response: {
                  clientDataJSON: base64UrlFromBuffer(cred.response.clientDataJSON),
                  attestationObject: base64UrlFromBuffer(cred.response.attestationObject)
                }
              };
              return apiPostJson('{{ url_for("auth.passkey_register_complete") }}', att);
            });
          }).then(function (data) {
            if (!data) return;
            if (data.error) {
              setOutput(out, 'Error: ' + data.error);
            } else {
              setOutput(out, data);
            }
          }).catch(function (err) {
            setOutput(out, String(err));
          });
        });
      }
    })();
  </script>
{% endblock %}
